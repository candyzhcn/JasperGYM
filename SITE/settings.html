<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è®¾ç½® Â· è®­ç»ƒæé†’</title>
<style>
  :root{
    --bg:#f1f5f9; --panel:#fff; --ink:#0f172a;
    --brand:#2563eb; --ok:#10b981; --danger:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .nav{position:sticky;top:0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--panel);border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.06);padding:18px;margin:14px 0}
  label{font-weight:800;display:block;margin-bottom:8px}
  input[type="text"],input[type="color"],input[type="number"],input[type="date"],select,textarea{width:100%;border:1px solid #cbd5e1;border-radius:12px;padding:12px 14px;box-sizing:border-box;background:#fff}
  textarea{min-height:140px;resize:vertical}
  .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .btn{border:0;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:700}
  .btn.brand{background:var(--brand);color:#fff}
  .btn.ok{background:var(--ok);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #cbd5e1;border-radius:999px;padding:6px 10px;background:#f8fafc;cursor:pointer}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px solid #e2e8f0;border-radius:12px;padding:12px;background:#fff}
</style>
</head>
<body>
<div class="nav">
  <div class="wrap row" style="justify-content:space-between;align-items:center">
    <div><strong>è®¾ç½®</strong></div>
    <div class="btns">
      <a class="pill" href="./index.html">â† è¿”å›</a>
    </div>
  </div>
</div>

<div class="wrap">

  <div class="card">
    <div class="row">
      <div class="col" style="flex:1 1 320px">
        <label>æ ‡é¢˜</label>
        <input id="title" type="text" placeholder="ä¾‹å¦‚ï¼šJasper è®­ç»ƒæé†’">
      </div>
      <div class="col" style="flex:0 0 220px">
        <label>ç‰ˆæœ¬å·</label>
        <input id="version" type="text" placeholder="v3.x">
      </div>
      <div class="col" style="flex:0 0 220px">
        <label>èƒŒæ™¯è‰²</label>
        <input id="bg" type="color" value="#91C6FF">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col" style="flex:0 0 220px">
        <label>ä¼‘æ¯é—´éš”ï¼ˆç§’ï¼‰</label>
        <input id="rest" type="number" min="5" step="5">
      </div>
      <div class="col" style="flex:0 0 220px">
        <label>å“é“ƒæ—¶é•¿ï¼ˆç§’ï¼‰</label>
        <input id="bell" type="number" min="1" step="1">
      </div>
      <div class="col" style="flex:1 1 320px;display:flex;align-items:flex-end">
        <button class="btn pill" id="btnTestBell">ğŸ”” è¯•æ”¾é“ƒå£°</button>
      </div>
    </div>
  </div>

  <div class="card">
    <label>ç®¡ç†éƒ¨ä½</label>
    <div class="row">
      <div class="col" style="flex:1 1 320px">
        <select id="partSelect"></select>
      </div>
      <div class="col" style="flex:1 1 320px">
        <input type="text" id="partNewName" placeholder="æ–°å¢æˆ–é‡å‘½åâ€¦">
      </div>
    </div>
    <div class="btns">
      <button class="btn ok" id="btnAddPart">â• æ–°å¢</button>
      <button class="btn brand" id="btnRenamePart">âœï¸ é‡å‘½åï¼ˆé€‰ä¸­â†’æ–°åï¼‰</button>
      <button class="btn danger" id="btnRemovePart">ğŸ—‘ï¸ åˆ é™¤ï¼ˆé€‰ä¸­ï¼‰</button>
    </div>
  </div>

  <div class="card">
    <label>è¯¥éƒ¨ä½çš„è§†é¢‘ç®¡ç†ï¼ˆä¸‹æ‹‰åˆ—è¡¨æ¥æºï¼‰</label>
    <div class="row">
      <div class="col" style="flex:1 1 320px">
        <select id="videoPart"></select>
      </div>
      <div class="col" style="flex:1 1 320px">
        <input id="videoTitle" type="text" placeholder="è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆå¯è¯»åç§°ï¼‰">
      </div>
      <div class="col" style="flex:1 1 320px">
        <input id="videoURL" type="text" placeholder="https://ï¼ˆYouTube/Bç«™/ç›´é“¾mp4ï¼‰">
      </div>
    </div>
    <div class="btns">
      <button class="btn ok" id="btnAddVideo">â• æ·»åŠ åˆ°è¯¥éƒ¨ä½</button>
    </div>
    <div class="list" id="videoList"></div>
  </div>

  <div class="card">
    <label>è¯¥éƒ¨ä½æç¤ºè¯­ï¼ˆå›ºå®šï¼›è®­ç»ƒé¡µè°ƒç”¨ï¼‰</label>
    <div class="row">
      <div class="col" style="flex:1 1 320px">
        <select id="tipPart"></select>
      </div>
    </div>
    <textarea id="taTips" placeholder="èƒ¸ï¼šè‚©èƒ›åç¼©ï¼Œæ§åˆ¶ç¦»å¿ƒ&#10;è…¿ï¼šæ ¸å¿ƒæ”¶ç´§ï¼Œè†ç›–ä¸è„šå°–æ–¹å‘ä¸€è‡´"></textarea>
    <div class="btns">
      <button class="btn ok" id="btnSaveTips">ğŸ’¾ ä¿å­˜è¯¥éƒ¨ä½æç¤ºè¯­</button>
    </div>
  </div>

  <div class="card">
    <label>èƒŒæ™¯éŸ³ä¹</label>
    <div class="row">
      <div class="col" style="flex:1 1 320px">
        <select id="musicSelect"></select>
      </div>
      <div class="col" style="flex:0 0 220px;display:flex;gap:8px;align-items:flex-end">
        <button class="btn pill" id="btnPlayMusic">â–¶ï¸ æ’­æ”¾</button>
        <button class="btn pill" id="btnPauseMusic">â¸ æš‚åœ</button>
      </div>
    </div>
    <div class="small">ä¼˜å…ˆè¯»å– <code>/music/list.json</code>ï¼Œæ²¡æœ‰åˆ™éœ€è‡ªè¡Œé€‰æ‹©æœ¬åœ°éŸ³ä¹ã€‚</div>
  </div>

  <div class="card">
    <label>å¯¼å…¥ / å¯¼å‡º</label>
    <div class="btns">
      <button class="btn ok" id="btnDump">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨è®¾ç½®ï¼ˆå«æ—¥å¿—/è®¡åˆ’/æç¤º/è§†é¢‘/éƒ¨ä½â€¦ï¼‰</button>
      <input type="file" id="fileImport" accept="application/json" style="display:none">
      <button class="btn brand" id="btnLoad">ğŸ“¥ å¯¼å…¥ JSON å¹¶è¦†ç›–</button>
    </div>
    <div class="btns">
      <button class="btn danger" id="btnClearAll">ğŸ§¹ æ¸…ç©ºæœ¬åœ°å…¨éƒ¨æ•°æ®</button>
    </div>
  </div>

  <div class="card">
    <button class="btn ok" style="width:100%;font-size:18px" id="btnSaveAll">ğŸ’¾ ä¿å­˜è®¾ç½®ï¼ˆå†™å…¥æœ¬åœ°ï¼‰</button>
  </div>

</div>

<script>
const LSKEY = 'jr_app_state_v3';
const $ = s=>document.querySelector(s);
const app = {
  parts: ['è…¿','èƒ¸','èƒŒ','è‚©','æ ¸å¿ƒ'],
  currentPart:'è…¿',
  lastByPart:{}, nextByPart:{}, tipsByPart:{},
  videosByPart:{},
  settings:{title:'è®­ç»ƒæé†’',version:'v3.x',bg:'#91C6FF',rest:60,bell:2},
  logs:[]
};
function load(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){ Object.assign(app, JSON.parse(raw)); }
  }catch(e){}
}
function save(){ localStorage.setItem(LSKEY, JSON.stringify(app)); }
function toast(m){ alert(m); }
load();

/* åŸºæœ¬è®¾ç½® */
$('#title').value = app.settings?.title || 'è®­ç»ƒæé†’';
$('#version').value = app.settings?.version || 'v3.x';
$('#bg').value = app.settings?.bg || '#91C6FF';
$('#rest').value = app.settings?.rest ?? 60;
$('#bell').value = app.settings?.bell ?? 2;

/* éƒ¨ä½ä¸‹æ‹‰ */
function rebuildPartSelect(){
  const ids=['partSelect','videoPart','tipPart'];
  ids.forEach(id=>{
    const sel = $('#'+id); sel.innerHTML = '';
    app.parts.forEach(p=>{
      const o=document.createElement('option');o.value=p;o.textContent=p;sel.appendChild(o);
    });
    sel.value = app.currentPart;
  });
  renderVideoList();
  $('#taTips').value = app.tipsByPart[$('#tipPart').value] || '';
}
rebuildPartSelect();

/* ç®¡ç†éƒ¨ä½ */
$('#btnAddPart').onclick = ()=>{
  const name = ($('#partNewName').value||'').trim();
  if(!name) return toast('è¯·è¾“å…¥åç§°');
  if(app.parts.includes(name)) return toast('å·²å­˜åœ¨');
  app.parts.push(name);
  app.currentPart = name;
  $('#partNewName').value = '';
  save(); rebuildPartSelect(); toast('å·²æ·»åŠ ');
};
$('#btnRenamePart').onclick = ()=>{
  const old = $('#partSelect').value;
  const name = ($('#partNewName').value||'').trim();
  if(!name) return toast('æ–°åç§°ä¸ºç©º');
  const i = app.parts.indexOf(old);
  if(i<0) return;
  app.parts[i]=name;
  // åŒæ­¥æ˜ å°„çš„é”®
  function renameKey(obj){
    if(obj[old]!==undefined){ obj[name]=obj[old]; delete obj[old];}
  }
  renameKey(app.lastByPart); renameKey(app.nextByPart); renameKey(app.tipsByPart); renameKey(app.videosByPart);
  if(app.currentPart===old) app.currentPart=name;
  $('#partNewName').value='';
  save(); rebuildPartSelect(); toast('å·²é‡å‘½å');
};
$('#btnRemovePart').onclick = ()=>{
  const p = $('#partSelect').value;
  if(!confirm('åˆ é™¤éƒ¨ä½ã€Œ'+p+'ã€åŠå…¶ç›¸å…³é…ç½®ï¼Ÿ')) return;
  app.parts = app.parts.filter(x=>x!==p);
  delete app.lastByPart[p]; delete app.nextByPart[p]; delete app.tipsByPart[p]; delete app.videosByPart[p];
  if(app.currentPart===p) app.currentPart = app.parts[0]||'';
  save(); rebuildPartSelect(); toast('å·²åˆ é™¤');
};
$('#tipPart').onchange = ()=>{ $('#taTips').value = app.tipsByPart[$('#tipPart').value] || ''; };
$('#btnSaveTips').onclick = ()=>{
  app.tipsByPart[$('#tipPart').value] = $('#taTips').value.trim();
  save(); toast('å·²ä¿å­˜è¯¥éƒ¨ä½æç¤ºè¯­');
};

/* è§†é¢‘ç®¡ç† */
function renderVideoList(){
  const box = $('#videoList'); box.innerHTML = '';
  const part = $('#videoPart').value;
  const list = app.videosByPart[part] || [];
  if(list.length===0){ box.innerHTML='<div class="small">è¯¥éƒ¨ä½æš‚æ— è§†é¢‘ã€‚</div>'; return; }
  list.forEach((v,i)=>{
    const it = document.createElement('div');
    it.className='item';
    it.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div><strong>${v.title||'(æ— æ ‡é¢˜)'}</strong><div class="small">${v.url}</div></div>
        <div class="btns">
          <button class="btn danger btn-del" data-i="${i}">åˆ é™¤</button>
        </div>
      </div>
    `;
    box.appendChild(it);
  });
  box.querySelectorAll('.btn-del').forEach(b=>{
    b.onclick = ()=>{
      const i=+b.dataset.i; const p=$('#videoPart').value;
      app.videosByPart[p].splice(i,1);
      save(); renderVideoList();
    };
  });
}
$('#videoPart').onchange = renderVideoList;
$('#btnAddVideo').onclick = ()=>{
  const p=$('#videoPart').value;
  const t=$('#videoTitle').value.trim();
  const u=$('#videoURL').value.trim();
  if(!u) return toast('è¯·è¾“å…¥é“¾æ¥');
  app.videosByPart[p] = app.videosByPart[p]||[];
  app.videosByPart[p].push({title:t||u,url:u});
  $('#videoTitle').value=''; $('#videoURL').value='';
  save(); renderVideoList(); toast('å·²æ·»åŠ ');
};

/* èƒŒæ™¯éŸ³ä¹(ç®€åŒ–)ï¼šå°è¯•è¯»å– /music/list.json */
const musicSel = $('#musicSelect');
let musicPlayer = new Audio();
async function loadMusicList(){
  try{
    const res = await fetch('/music/list.json',{cache:'no-store'});
    if(!res.ok) throw 0;
    const arr = await res.json();
    musicSel.innerHTML='';
    arr.forEach(n=>{
      const o=document.createElement('option'); o.value='/music/'+n; o.textContent=n; musicSel.appendChild(o);
    });
  }catch(e){
    musicSel.innerHTML = '<option>æœ¬åœ°æ— åˆ—è¡¨ï¼Œè¯·è‡ªè¡Œé€‰æ‹©æ–‡ä»¶</option>';
  }
}
loadMusicList();
$('#btnPlayMusic').onclick = ()=>{
  const v = musicSel.value;
  if(v && v.startsWith('/')){ musicPlayer.src=v; musicPlayer.loop=true; musicPlayer.play(); }
  else{ toast('æœªæ£€æµ‹åˆ° /music/list.jsonï¼Œè¯·ä¸Šä¼ æˆ–æ”¹ä¸ºæœ¬åœ°å®ç°'); }
};
$('#btnPauseMusic').onclick = ()=> musicPlayer.pause();

/* è¯•æ”¾é“ƒå£°ï¼ˆbell.mp3 æˆ–åˆæˆéŸ³ï¼‰ */
$('#btnTestBell').onclick = async ()=>{
  try{
    const a=new Audio('/bell.mp3'); a.play().catch(async()=>{
      // åˆæˆéŸ³å›é€€
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
      o.start(); setTimeout(()=>{o.stop();ctx.close();}, 1000);
    });
  }catch(e){}
};

/* å¯¼å‡º/å¯¼å…¥/ä¿å­˜å…¨éƒ¨è®¾ç½® */
$('#btnDump').onclick = ()=>{
  // æŠŠå½“å‰è¡¨å•å†™å…¥åº”ç”¨å¯¹è±¡
  app.settings.title = $('#title').value.trim() || 'è®­ç»ƒæé†’';
  app.settings.version = $('#version').value.trim() || 'v3.x';
  app.settings.bg = $('#bg').value || '#91C6FF';
  app.settings.rest = +$('#rest').value || 60;
  app.settings.bell = +$('#bell').value || 2;
  save();
  const blob = new Blob([localStorage.getItem(LSKEY)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='jr-settings-all.json'; a.click();
  URL.revokeObjectURL(url);
};
$('#btnLoad').onclick = ()=> $('#fileImport').click();
$('#fileImport').onchange = async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  try{
    JSON.parse(txt); // æ ¡éªŒ
    localStorage.setItem(LSKEY, txt);
    toast('å¯¼å…¥æˆåŠŸï¼šè¯·åˆ·æ–°é¡µé¢');
  }catch(err){ toast('JSON æ ¼å¼é”™è¯¯'); }
};
$('#btnClearAll').onclick = ()=>{
  if(!confirm('æ¸…ç©ºæœ¬åœ°å…¨éƒ¨æ•°æ®ï¼Ÿ')) return;
  localStorage.removeItem(LSKEY);
  toast('å·²æ¸…ç©ºã€‚åˆ·æ–°åç”Ÿæ•ˆã€‚');
};
$('#btnSaveAll').onclick = ()=>{
  app.settings.title = $('#title').value.trim() || 'è®­ç»ƒæé†’';
  app.settings.version = $('#version').value.trim() || 'v3.x';
  app.settings.bg = $('#bg').value || '#91C6FF';
  app.settings.rest = +$('#rest').value || 60;
  app.settings.bell = +$('#bell').value || 2;
  save();
  toast('å…¨éƒ¨è®¾ç½®å·²ä¿å­˜');
};
</script>
</body>
</html>
