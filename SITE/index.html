<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è®­ç»ƒæé†’</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#91C6FF;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#e2e8f0;
    --brand:#2563eb;
    --ok:#10b981;
    --danger:#ef4444;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
  .nav{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.65);backdrop-filter:saturate(180%) blur(8px);box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .nav .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .title{font-size:22px;font-weight:800}
  .tabs{display:flex;gap:8px}
  .tab{border:1px solid #cbd5e1;background:#e2e8f0;border-radius:12px;padding:10px 16px;cursor:pointer}
  .tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
  .card{background:var(--panel);border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.06);padding:18px;margin:14px 0}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 320px}
  label{font-weight:800;display:block;margin-bottom:8px}
  select,input[type="text"],input[type="date"]{width:100%;box-sizing:border-box;border:1px solid #cbd5e1;border-radius:12px;padding:12px 14px;background:#fff}
  textarea{width:100%;min-height:180px;resize:vertical;border:1px solid #cbd5e1;border-radius:14px;padding:12px 14px;box-sizing:border-box;background:#fff}
  .btns{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .btn{border:0;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:700}
  .btn.brand{background:var(--brand);color:#fff}
  .btn.ok{background:var(--ok);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.muted{background:#e5e7eb}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px solid #e2e8f0;border-radius:12px;padding:12px;background:#fff}
  .item .hdr{display:flex;align-items:center;gap:8px;justify-content:space-between}
  details summary{cursor:pointer;list-style:none}
  details summary::-webkit-details-marker{display:none}
  .small{opacity:.7}
  .toolbar{display:flex;gap:8px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #cbd5e1;border-radius:999px;padding:6px 10px;background:#f8fafc;cursor:pointer}
</style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆª -->
<div class="nav">
  <div class="wrap row">
    <div class="title" id="appTitle">è®­ç»ƒæé†’</div>
    <div class="tabs">
      <div class="tab active" data-view="train">ğŸ  é¦–é¡µ</div>
      <div class="tab" data-view="logs">ğŸ§± æ—¥å¿—</div>
      <a class="tab" href="./settings.html">âš™ï¸ è®¾ç½®</a>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- è®­ç»ƒè§†å›¾ -->
  <section id="view-train">
    <div class="card">
      <div class="row">
        <div class="col" style="max-width:360px">
          <label>è®­ç»ƒéƒ¨ä½</label>
          <select id="partSelect"></select>
          <div class="btns" style="margin-top:10px">
            <button class="btn muted" id="btnAddPart">â• è‡ªå®šä¹‰éƒ¨ä½â€¦</button>
            <button class="btn pill" id="btnRandomTip">ğŸ¯ å¼¹å‡ºè¯¥éƒ¨ä½æç¤ºè¯­</button>
          </div>
        </div>
        <div class="col">
          <label>å¯é€‰è§†é¢‘ï¼ˆæ¥è‡ªè®¾ç½®é¡µï¼‰</label>
          <select id="videoSelect"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <label>æœ¬æ¬¡è®­ç»ƒå†…å®¹ï¼ˆå¯ç¼–è¾‘ï¼Œæ‰‹åŠ¨ä¿å­˜ï¼‰</label>
      <textarea id="taThis" placeholder="åœ¨æ­¤ç²˜è´´æˆ–ç¼–å†™ä»Šå¤©è¦åšçš„åŠ¨ä½œã€ç»„æ¬¡ã€é‡é‡ç­‰â€¦"></textarea>
      <div class="btns">
        <button class="btn ok" id="btnSaveAsLast">âœ… æœ¬æ¬¡å®Œæˆï¼Œä¿å­˜ä¸ºâ€œä¸Šæ¬¡â€</button>
        <button class="btn muted" id="btnCopyLast">â†©ï¸ ç”¨â€œä¸Šæ¬¡â€å¤åˆ¶åˆ°â€œæœ¬æ¬¡â€</button>
        <button class="btn brand" id="btnWriteLog">ğŸ“ å†™å…¥æ—¥å¿—ï¼ˆå–ç¬¬ä¸€è¡Œåšæ ‡é¢˜ï¼‰</button>
      </div>
    </div>

    <div class="card">
      <label>ä¸Šæ¬¡è®­ç»ƒè®°å½•ï¼ˆåªè¯»ï¼‰</label>
      <textarea id="taLast" readonly placeholder="è¯¥éƒ¨ä½ä¸Šæ¬¡è®­ç»ƒçš„å†…å®¹æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œä¾¿äºå¯¹ç…§ã€‚"></textarea>
      <div class="btns">
        <button class="btn danger" id="btnClearLast">ğŸ—‘ï¸ æ¸…é™¤ä¸Šæ¬¡</button>
      </div>
    </div>

    <div class="card">
      <label>ä¸‹æ¬¡è®­ç»ƒå±•æœ›ï¼ˆå¯ç¼–è¾‘ï¼Œæ‰‹åŠ¨ä¿å­˜ï¼‰</label>
      <textarea id="taNext" placeholder="ä¸‹æ¬¡è¦åšçš„è®¡åˆ’/åŠ é‡/åŠ¨ä½œè°ƒæ•´ç­‰â€¦"></textarea>
      <div class="btns">
        <button class="btn ok" id="btnSaveNext">ğŸ’¾ ä¿å­˜å±•æœ›</button>
      </div>
    </div>

    <div class="card">
      <label>è¯¥éƒ¨ä½æç¤ºè¯­ï¼ˆå›ºå®šï¼Œè·Ÿéšéƒ¨ä½ä¿å­˜/è¯»å–ï¼‰</label>
      <textarea id="taTips" placeholder="èƒ¸ï¼šè‚©èƒ›åç¼©ï¼Œæ§åˆ¶ç¦»å¿ƒ&#10;è…¿ï¼šæ ¸å¿ƒæ”¶ç´§ï¼Œè†ç›–ä¸è„šå°–æ–¹å‘ä¸€è‡´&#10;â€¦"></textarea>
      <div class="btns">
        <button class="btn ok" id="btnSaveTips">ğŸ’¾ ä¿å­˜æç¤ºè¯­ï¼ˆæ­¤éƒ¨ä½ï¼‰</button>
      </div>
    </div>

  </section>

  <!-- æ—¥å¿—è§†å›¾ -->
  <section id="view-logs" style="display:none">
    <div class="card">
      <label>æ–°å¢æ—¥å¿—ï¼ˆå®Œæ•´å†…å®¹ï¼›ä¿å­˜æ—¶è‡ªåŠ¨å–ç¬¬ä¸€è¡Œä½œä¸ºæ ‡é¢˜ï¼‰</label>
      <textarea id="taNewLog" placeholder="ç¤ºä¾‹ï¼š&#10;9/23 è…¿è‡€å®¹é‡/æ³µæ„Ÿæ—¥æ€»ç»“&#10;&#10;æ—¶é—´ï¼š17:00â€“18:05ï¼ˆâ‰ˆ65åˆ†é’Ÿï¼‰&#10;â€¦"></textarea>
      <div class="row">
        <div class="col">
          <label>æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰</label>
          <input type="date" id="logDate">
        </div>
        <div class="col">
          <label>ï¼ˆå¯é€‰ï¼‰ç›´æ¥æŒ‡å®šæ ‡é¢˜ï¼ˆå¦åˆ™è‡ªåŠ¨å–ç¬¬ä¸€è¡Œï¼‰</label>
          <input type="text" id="logTitle" placeholder="ä¸å¡«åˆ™ç”¨ç¬¬ä¸€è¡Œä½œä¸ºæ ‡é¢˜">
        </div>
      </div>
      <div class="btns">
        <button class="btn ok" id="btnAddLog">ğŸ’¾ ä¿å­˜æ—¥å¿—</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div class="col"><label>æ—¥å¿—åˆ—è¡¨ï¼ˆæ­£åºï¼šæ—§ â†’ æ–°ï¼‰</label></div>
        <div class="col" style="max-width:320px;text-align:right">
          <button class="btn pill" id="btnToggleSort">â†•ï¸ åˆ‡æ¢æ’åºæ¨¡å¼ï¼š<span id="sortModeLabel">æŸ¥çœ‹</span></button>
        </div>
      </div>
      <div class="list" id="logList"></div>
    </div>
  </section>
</div>

<script>
/* ---------------- App State ---------------- */
const LSKEY = 'jr_app_state_v3';
const nowDate = ()=> new Date().toISOString().slice(0,10);
const $ = s=>document.querySelector(s);
const app = {
  parts: ['è…¿','èƒ¸','èƒŒ','è‚©','æ ¸å¿ƒ'],
  currentPart: 'è…¿',
  lastByPart: {},            // { éƒ¨ä½: 'ä¸Šæ¬¡æ–‡æœ¬' }
  nextByPart: {},            // { éƒ¨ä½: 'ä¸‹æ¬¡å±•æœ›' }
  tipsByPart: {},            // { éƒ¨ä½: 'æç¤ºè¯­æ–‡æœ¬' }
  videosByPart: {},          // { éƒ¨ä½:[{title,url}] } ç”±è®¾ç½®é¡µå†™å…¥
  settings: { title:'è®­ç»ƒæé†’', version:'v3.x', bg:'#91C6FF', rest:60, bell:2 },
  logs: [],                  // [{id,date,title,content}]
};

/* -------------- Load & Save --------------- */
function load(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){
      const s = JSON.parse(raw);
      Object.assign(app, s);
    }
  }catch(e){}
}
function save(){ localStorage.setItem(LSKEY, JSON.stringify(app)); }

/* -------------- UI helpers ---------------- */
function setNavActive(view){
  document.querySelectorAll('.tab[data-view]').forEach(t=>{
    t.classList.toggle('active', t.dataset.view === view);
  });
  $('#view-train').style.display = view==='train'?'':'none';
  $('#view-logs').style.display  = view==='logs' ?'':'none';
}

function toast(msg){
  alert(msg);
}

/* -------------- Build Part Select ---------- */
function rebuildPartSelect(){
  const sel = $('#partSelect');
  sel.innerHTML = '';
  app.parts.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    sel.appendChild(opt);
  });
  sel.value = app.currentPart;
  // æ„å»ºè§†é¢‘ä¸‹æ‹‰
  rebuildVideoSelect();
  // è½½å…¥å¯¹åº”æ•°æ®
  fillForPart(app.currentPart);
}
function rebuildVideoSelect(){
  const sel = $('#videoSelect');
  sel.innerHTML = '';
  const list = app.videosByPart[app.currentPart] || [];
  if(list.length===0){
    const o = document.createElement('option');
    o.textContent = 'è¯¥éƒ¨ä½æš‚æ— è§†é¢‘ï¼ˆåˆ°è®¾ç½®é¡µæ·»åŠ ï¼‰';
    sel.appendChild(o);
    return;
  }
  list.forEach(v=>{
    const o = document.createElement('option');
    o.value = v.url; o.textContent = v.title||v.url;
    sel.appendChild(o);
  });
}

/* --------------- Fill for Part ------------- */
function fillForPart(part){
  $('#taLast').value = app.lastByPart[part] || '';
  $('#taNext').value = app.nextByPart[part] || '';
  $('#taTips').value = app.tipsByPart[part] || '';
}

/* --------------- Logs render --------------- */
let sortMode = 'view'; // view or sort
function renderLogs(){
  $('#sortModeLabel').textContent = sortMode==='view'?'æŸ¥çœ‹':'æ’åº';
  const box = $('#logList');
  box.innerHTML = '';

  // æ­£åºï¼ˆæ—§åˆ°æ–°ï¼‰
  const items = [...app.logs].sort((a,b)=> a.date.localeCompare(b.date));

  items.forEach((log,idx)=>{
    const it = document.createElement('div');
    it.className = 'item';
    it.draggable = (sortMode==='sort');
    it.dataset.id = log.id;

    const hdr = document.createElement('div');
    hdr.className = 'hdr';
    hdr.innerHTML = `
      <div><strong>${log.date}</strong> Â· ${log.title||'(æ— æ ‡é¢˜)'}</div>
      <div class="toolbar">
        <button class="pill btnDel" data-id="${log.id}">ğŸ—‘ï¸ åˆ é™¤</button>
      </div>
    `;
    it.appendChild(hdr);

    const det = document.createElement('details');
    const sum = document.createElement('summary');
    sum.textContent = 'å±•å¼€/æ”¶èµ·';
    det.appendChild(sum);
    const pre = document.createElement('pre');
    pre.style.whiteSpace='pre-wrap';
    pre.textContent = log.content;
    det.appendChild(pre);
    it.appendChild(det);

    box.appendChild(it);
  });

  // åˆ é™¤
  box.querySelectorAll('.btnDel').forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.id;
      app.logs = app.logs.filter(x=>x.id!==id);
      save(); renderLogs();
    };
  });

  if(sortMode==='sort'){
    // ç®€æ˜“æ‹–æ‹½æ’åºï¼ˆæ­£åºåˆ—è¡¨é‡Œæ‹–åŠ¨åï¼Œé‡æ–°å†™å› logs åºåˆ—åŒ–é¡ºåºï¼‰
    box.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('id', el.dataset.id);
      });
      el.addEventListener('dragover', e=> e.preventDefault());
      el.addEventListener('drop', e=>{
        e.preventDefault();
        const from = e.dataTransfer.getData('id');
        const to   = el.dataset.id;
        if(from===to) return;
        // ä»¥æ­£åºæ•°ç»„ä¸ºåŸºå‡†è°ƒæ•´é¡ºåº
        const arr = [...app.logs].sort((a,b)=> a.date.localeCompare(b.date));
        const fi = arr.findIndex(x=>x.id===from);
        const ti = arr.findIndex(x=>x.id===to);
        const [m] = arr.splice(fi,1);
        arr.splice(ti,0,m);
        // è¦†ç›– logs
        app.logs = arr;
        save(); renderLogs();
      });
    });
  }
}

/* --------------- Actions ------------------- */
function addPart(){
  const name = prompt('è¾“å…¥æ–°çš„éƒ¨ä½åï¼š');
  if(!name) return;
  if(app.parts.includes(name)){ toast('å·²å­˜åœ¨');return; }
  app.parts.push(name);
  app.currentPart = name;
  save(); rebuildPartSelect();
}

function saveAsLast(){
  const t = $('#taThis').value.trim();
  if(!t){ toast('æœ¬æ¬¡å†…å®¹ä¸ºç©º'); return; }
  app.lastByPart[app.currentPart] = t;
  save(); fillForPart(app.currentPart);
  toast('å·²ä¿å­˜ä¸ºã€Œä¸Šæ¬¡ã€ã€‚');
}

function copyLast(){
  $('#taThis').value = app.lastByPart[app.currentPart] || '';
  $('#taThis').focus();
}

function clearLast(){
  if(!confirm('ç¡®è®¤æ¸…é™¤æ­¤éƒ¨ä½çš„ä¸Šæ¬¡è®°å½•ï¼Ÿ')) return;
  delete app.lastByPart[app.currentPart];
  save(); fillForPart(app.currentPart);
}

function saveNext(){
  app.nextByPart[app.currentPart] = $('#taNext').value.trim();
  save(); toast('å·²ä¿å­˜ä¸‹æ¬¡å±•æœ›ã€‚');
}
function saveTips(){
  app.tipsByPart[app.currentPart] = $('#taTips').value.trim();
  save(); toast('å·²ä¿å­˜è¯¥éƒ¨ä½æç¤ºè¯­ã€‚');
}

function writeLogFromThis(){
  const content = $('#taThis').value.trim();
  if(!content){ toast('æœ¬æ¬¡å†…å®¹ä¸ºç©º'); return; }
  const firstLine = content.split(/\r?\n/)[0] || '(æ— æ ‡é¢˜)';
  const date = nowDate();
  app.logs.push({id:crypto.randomUUID(), date, title:firstLine, content});
  save(); renderLogs();
  toast('å·²å†™å…¥æ—¥å¿—ã€‚');
}

/* --------------- Logs add ------------------ */
function addLog(){
  let content = $('#taNewLog').value.trim();
  if(!content){ toast('å†…å®¹ä¸ºç©º'); return; }
  let title = $('#logTitle').value.trim();
  if(!title){
    title = (content.split(/\r?\n/)[0]||'(æ— æ ‡é¢˜)').trim();
  }
  const date = $('#logDate').value || nowDate();
  app.logs.push({id:crypto.randomUUID(), date, title, content});
  save(); $('#taNewLog').value=''; $('#logTitle').value=''; $('#logDate').value=nowDate(); renderLogs();
}

function toggleSort(){
  sortMode = (sortMode==='view')?'sort':'view';
  renderLogs();
}

/* --------------- Tips popup --------------- */
function popupTip(){
  const tips = (app.tipsByPart[app.currentPart]||'').split(/\r?\n/).filter(Boolean);
  if(tips.length===0){ toast('è¯¥éƒ¨ä½æš‚æ— æç¤ºè¯­ï¼ˆåœ¨è®­ç»ƒé¡µåº•éƒ¨ä¿å­˜ï¼‰'); return; }
  // æŒ‰é¡ºåºè½®æ’­ï¼ˆééšæœºï¼‰ï¼šå–ç¬¬ä¸€æ¡å¹¶æ—‹è½¬
  const next = tips.shift();
  tips.push(next);
  app.tipsByPart[app.currentPart] = tips.join('\n');
  save();
  alert('æç¤ºï¼š\n' + next);
}

/* --------------- Boot ---------------------- */
load();
document.body.style.background = app.settings?.bg || '#91C6FF';
$('#appTitle').textContent = `${app.settings?.title||'è®­ç»ƒæé†’'} ${app.settings?.version||''}`;

document.querySelectorAll('.tab[data-view]').forEach(t=>{
  t.onclick = ()=>{
    setNavActive(t.dataset.view);
  }
});

$('#btnAddPart').onclick = addPart;
$('#btnSaveAsLast').onclick = saveAsLast;
$('#btnCopyLast').onclick = copyLast;
$('#btnClearLast').onclick = clearLast;
$('#btnSaveNext').onclick = saveNext;
$('#btnSaveTips').onclick = saveTips;
$('#btnWriteLog').onclick = writeLogFromThis;

$('#btnAddLog').onclick = addLog;
$('#btnToggleSort').onclick = toggleSort;
$('#btnRandomTip').onclick = popupTip;

$('#partSelect').onchange = e=>{
  app.currentPart = e.target.value;
  save(); rebuildVideoSelect(); fillForPart(app.currentPart);
};

$('#logDate').value = nowDate();
rebuildPartSelect();
renderLogs();

/* è¯»å–è®¾ç½®é¡µå†™å…¥çš„è§†é¢‘ */
window.addEventListener('storage', (e)=>{
  if(e.key===LSKEY){
    load();
    rebuildPartSelect();
    renderLogs();
  }
});
</script>
</body>
</html>
