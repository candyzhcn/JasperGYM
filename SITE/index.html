<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#91C6FF"/>
<title>训练提醒 · 全量版</title>
<style>
:root{
  --bg:#91C6FF; --panel:#ffffff; --ink:#111; --muted:#5b616a;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --border:#d1d5db; --field:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
a{color:var(--brand);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
.header{position:static;top:0;z-index:10;background:linear-gradient(#91C6FF,#91C6FFcc 80%,transparent);padding:8px 0 6px}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 10px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type="text"],input[type="number"],input[type="color"],textarea{
  width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none
}
textarea{min-height:160px;resize:vertical}
.bigtext{min-height:560px;max-height:860px;overflow:auto}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff;background:#334155}
.btn.light{background:transparent;border:1px solid var(--border);color:#111}
.btn.danger{background:var(--danger);color:#fff}
.btn.xs{padding:6px 10px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.muted{color:var(--muted)} .tiny{font-size:12px}
.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;
  padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}
.grid2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}

/* 首页选择 */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
.choice input{transform:scale(1.2)}

/* 训练页分页 */
.subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 2px}
.subtab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 12px;cursor:pointer}
.subtab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

/* 视频 */
.embed{width:100%;min-height:520px;aspect-ratio:16/9;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#000}
iframe{width:100%;height:100%;border:0}

/* 视频管理列表 */
.vm-row{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:10px;padding:10px;background:#f8fafc;margin-bottom:8px}
.vm-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}
.timer{font-size:40px;font-weight:800;letter-spacing:1px}

/* 日志列表 */
.log-item{padding:10px 8px;border-bottom:1px solid var(--border);border-radius:8px}
.log-item:hover{background:#f8fafc}
.log-title{font-weight:600}
.log-content{margin-top:6px;white-space:pre-wrap}
.log-tools{display:flex;gap:6px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <!-- 顶部 -->
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">训练提醒 v3.14</div>
      <div class="tabs">
        <div class="tab active" data-page="home">🏠 首页</div>
        <div class="tab" data-page="work">🏋️ 训练</div>
        <div class="tab" data-page="logs">📓 日志</div>
        <div class="tab" data-page="settings">⚙️ 设置</div>
      </div>
    </div>
  </div>

  <!-- 首页 -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">今天训练什么？</div>
      <div class="choices">
        <label class="choice"><input type="radio" name="part" value="legs">腿</label>
        <label class="choice"><input type="radio" name="part" value="chest">胸</label>
        <label class="choice"><input type="radio" name="part" value="back">背</label>
        <label class="choice"><input type="radio" name="part" value="shoulders">肩</label>
        <label class="choice"><input type="radio" name="part" value="core">核心</label>
        <label class="choice"><input type="radio" name="part" value="custom">自定义</label>
      </div>
      <div class="row auto" style="margin-top:12px">
        <div class="field"><label>自定义部位名称</label><input id="customName" type="text" placeholder="如：全身循环/技术练习"></div>
        <button class="btn brand" id="btnStart">进入训练页</button>
      </div>
    </div>
  </div>

  <!-- 训练页 -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle"><span id="workTitle">训练</span> · 控制台</div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted tiny">倒计时（休息间隔在设置页统一配置）</div>
          <div class="timer"><span id="count">60</span>s</div>
        </div>
        <div class="row auto" style="max-width:420px">
          <button class="btn brand" id="start">▶️ 开始</button>
          <button class="btn danger" id="stop">⏹ 停止</button>
          <button class="btn light" id="ping">🔔 试铃</button>
        </div>
      </div>
    </div>

    <div class="subtabs">
      <div class="subtab active" data-sub="last">① 上次记录</div>
      <div class="subtab" data-sub="now">② 本次计划</div>
      <div class="subtab" data-sub="video">③ 视频参考</div>
      <div class="subtab" data-sub="next">④ 下次展望</div>
    </div>

    <!-- 上次 -->
    <div id="sub-last">
      <div class="card">
        <div class="sectionTitle">上次训练计划 & 感受（只读）</div>
        <textarea id="planLast" class="bigtext" readonly></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn light" id="copyToNow">⬅️ 复制为本次计划</button>
          <button class="btn warn" id="clearLast">🧹 清空上次</button>
        </div>
      </div>
    </div>

    <!-- 本次 -->
    <div id="sub-now" class="hide">
      <div class="card">
        <div class="sectionTitle">本次训练预计计划 & 重量建议</div>
        <textarea id="planNow" class="bigtext" placeholder="把今天完整总结写在这里（第一行=标题，下面=详细内容）"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNow">💾 保存本次</button>
          <button class="btn brand" id="saveToLast">✅ 本次完成 → 存为“上次”（并追加到日志）</button>
        </div>
      </div>
      <div class="card">
        <div class="sectionTitle">动作注意事项（按部位保存）</div>
        <textarea id="notes" class="bigtext" placeholder="上斜卧推：肩胛后缩下沉；落点锁骨下2横指；下放2秒、推起1秒…"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNotes">💾 保存注意事项</button>
        </div>
      </div>
    </div>

    <!-- 视频 -->
    <div id="sub-video" class="hide">
      <div class="card">
        <div class="sectionTitle">选择一个已保存的视频进行参考</div>
        <div class="row auto">
          <div class="field"><label>视频列表（在设置页管理）</label><select id="videoSelect"></select></div>
          <button class="btn ok" id="playSelected">▶️ 播放</button>
          <button class="btn light" id="openSelected">🔗 新窗口打开</button>
        </div>
      </div>
      <div class="card">
        <div class="sectionTitle">播放区（可全屏）</div>
        <div class="embed" id="embedBox"><div class="muted tiny" style="padding:10px">未选择视频</div></div>
        <div class="row auto" style="margin-top:8px">
          <button class="btn light" id="enterFs">⛶ 全屏</button>
        </div>
      </div>
    </div>

    <!-- 下次 -->
    <div id="sub-next" class="hide">
      <div class="card">
        <div class="sectionTitle">下一次训练日的展望计划</div>
        <textarea id="planNext" class="bigtext"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNext">💾 保存</button>
          <button class="btn warn" id="clearNext">🧹 清空</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 日志页 -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">训练日志（默认隐藏排序按钮；长按可删除；开启“排序模式”后可上下移动/删除）</div>
      <div id="logList"></div>
      <div class="row auto" style="margin-top:10px">
        <button class="btn ok" id="toggleAddLog">➕ 添加日志</button>
        <button class="btn ghost" id="toggleSort">🧭 排序模式：关</button>
      </div>
    </div>
    <div class="card hide" id="addLogBox">
      <div class="sectionTitle">粘贴整段日志（第一行=标题；下面=内容）</div>
      <textarea id="addLogText" class="bigtext" placeholder="📝 2025-09-23 腿臀容量/泵感日总结&#10;&#10;时间：...&#10;..."></textarea>
      <div class="row auto" style="margin-top:8px">
        <button class="btn ok" id="addLogSave">保存到日志</button>
        <button class="btn light" id="addLogCancel">取消</button>
      </div>
    </div>
  </div>

  <!-- 设置页 -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle">外观 / 标识</div>
      <div class="row auto">
        <div class="field"><label>自定义标题</label><input id="titleInput" type="text" placeholder="如：Jasper 训练计划"></div>
        <div class="field"><label>自定义版本号</label><input id="verInput" type="text" placeholder="如：v3.14"></div>
        <div class="field"><label>背景颜色</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand">💾 保存标题/版本/背景</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">计时 / 铃声</div>
      <div class="row auto">
        <div class="field"><label>休息间隔（秒）</label><input id="setInterval" type="number" min="10" step="5"></div>
        <div class="field"><label>响铃时长（秒）</label><input id="setBeepLen" type="number" min="1" max="10"></div>
        <button class="btn light" id="testBell">🔔 试放铃声</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">铃声优先使用 /bell.mp3 或 /bell.mp4，缺失时用合成哔声。</div>
    </div>

    <div class="card">
      <div class="sectionTitle">背景音乐</div>
      <div class="row auto">
        <div class="field">
          <label>音乐列表（优先读取 /music/list.json，没有就从本地文件夹选择）</label>
          <select id="musicSelect"></select>
          <div class="tiny muted" id="musicHint">正在尝试读取 /music/list.json …</div>
        </div>
        <div class="field">
          <label>操作</label>
          <div class="row auto">
            <button class="btn ok" id="bgmPlay">▶️ 播放</button>
            <button class="btn danger" id="bgmPause">⏸ 暂停</button>
            <button class="btn light" id="readFolder">📂 从本地文件夹读取</button>
          </div>
        </div>
      </div>
      <video id="bgmMedia" preload="auto" loop style="display:none"></video>
    </div>

    <div class="card">
      <div class="sectionTitle">视频管理（按部位保存）</div>
      <div class="row auto">
        <div class="field">
          <label>部位</label>
          <select id="vmPart">
            <option value="legs">腿</option><option value="chest">胸</option>
            <option value="back">背</option><option value="shoulders">肩</option>
            <option value="core">核心</option><option value="custom">自定义</option>
          </select>
        </div>
        <div class="field"><label>视频链接</label><input id="vmUrl" type="text" placeholder="https://（YouTube/B站）"></div>
        <div class="field"><label>自定义标题</label><input id="vmName" type="text" placeholder="如：倒蹬机教程 / 深蹲要点"></div>
        <button class="btn ok" id="vmAdd">添加到该部位</button>
      </div>
      <div style="margin-top:10px" id="vmList"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">数据管理（导入 / 导出 全部设置与日志）</div>
      <div class="row auto">
        <button class="btn ok" id="exportAll">📤 导出全部数据</button>
        <input type="file" id="importFile" class="hide" accept=".json"/>
        <button class="btn warn" id="importAll">📥 导入数据（覆盖本地）</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">
        导出包含：外观设置、计时设置、各部位“本次/上次/注意事项/下次”、已保存视频、音乐列表（文件名/URL）、训练日志。
      </div>
    </div>
  </div>
</div>

<audio id="beepAudio" preload="auto"></audio>
<div id="toast" class="toast"></div>

<script>
(()=>{
// ===== 工具 & 本地存储 =====
const $=id=>document.getElementById(id);
const show=id=>$(id).classList.remove('hide');
const hide=id=>$(id).classList.add('hide');
const toast=m=>{const t=$("toast");t.textContent=m;t.style.opacity=0;t.style.display='block';requestAnimationFrame(()=>t.style.opacity=1);setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.style.display='none',200)},1600)}
const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const K={brand:'pg_brand_v3',prefs:'pg_prefs_v3',plansNow:'pg_now_v3',plansLast:'pg_last_v3',notes:'pg_notes_v3',planNext:'pg_next_v3',videos:'pg_videos_v3',music:'pg_music_v3',logs:'pg_logs_v3'};

// ===== 状态 =====
let brand=load(K.brand,{title:'训练提醒',ver:'v3.14',bg:'#91C6FF'});
let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs',customName:'',showTips:false});
let plansNow=load(K.plansNow,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let plansLast=load(K.plansLast,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let notes=load(K.notes,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let planNext=load(K.planNext,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let videos=load(K.videos,{legs:[],chest:[],back:[],shoulders:[],core:[],custom:[]});
let musicList=load(K.music,[]);
let logs=load(K.logs,[]); // [{id,date,title,content}] 顺序=当前数组顺序
if(Array.isArray(logs)){ // 兼容旧版本：补 id
  logs=logs.map(it=>it.id?it:{...it,id:Date.now()+Math.random()});
  save(K.logs,logs);
}

// ===== 顶部导航 =====
function setActive(page){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.page===page));
  ['page-home','page-work','page-logs','page-settings'].forEach(id=>hide(id));
  show(`page-${page}`);
  if(page==='logs') renderLogs();
  if(page==='settings') { renderVmList(); renderMusic(); }
}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>setActive(t.dataset.page));

// ===== 外观初始化 =====
document.body.style.backgroundColor=brand.bg;
$("appTitle").textContent=`${brand.title} ${brand.ver}`;
$("titleInput").value=brand.title; $("verInput").value=brand.ver; $("bgColor").value=brand.bg;

// ===== 首页选择 =====
document.querySelectorAll('input[name="part"]').forEach(r=>{
  r.checked=(r.value===prefs.part);
  r.onchange=()=>{prefs.part=r.value;save(K.prefs,prefs);refreshVideoSelect();updateWorkTitle();}
});
$("customName").value=prefs.customName; $("customName").oninput=()=>{prefs.customName=$("customName").value.trim();save(K.prefs,prefs);};
$("btnStart").onclick=()=>{setActive('work');loadPartState();updateWorkTitle();};

// ===== 训练页子分页 =====
function setSub(s){document.querySelectorAll('.subtab').forEach(x=>x.classList.toggle('active',x.dataset.sub===s)); ['sub-last','sub-now','sub-video','sub-next'].forEach(id=>hide(id)); show(`sub-${s}`);}
document.querySelectorAll('.subtab').forEach(s=>s.onclick=()=>setSub(s.dataset.sub));
function currPartName(){return prefs.part==='custom'?(prefs.customName||'自定义'):{legs:'腿',chest:'胸',back:'背',shoulders:'肩',core:'核心'}[prefs.part]}
function updateWorkTitle(){ $("workTitle").textContent=currPartName(); }
function loadPartState(){
  $("planNow").value=plansNow[prefs.part]||''; $("planLast").value=plansLast[prefs.part]||''; $("planNext").value=planNext[prefs.part]||''; $("notes").value=notes[prefs.part]||'';
  refreshVideoSelect();
}

// 保存计划与注意事项
$("saveNow").onclick=()=>{plansNow[prefs.part]=$("planNow").value.trim(); save(K.plansNow,plansNow); toast('已保存本次');};
$("saveToLast").onclick=()=>{
  const full=$("planNow").value.trim();
  plansLast[prefs.part]=full; save(K.plansLast,plansLast); $("planLast").value=full;

  // ★ 追加到日志（不覆盖）
  if(full){ appendLogFromText(full); renderLogs(); toast('已保存为上次，并追加到日志'); }
  else { toast('已保存为上次'); }
};
$("copyToNow").onclick=()=>{$("planNow").value=$("planLast").value; $("saveNow").click();};
$("clearLast").onclick=()=>{if(!confirm('清空上次记录？'))return; plansLast[prefs.part]=''; save(K.plansLast,plansLast); $("planLast").value='';};
$("saveNotes").onclick=()=>{notes[prefs.part]=$("notes").value.trim(); save(K.notes,notes); toast('已保存注意事项');};
$("saveNext").onclick=()=>{planNext[prefs.part]=$("planNext").value.trim(); save(K.planNext,planNext); toast('已保存');};
$("clearNext").onclick=()=>{if(!confirm('清空下一次展望？'))return; planNext[prefs.part]=''; save(K.planNext,planNext); $("planNext").value='';};

// ===== 计时与铃声 =====
$("count").textContent=prefs.interval;
const beep=$("beepAudio");
(async()=>{try{const r=await fetch('bell.mp3',{method:'HEAD'}); if(r.ok){beep.src='bell.mp3';return;}}catch{} try{const r2=await fetch('bell.mp4',{method:'HEAD'}); if(r2.ok){beep.src='bell.mp4';}}catch{} })();
let audioCtx=null; function ensureCtx(){ if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC();}}
function synthBeep(sec){try{ensureCtx(); if(!audioCtx) return; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine';o.frequency.value=880;o.connect(g);g.connect(audioCtx.destination); g.gain.value=.25;o.start();setTimeout(()=>o.stop(),(sec||2)*1000);}catch{}}
['click','touchstart'].forEach(e=>document.addEventListener(e,()=>{try{ensureCtx(); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); beep.play().then(()=>beep.pause()).catch(()=>{});}catch{}},{once:true}));
function ring(){ if(beep.src){ try{beep.currentTime=0; beep.play().catch(()=>{});}catch{ synthBeep(prefs.beepLen);} } else synthBeep(prefs.beepLen); }
let timer=null,endAt=0;
function schedule(){endAt=Date.now()+prefs.interval*1000;}
function updateTimer(){const remain=Math.max(0,Math.ceil((endAt-Date.now())/1000)); $("count").textContent=remain; if(remain<=0){ring(); schedule();}}
$("start").onclick=()=>{ if(timer) return; schedule(); updateTimer(); timer=setInterval(updateTimer,500); toast('计时开始'); };
$("stop").onclick=()=>{ if(!timer) return; clearInterval(timer); timer=null; $("count").textContent=prefs.interval; toast('已停止'); };
$("ping").onclick=ring;
document.addEventListener('visibilitychange',()=>{ if(timer) updateTimer(); });

// 设置：外观/计时
$("saveBrand").onclick=()=>{ brand.title=$("titleInput").value.trim()||'训练提醒'; brand.ver=$("verInput").value.trim()||''; brand.bg=$("bgColor").value||'#91C6FF'; save(K.brand,brand); $("appTitle").textContent=`${brand.title} ${brand.ver}`; document.body.style.backgroundColor=brand.bg; toast('已保存外观'); };
$("setInterval").value=prefs.interval; $("setBeepLen").value=prefs.beepLen;
$("setInterval").onchange=()=>{prefs.interval=Math.max(10,+$("setInterval").value||60); save(K.prefs,prefs); $("count").textContent=prefs.interval;};
$("setBeepLen").onchange=()=>{prefs.beepLen=Math.min(10,Math.max(1,+$("setBeepLen").value||2)); save(K.prefs,prefs);};
$("testBell").onclick=ring;

// ===== 背景音乐 =====
const musicSel=$("musicSelect"), vbgm=$("bgmMedia");
async function tryLoadServerList(){try{const r=await fetch('music/list.json',{cache:'no-store'}); if(!r.ok) return false; const arr=await r.json(); if(!Array.isArray(arr)) return false; musicList=arr.map(n=>`music/${n}`); save(K.music,musicList); return true;}catch{return false;}}
function renderMusic(){
  musicSel.innerHTML='';
  if(!musicList.length){
    musicSel.innerHTML='<option value="">（暂无音乐）</option>';
    $("musicHint").textContent='未找到 /music/list.json，可用“从本地文件夹读取”（本机会话）';
    return;
  }
  musicList.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p.split('/').pop();musicSel.appendChild(o);});
  $("musicHint").textContent='已读取音乐列表';
}
(async()=>{await tryLoadServerList(); renderMusic();})();
$("bgmPlay").onclick=()=>{const src=musicSel.value; if(!src) return toast('没有可播放的音乐'); vbgm.src=src; vbgm.play().catch(()=>toast('先点一下页面解锁音频'));};
$("bgmPause").onclick=()=>{try{vbgm.pause()}catch{}};
$("readFolder").onclick=()=>{const inp=document.createElement('input'); inp.type='file'; inp.webkitdirectory=true; inp.multiple=true; inp.accept='audio/*,video/*'; inp.onchange=()=>{const files=[...inp.files].filter(f=>/\.(mp3|m4a|wav|mp4|ogg)$/i.test(f.name)); musicList=files.map(f=>URL.createObjectURL(f)); save(K.music,musicList); renderMusic(); toast('已从本地文件夹生成列表（刷新后失效）');}; inp.click();};

// ===== 视频管理 =====
const vmList=$("vmList");
function renderVmList(){
  vmList.innerHTML='';
  const part=$("vmPart").value; const list=videos[part];
  if(!list.length){vmList.innerHTML='<div class="tiny muted">该部位暂无视频。</div>'; refreshVideoSelect(); return;}
  list.forEach((it,i)=>{
    const row=document.createElement('div'); row.className='vm-row';
    row.innerHTML=`<span class="vm-title" title="${it.name}">${it.name}</span>
      <div>
        <button class="btn xs light">✏️ 编辑</button>
        <button class="btn xs danger">🗑 删除</button>
      </div>`;
    const [editBtn,delBtn]=row.querySelectorAll('button');
    editBtn.onclick=()=>{
      const newTitle=prompt('修改标题',it.name); if(newTitle===null) return;
      const newUrl=prompt('修改链接',it.url); if(newUrl===null) return;
      it.name=(newTitle.trim()||'未命名'); it.url=newUrl.trim();
      save(K.videos,videos); renderVmList(); refreshVideoSelect(); toast('已保存该条视频');
    };
    delBtn.onclick=()=>{
      videos[part].splice(i,1); save(K.videos,videos); renderVmList(); refreshVideoSelect(); toast('已删除');
    };
    vmList.appendChild(row);
  });
}
$("vmPart").onchange=renderVmList;
$("vmAdd").onclick=()=>{const p=$("vmPart").value; const u=$("vmUrl").value.trim(); const n=$("vmName").value.trim()||'未命名'; if(!u) return toast('请先填写链接'); videos[p].push({name:n,url:u}); save(K.videos,videos); $("vmUrl").value=''; $("vmName").value=''; renderVmList(); refreshVideoSelect(); toast('已添加视频');};

// 训练页视频选择
function parseEmbed(url){
  try{
    if(/youtube\.com\/watch\?v=|youtu\.be\//.test(url)){const id=url.match(/v=([^&]+)/)?.[1]||url.split('/').pop(); return `https://www.youtube.com/embed/${id}`;}
    if(/bilibili\.com\/video\/BV/i.test(url)){const bv=url.match(/\/BV[0-9A-Za-z]+/i)[0].replace('/',''); return `https://player.bilibili.com/player.html?${bv}&autoplay=1`; }
    return url;
  }catch{return url;}
}
function refreshVideoSelect(){
  const sel=$("videoSelect"); if(!sel) return;
  sel.innerHTML='';
  const list=videos[prefs.part]||[];
  if(!list.length){const o=document.createElement('option');o.value='';o.textContent='（该部位没有已保存视频）'; sel.appendChild(o); return;}
  list.forEach((it,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=it.name; sel.appendChild(o);});
}
$("playSelected").onclick=()=>{
  const sel=$("videoSelect"); const idx=+sel.value;
  const list=videos[prefs.part]; if(!list||!list[idx]) return toast('请选择一个视频');
  const url=list[idx].url;
  $("embedBox").innerHTML=`<iframe id="videoFrame" src="${parseEmbed(url)}" allow="fullscreen; autoplay; encrypted-media" allowfullscreen></iframe>`;
};
$("openSelected").onclick=()=>{
  const sel=$("videoSelect"); const idx=+sel.value; const list=videos[prefs.part]; if(!list||!list[idx]) return;
  window.open(list[idx].url,'_blank');
};
$("enterFs").onclick=()=>{
  const box=$("embedBox");
  if(box.requestFullscreen){ box.requestFullscreen().catch(()=>window.open(document.getElementById('videoFrame')?.src||'#','_blank')); }
  else if(box.webkitRequestFullscreen){ box.webkitRequestFullscreen(); }
  else { window.open(document.getElementById('videoFrame')?.src||'#','_blank'); }
};

// ===== 日志：追加 + 排序模式 + 长按删除 =====
let sortMode=false; // 默认关闭排序模式

// 解析整段：第一行=标题；其余=内容；尽量从标题抽取日期
function parseLogFromFullText(fullText){
  const lines=(fullText||'').split(/\r?\n/);
  const title=(lines[0]||'').trim();
  const content=lines.slice(1).join('\n').trim();
  const m=title.match(/(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})/);
  const date=m?`${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`:new Date().toISOString().slice(0,10);
  return {title: title||date, content, date};
}

// ★ 追加（不覆盖）
function appendLogFromText(fullText){
  const {title,content,date}=parseLogFromFullText(fullText);
  const entry={ id: Date.now()+Math.random(), date, title, content };
  logs.push(entry);
  save(K.logs,logs);
}

$("toggleSort").onclick=()=>{
  sortMode=!sortMode;
  $("toggleSort").textContent=`🧭 排序模式：${sortMode?'开':'关'}`;
  renderLogs();
};

// 长按工具：手机也能删除
function bindLongPress(el, onLongPress){
  let timer=null;
  const start=()=>{timer=setTimeout(()=>{onLongPress();},600)};
  const clear=()=>{if(timer){clearTimeout(timer); timer=null;}};
  el.addEventListener('touchstart',start,{passive:true});
  el.addEventListener('touchend',clear);
  el.addEventListener('touchmove',clear);
  el.addEventListener('mousedown',start);
  el.addEventListener('mouseup',clear);
  el.addEventListener('mouseleave',clear);
}

function renderLogs(){
  const box=$("logList"); box.innerHTML='';
  if(!logs.length){box.innerHTML='<div class="tiny muted">暂无日志。完成训练时点“本次完成”会自动追加；也可点击“添加日志”。</div>';return;}
  logs.forEach((log,i)=>{
    const div=document.createElement('div');
    div.className='log-item';
    div.innerHTML=`<div class="log-title">${log.title}</div>`;
    const c=document.createElement('div'); c.className='log-content hide'; c.textContent=log.content||'（无内容）'; div.appendChild(c);

    if(sortMode){
      const tools=document.createElement('div'); tools.className='log-tools';
      tools.innerHTML=`
        <button class="btn xs light">⬆️ 上移</button>
        <button class="btn xs light">⬇️ 下移</button>
        <button class="btn xs danger">🗑 删除</button>
        <span class="tiny muted">日期：${log.date}</span>`;
      const [upBtn,downBtn,delBtn]=tools.querySelectorAll('button');
      upBtn.onclick=(e)=>{e.stopPropagation(); if(i>0){const t=logs[i-1];logs[i-1]=logs[i];logs[i]=t;save(K.logs,logs);renderLogs();}};
      downBtn.onclick=(e)=>{e.stopPropagation(); if(i<logs.length-1){const t=logs[i+1];logs[i+1]=logs[i];logs[i]=t;save(K.logs,logs);renderLogs();}};
      delBtn.onclick=(e)=>{e.stopPropagation(); if(confirm('删除这条日志？')){logs.splice(i,1);save(K.logs,logs);renderLogs();}}
      div.appendChild(tools);
    }else{
      // 非排序模式：单击展开/收起；双击编辑；长按删除
      div.onclick=()=>c.classList.toggle('hide');
      div.ondblclick=()=>{const nt=prompt('编辑标题',log.title); if(nt===null) return; const nd=prompt('编辑日期(YYYY-MM-DD)',log.date); if(nd===null) return; const nc=prompt('编辑内容',log.content||''); logs[i]={...logs[i],title:nt,date:nd||log.date,content:nc||''}; save(K.logs,logs); renderLogs();}
      bindLongPress(div,()=>{ if(confirm('长按确认：删除这条日志？')){logs.splice(i,1);save(K.logs,logs);renderLogs();}});
    }
    box.appendChild(div);
  });
}

// 添加日志面板
$("toggleAddLog").onclick=()=>{const box=$("addLogBox"); box.classList.toggle('hide');};
$("addLogCancel").onclick=()=>hide("addLogBox");
$("addLogSave").onclick=()=>{
  const txt=$("addLogText").value.trim();
  if(!txt) return toast('请粘贴完整日志');
  appendLogFromText(txt);
  $("addLogText").value=''; hide("addLogBox"); renderLogs(); toast('已添加到日志');
};

// ===== 导出 / 导入（全部数据） =====
$("exportAll").onclick=()=>{
  const payload={brand,prefs,plansNow,plansLast,notes,planNext,videos,musicList,logs,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="training-data.json"; a.click(); URL.revokeObjectURL(url);
  toast('已导出为 training-data.json');
};
$("importAll").onclick=()=>$("importFile").click();
$("importFile").onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const obj=JSON.parse(ev.target.result);
      if(obj.brand) {brand=obj.brand; save(K.brand,brand); $("appTitle").textContent=`${brand.title} ${brand.ver}`; document.body.style.backgroundColor=brand.bg;}
      if(obj.prefs) {prefs=obj.prefs; save(K.prefs,prefs); $("setInterval").value=prefs.interval; $("setBeepLen").value=prefs.beepLen; $("customName").value=prefs.customName;}
      if(obj.plansNow){plansNow=obj.plansNow; save(K.plansNow,plansNow);}
      if(obj.plansLast){plansLast=obj.plansLast; save(K.plansLast,plansLast);}
      if(obj.notes){notes=obj.notes; save(K.notes,notes);}
      if(obj.planNext){planNext=obj.planNext; save(K.planNext,planNext);}
      if(obj.videos){videos=obj.videos; save(K.videos,videos); renderVmList(); refreshVideoSelect();}
      if(obj.musicList){musicList=obj.musicList; save(K.music,musicList); renderMusic();}
      if(obj.logs){
        logs=obj.logs.map(it=>it.id?it:{...it,id:Date.now()+Math.random()}); // 兼容无 id
        save(K.logs,logs); renderLogs();
      }
      loadPartState(); updateWorkTitle();
      toast('导入成功，已覆盖本地数据');
    }catch(e){alert("导入失败：JSON 不合法");}
  };
  reader.readAsText(file);
};

// ===== 启动默认页 =====
function refreshVideoSelect(){ // 定义一次，别再覆盖
  const sel=$("videoSelect"); if(!sel) return;
  sel.innerHTML='';
  const list=videos[prefs.part]||[];
  if(!list.length){const o=document.createElement('option');o.value='';o.textContent='（该部位没有已保存视频）'; sel.appendChild(o); return;}
  list.forEach((it,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=it.name; sel.appendChild(o);});
}

setActive('home'); setSub('last'); renderLogs();
})();
</script>
</body>
</html>
