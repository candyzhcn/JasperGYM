<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#91C6FF"/>
<title>训练提醒 · 全量版 v3.23</title>
<style>
:root{
  --bg:#91C6FF; --panel:#ffffff; --ink:#111; --muted:#5b616a;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --border:#d1d5db; --field:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
a{color:var(--brand);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
.header{position:static;top:0;z-index:10;background:linear-gradient(#91C6FF,#91C6FFcc 80%,transparent);padding:8px 0 6px}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer;user-select:none}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 10px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type="text"],input[type="number"],input[type="color"],textarea{
  width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none
}
textarea{min-height:160px;resize:vertical}
.bigtext{min-height:320px}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.btn.light{background:transparent;border:1px solid var(--border);color:#111}
.btn.danger{background:var(--danger);color:#fff}
.btn.xs{padding:6px 10px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.muted{color:var(--muted)} .tiny{font-size:12px}
.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;
  padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}

/* 首页 */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer}
.choice input{transform:scale(1.2)}
.choice:hover{border-color:var(--brand)}
.choice .name{font-weight:700}

/* 训练页 */
.timer{font-size:40px;font-weight:800;letter-spacing:1px}

/* 日志 */
.log-item{padding:10px 8px;border-bottom:1px solid var(--border);border-radius:8px}
.log-item:hover{background:#f8fafc}
.log-title{font-weight:600;cursor:pointer}
.log-content{margin-top:6px;white-space:pre-wrap;word-break:break-word}
.log-tools{display:flex;gap:6px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <!-- 顶部 -->
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">训练提醒 · 全量版 v3.23</div>
      <div class="tabs">
        <div class="tab active" data-page="home">🏠 首页</div>
        <div class="tab" data-page="work">🏋️ 训练</div>
        <div class="tab" data-page="logs">📓 日志</div>
        <div class="tab" data-page="settings">⚙️ 设置</div>
      </div>
    </div>
  </div>

  <!-- 首页 -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">今天训练什么？</div>
      <div class="choices" id="homeChoices"></div>
      <div class="row auto" style="margin-top:10px">
        <div class="tiny muted">选择后点击开始；可在设置里自定义颜色/标题/背景音乐。</div>
        <button class="btn brand" id="btnStart">进入训练页</button>
      </div>
    </div>
  </div>

  <!-- 训练页 -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle">本次训练</div>
      <div class="row auto">
        <div class="field"><label>训练部位</label>
          <select id="workPart"></select>
        </div>
        <div class="field"><label>时间间隔（秒）</label>
          <input id="intervalInput" type="number" min="10" max="999" step="1" value="60"/>
        </div>
        <div class="field"><label>提示音长度（秒）</label>
          <input id="beepLen" type="number" min="1" max="10" step="1" value="2"/>
        </div>
      </div>
      <div class="center" style="margin:16px 0"><div class="timer" id="timer">00:00</div></div>
      <div class="row auto">
        <button class="btn ok" id="btnStartTimer">开始</button>
        <button class="btn light" id="btnStopTimer">停止</button>
        <button class="btn light" id="btnDone">✅ 本次完成 → 加入日志</button>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">参考视频</div>
      <div class="row auto">
        <div class="field"><label>选择视频</label><select id="videoSelect"></select></div>
        <a id="openVideo" class="btn light" target="_blank" href="#">打开视频</a>
      </div>
    </div>
  </div>

  <!-- 日志页 -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">训练日志（非排序：单击展开/收起、双击直接在原内容框编辑；排序：右侧 ✏️ 编辑）</div>
      <div id="logList"></div>
      <div class="row auto" style="margin-top:10px">
        <button class="btn ok" id="toggleAddLog">➕ 添加日志</button>
        <button class="btn light" id="toggleSort">🧭 排序模式：关</button>
      </div>
      <div id="addLogBox" class="hide" style="margin-top:10px">
        <textarea id="addLogText" class="bigtext" placeholder="把你的训练总结粘贴到这里，第一行将作为标题"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="addLogSave">保存到日志</button>
          <button class="btn light" id="addLogCancel">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置页（保留导出/导入/清空 + 视频管理简化示意） -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle">外观 / 标识</div>
      <div class="row auto">
        <div class="field"><label>自定义标题</label><input id="titleInput" type="text" placeholder="如：JasperGYM"></div>
        <div class="field"><label>版本号</label><input id="verInput" type="text" placeholder="如：v3.23"></div>
        <div class="field"><label>背景颜色</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand">保存外观</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">数据管理</div>
      <div class="row auto">
        <button class="btn ok" id="exportAll">📤 导出全部数据</button>
        <input type="file" id="importFile" class="hide" accept=".json"/>
        <button class="btn warn" id="importAll">📥 导入数据（覆盖本地）</button>
        <button class="btn danger" id="wipeAll">🗑 清空全部数据（不可恢复）</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<script>
// ===== 基础工具 =====
const $=id=>document.getElementById(id);
const show=id=>$(id).classList.remove('hide');
const hide=id=>$(id).classList.add('hide');
function toast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hide');t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1600);setTimeout(()=>t.classList.add('hide'),1900);}

// ===== 存储键 =====
const K={ brand:'gym_brand', prefs:'gym_prefs', videos:'gym_videos', logs:'gym_logs' };
function load(key,def){try{const t=localStorage.getItem(key);return t?JSON.parse(t):def}catch(e){return def}}
function save(key,val){localStorage.setItem(key,JSON.stringify(val))}

// ===== 状态 =====
let brand=load(K.brand,{title:'训练提醒 · 全量版',ver:'v3.23',bg:'#91C6FF'});
let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs'});
let videos=load(K.videos,{legs:[],chest:[],back:[],arms:[],shoulders:[],core:[]});
let logs=load(K.logs,[]);
let sortMode=false;

// ===== 顶部导航 =====
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    ['home','work','logs','settings'].forEach(p=>$('page-'+p).classList.add('hide'));
    $('page-'+t.dataset.page).classList.remove('hide');
  };
});

// ===== 首页部位 =====
const parts=[{id:'legs',name:'腿部'},{id:'chest',name:'胸部'},{id:'back',name:'背部'},{id:'arms',name:'手臂'},{id:'shoulders',name:'肩部'},{id:'core',name:'核心'}];
function renderHomeChoices(){
  const box=$('homeChoices'); box.innerHTML='';
  parts.forEach(p=>{
    const div=document.createElement('div'); div.className='choice';
    div.innerHTML=`<input type="radio" name="part" value="${p.id}"/><span class="name">${p.name}</span>`;
    div.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs);};
    box.appendChild(div);
  });
}
$('btnStart').onclick=()=>{ setActive('work'); renderWork(); };
function setActive(page){ ['home','work','logs','settings'].forEach(p=>$('page-'+p).classList.add('hide')); $('page-'+page).classList.remove('hide');
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active')); document.querySelector(`.tab[data-page="${page}"]`).classList.add('active'); }

// ===== 训练页 =====
function renderWork(){
  const sel=$('workPart'); sel.innerHTML=''; parts.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o);}); sel.value=prefs.part;
  $('intervalInput').value=prefs.interval; $('beepLen').value=prefs.beepLen;
  const vs=$('videoSelect'); vs.innerHTML=''; const arr=videos[prefs.part]||[]; arr.forEach((it,idx)=>{ const o=document.createElement('option'); o.value=idx; o.textContent=it.name; vs.appendChild(o); });
  $('openVideo').onclick=()=>{ const i=vs.value; if(i===''||i==null){toast('请选择视频');return;} window.open(arr[i].url,'_blank'); };
}
let timerId=null,elapsed=0; function startTimer(){ stopTimer(); elapsed=0; tick(); timerId=setInterval(tick,1000);} function stopTimer(){ if(timerId){clearInterval(timerId);timerId=null;} }
function tick(){ $('timer').textContent = new Date(++elapsed*1000).toISOString().substr(14,5); }
$('btnStartTimer').onclick=startTimer; $('btnStopTimer').onclick=stopTimer;
$('btnDone').onclick=()=>{ appendLogFromText(`本次训练：${parts.find(x=>x.id===prefs.part).name}\n时间：${new Date().toLocaleString()}`); renderLogs(); toast('已加入日志'); };

// ===== 日志：添加 / 渲染 =====
function appendLogFromText(txt){ const first=(txt.split(/\r?\n/)[0]||'').trim()||'（无标题）'; logs.push({title:first,content:txt,ts:Date.now()}); save(K.logs,logs); }

$('toggleAddLog').onclick=()=>$('addLogBox').classList.toggle('hide');
$('addLogCancel').onclick=()=>hide('addLogBox');
$('addLogSave').onclick=()=>{ const txt=$('addLogText').value.trim(); if(!txt) return toast('请粘贴完整日志'); appendLogFromText(txt); $('addLogText').value=''; hide('addLogBox'); renderLogs(); toast('已添加到日志'); };

$('toggleSort').onclick=()=>{ sortMode=!sortMode; $('toggleSort').textContent=`🧭 排序模式：${sortMode?'开':'关'}`; renderLogs(); };

// 长按绑定（非排序模式用：直接删除，无确认）
function bindLongPress(el,fn){ let t; el.addEventListener('touchstart',()=>{t=setTimeout(fn,500)},{passive:true}); ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>el.addEventListener(ev,()=>clearTimeout(t))); }

// 创建“内容框”DOM（用于就地替换，避免重复节点）
function createContentDiv(text){ const d=document.createElement('div'); d.className='log-content'; d.textContent=text||'（无内容）'; return d; }

// 进入“就地编辑”（把原内容框替换成 textarea，不新增外层容器，避免重复）
function enterEdit(div, contentDiv, i){
  if (div.dataset.editing==='1') return;       // 防抖：同一条只允许一个编辑器
  div.dataset.editing='1';

  const ta=document.createElement('textarea');  // 用原位置编辑
  ta.className='bigtext';
  ta.value=logs[i].content||'';

  const actions=document.createElement('div');
  actions.className='row auto'; actions.style.marginTop='8px';
  const saveBtn=document.createElement('button'); saveBtn.className='btn ok'; saveBtn.textContent='💾 保存';
  const cancelBtn=document.createElement('button'); cancelBtn.className='btn light'; cancelBtn.textContent='取消';
  actions.appendChild(saveBtn); actions.appendChild(cancelBtn);

  // 包装成一个新的“内容框”容器，替换掉原 contentDiv
  const editorWrap=document.createElement('div');
  editorWrap.className='log-content';
  editorWrap.appendChild(ta); editorWrap.appendChild(actions);

  contentDiv.replaceWith(editorWrap);

  saveBtn.onclick=()=>{
    const newContent=ta.value;
    const firstLine=(newContent.split(/\r?\n/)[0]||'').trim() || logs[i].title || '（无标题）';
    logs[i]={...logs[i], title:firstLine, content:newContent};
    save(K.logs,logs);
    // 还原成内容框
    const newContentDiv=createContentDiv(newContent);
    editorWrap.replaceWith(newContentDiv);
    div.dataset.editing=''; toast('已更新');
  };
  cancelBtn.onclick=()=>{ editorWrap.replaceWith(contentDiv); div.dataset.editing=''; };
}

function renderLogs(){
  const box=$('logList'); box.innerHTML='';
  if(!logs.length){box.innerHTML='<div class="tiny muted">暂无日志。完成训练时点“本次完成”会自动追加；也可点击“添加日志”。</div>';return;}
  logs.forEach((log,i)=>{
    const div=document.createElement('div'); div.className='log-item';
    const title=document.createElement('div'); title.className='log-title'; title.textContent=log.title||'（无标题）';
    const content=createContentDiv(log.content); content.classList.add('hide');
    div.appendChild(title); div.appendChild(content);

    if(sortMode){
      const tools=document.createElement('div'); tools.className='log-tools';
      tools.innerHTML=`<button class="btn xs light">⬆️ 上移</button><button class="btn xs light">⬇️ 下移</button><button class="btn xs light">✏️ 编辑</button><button class="btn xs danger">🗑 删除</button>`;
      const [upBtn,downBtn,editBtn,delBtn]=tools.querySelectorAll('button');

      editBtn.onclick=(e)=>{ e.stopPropagation(); content.classList.remove('hide'); enterEdit(div, content, i); };
      upBtn.onclick=(e)=>{ e.stopPropagation(); if(i>0){[logs[i-1],logs[i]]=[logs[i],logs[i-1]]; save(K.logs,logs); renderLogs();} };
      downBtn.onclick=(e)=>{ e.stopPropagation(); if(i<logs.length-1){[logs[i+1],logs[i]]=[logs[i],logs[i+1]]; save(K.logs,logs); renderLogs();} };
      delBtn.onclick=(e)=>{ e.stopPropagation(); logs.splice(i,1); save(K.logs,logs); renderLogs(); toast('已删除'); };
      div.appendChild(tools);
    }else{
      // 非排序：单击展开/收起；双击在原内容框内编辑；长按直接删除（无确认）
      div.onclick=()=>content.classList.toggle('hide');
      div.ondblclick=()=>{ content.classList.remove('hide'); enterEdit(div, content, i); };
      bindLongPress(div,()=>{ logs.splice(i,1); save(K.logs,logs); renderLogs(); toast('已删除'); });
    }
    box.appendChild(div);
  });
}

// ===== 设置：外观 & 数据 =====
$('saveBrand').onclick=()=>{
  brand.title=$('titleInput').value||brand.title;
  brand.ver=$('verInput').value||brand.ver;
  brand.bg=$('bgColor').value||brand.bg;
  save(K.brand,brand);
  $('appTitle').textContent=`${brand.title} ${brand.ver}`;
  document.documentElement.style.setProperty('--bg', brand.bg);
  toast('外观已保存');
};

$('exportAll').onclick=()=>{
  const payload={brand,prefs,videos,logs};
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(payload,null,2));
  a.download='jaspergym-data.json'; a.click();
};
$('importAll').onclick=()=>$('importFile').click();
$('importFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      if(obj.brand)brand=obj.brand;
      if(obj.prefs)prefs=obj.prefs;
      if(obj.videos)videos=obj.videos;
      if(obj.logs)logs=obj.logs;
      save(K.brand,brand); save(K.prefs,prefs); save(K.videos,videos); save(K.logs,logs);
      $('appTitle').textContent=`${brand.title} ${brand.ver}`;
      document.documentElement.style.setProperty('--bg', brand.bg);
      renderWork(); renderLogs();
      toast('导入完成（已覆盖本地）');
    }catch(err){ toast('导入失败：JSON 有误'); }
  };
  reader.readAsText(f,'utf-8');
};
$('wipeAll').onclick=()=>{
  Object.values(K).forEach(k=>localStorage.removeItem(k));
  toast('已清空数据，刷新中…'); setTimeout(()=>location.reload(),300);
};

// ===== 启动 =====
(function init(){
  $('appTitle').textContent=`${brand.title} ${brand.ver}`;
  document.documentElement.style.setProperty('--bg', brand.bg);
  (function renderHomeChoices(){
    const box=$('homeChoices'); box.innerHTML='';
    parts.forEach(p=>{
      const div=document.createElement('div'); div.className='choice';
      div.innerHTML=`<input type="radio" name="part" value="${p.id}"/><span class="name">${p.name}</span>`;
      div.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs);};
      box.appendChild(div);
    });
  })();
  renderWork(); renderLogs();
})();
</script>
</body>
</html>
