<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#91C6FF"/>
<title>è®­ç»ƒæé†’ Â· å…¨é‡ç‰ˆ</title>
<style>
:root{
  --bg:#91C6FF; --panel:#ffffff; --ink:#111; --muted:#5b616a;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --border:#d1d5db; --field:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
a{color:var(--brand);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
.header{position:static;top:0;z-index:10;background:linear-gradient(#91C6FF,#91C6FFcc 80%,transparent);padding:8px 0 6px}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 10px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type="text"],input[type="number"],input[type="color"],textarea{
  width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none
}
textarea{min-height:160px;resize:vertical}
.bigtext{min-height:560px;max-height:860px;overflow:auto}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff;background:#334155}
.btn.light{background:transparent;border:1px solid var(--border);color:#111}
.btn.danger{background:var(--danger);color:#fff}
.btn.xs{padding:6px 10px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.muted{color:var(--muted)} .tiny{font-size:12px}
.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;
  padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}
.grid2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}

/* é¦–é¡µé€‰æ‹© */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
.choice input{transform:scale(1.2)}

/* è®­ç»ƒé¡µåˆ†é¡µ */
.subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 2px}
.subtab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 12px;cursor:pointer}
.subtab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

/* è§†é¢‘ */
.embed{width:100%;min-height:520px;aspect-ratio:16/9;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#000}
iframe{width:100%;height:100%;border:0}

/* è§†é¢‘ç®¡ç†åˆ—è¡¨ */
.vm-row{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:10px;padding:10px;background:#f8fafc;margin-bottom:8px}
.vm-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}
.timer{font-size:40px;font-weight:800;letter-spacing:1px}

/* æ—¥å¿—åˆ—è¡¨ */
.log-item{padding:10px 8px;border-bottom:1px solid var(--border);border-radius:8px}
.log-item:hover{background:#f8fafc}
.log-title{font-weight:600}
.log-content{margin-top:6px;white-space:pre-wrap}
.log-tools{display:flex;gap:6px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <!-- é¡¶éƒ¨ -->
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">è®­ç»ƒæé†’ v3.14</div>
      <div class="tabs">
        <div class="tab active" data-page="home">ğŸ  é¦–é¡µ</div>
        <div class="tab" data-page="work">ğŸ‹ï¸ è®­ç»ƒ</div>
        <div class="tab" data-page="logs">ğŸ““ æ—¥å¿—</div>
        <div class="tab" data-page="settings">âš™ï¸ è®¾ç½®</div>
      </div>
    </div>
  </div>

  <!-- é¦–é¡µ -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">ä»Šå¤©è®­ç»ƒä»€ä¹ˆï¼Ÿ</div>
      <div class="choices">
        <label class="choice"><input type="radio" name="part" value="legs">è…¿</label>
        <label class="choice"><input type="radio" name="part" value="chest">èƒ¸</label>
        <label class="choice"><input type="radio" name="part" value="back">èƒŒ</label>
        <label class="choice"><input type="radio" name="part" value="shoulders">è‚©</label>
        <label class="choice"><input type="radio" name="part" value="core">æ ¸å¿ƒ</label>
        <label class="choice"><input type="radio" name="part" value="custom">è‡ªå®šä¹‰</label>
      </div>
      <div class="row auto" style="margin-top:12px">
        <div class="field"><label>è‡ªå®šä¹‰éƒ¨ä½åç§°</label><input id="customName" type="text" placeholder="å¦‚ï¼šå…¨èº«å¾ªç¯/æŠ€æœ¯ç»ƒä¹ "></div>
        <button class="btn brand" id="btnStart">è¿›å…¥è®­ç»ƒé¡µ</button>
      </div>
    </div>
  </div>

  <!-- è®­ç»ƒé¡µ -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle"><span id="workTitle">è®­ç»ƒ</span> Â· æ§åˆ¶å°</div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted tiny">å€’è®¡æ—¶ï¼ˆä¼‘æ¯é—´éš”åœ¨è®¾ç½®é¡µç»Ÿä¸€é…ç½®ï¼‰</div>
          <div class="timer"><span id="count">60</span>s</div>
        </div>
        <div class="row auto" style="max-width:420px">
          <button class="btn brand" id="start">â–¶ï¸ å¼€å§‹</button>
          <button class="btn danger" id="stop">â¹ åœæ­¢</button>
          <button class="btn light" id="ping">ğŸ”” è¯•é“ƒ</button>
        </div>
      </div>
    </div>

    <div class="subtabs">
      <div class="subtab active" data-sub="last">â‘  ä¸Šæ¬¡è®°å½•</div>
      <div class="subtab" data-sub="now">â‘¡ æœ¬æ¬¡è®¡åˆ’</div>
      <div class="subtab" data-sub="video">â‘¢ è§†é¢‘å‚è€ƒ</div>
      <div class="subtab" data-sub="next">â‘£ ä¸‹æ¬¡å±•æœ›</div>
    </div>

    <!-- ä¸Šæ¬¡ -->
    <div id="sub-last">
      <div class="card">
        <div class="sectionTitle">ä¸Šæ¬¡è®­ç»ƒè®¡åˆ’ & æ„Ÿå—ï¼ˆåªè¯»ï¼‰</div>
        <textarea id="planLast" class="bigtext" readonly></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn light" id="copyToNow">â¬…ï¸ å¤åˆ¶ä¸ºæœ¬æ¬¡è®¡åˆ’</button>
          <button class="btn warn" id="clearLast">ğŸ§¹ æ¸…ç©ºä¸Šæ¬¡</button>
        </div>
      </div>
    </div>

    <!-- æœ¬æ¬¡ -->
    <div id="sub-now" class="hide">
      <div class="card">
        <div class="sectionTitle">æœ¬æ¬¡è®­ç»ƒé¢„è®¡è®¡åˆ’ & é‡é‡å»ºè®®</div>
        <textarea id="planNow" class="bigtext" placeholder="æŠŠä»Šå¤©å®Œæ•´æ€»ç»“å†™åœ¨è¿™é‡Œï¼ˆç¬¬ä¸€è¡Œ=æ ‡é¢˜ï¼Œä¸‹é¢=è¯¦ç»†å†…å®¹ï¼‰"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNow">ğŸ’¾ ä¿å­˜æœ¬æ¬¡</button>
          <button class="btn brand" id="saveToLast">âœ… æœ¬æ¬¡å®Œæˆ â†’ å­˜ä¸ºâ€œä¸Šæ¬¡â€ï¼ˆå¹¶è¿½åŠ åˆ°æ—¥å¿—ï¼‰</button>
        </div>
      </div>
      <div class="card">
        <div class="sectionTitle">åŠ¨ä½œæ³¨æ„äº‹é¡¹ï¼ˆæŒ‰éƒ¨ä½ä¿å­˜ï¼‰</div>
        <textarea id="notes" class="bigtext" placeholder="ä¸Šæ–œå§æ¨ï¼šè‚©èƒ›åç¼©ä¸‹æ²‰ï¼›è½ç‚¹é”éª¨ä¸‹2æ¨ªæŒ‡ï¼›ä¸‹æ”¾2ç§’ã€æ¨èµ·1ç§’â€¦"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNotes">ğŸ’¾ ä¿å­˜æ³¨æ„äº‹é¡¹</button>
        </div>
      </div>
    </div>

    <!-- è§†é¢‘ -->
    <div id="sub-video" class="hide">
      <div class="card">
        <div class="sectionTitle">é€‰æ‹©ä¸€ä¸ªå·²ä¿å­˜çš„è§†é¢‘è¿›è¡Œå‚è€ƒ</div>
        <div class="row auto">
          <div class="field"><label>è§†é¢‘åˆ—è¡¨ï¼ˆåœ¨è®¾ç½®é¡µç®¡ç†ï¼‰</label><select id="videoSelect"></select></div>
          <button class="btn ok" id="playSelected">â–¶ï¸ æ’­æ”¾</button>
          <button class="btn light" id="openSelected">ğŸ”— æ–°çª—å£æ‰“å¼€</button>
        </div>
      </div>
      <div class="card">
        <div class="sectionTitle">æ’­æ”¾åŒºï¼ˆå¯å…¨å±ï¼‰</div>
        <div class="embed" id="embedBox"><div class="muted tiny" style="padding:10px">æœªé€‰æ‹©è§†é¢‘</div></div>
        <div class="row auto" style="margin-top:8px">
          <button class="btn light" id="enterFs">â›¶ å…¨å±</button>
        </div>
      </div>
    </div>

    <!-- ä¸‹æ¬¡ -->
    <div id="sub-next" class="hide">
      <div class="card">
        <div class="sectionTitle">ä¸‹ä¸€æ¬¡è®­ç»ƒæ—¥çš„å±•æœ›è®¡åˆ’</div>
        <textarea id="planNext" class="bigtext"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNext">ğŸ’¾ ä¿å­˜</button>
          <button class="btn warn" id="clearNext">ğŸ§¹ æ¸…ç©º</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ—¥å¿—é¡µ -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">è®­ç»ƒæ—¥å¿—ï¼ˆé»˜è®¤éšè—æ’åºæŒ‰é’®ï¼›é•¿æŒ‰å¯åˆ é™¤ï¼›å¼€å¯â€œæ’åºæ¨¡å¼â€åå¯ä¸Šä¸‹ç§»åŠ¨/åˆ é™¤ï¼‰</div>
      <div id="logList"></div>
      <div class="row auto" style="margin-top:10px">
        <button class="btn ok" id="toggleAddLog">â• æ·»åŠ æ—¥å¿—</button>
        <button class="btn ghost" id="toggleSort">ğŸ§­ æ’åºæ¨¡å¼ï¼šå…³</button>
      </div>
    </div>
    <div class="card hide" id="addLogBox">
      <div class="sectionTitle">ç²˜è´´æ•´æ®µæ—¥å¿—ï¼ˆç¬¬ä¸€è¡Œ=æ ‡é¢˜ï¼›ä¸‹é¢=å†…å®¹ï¼‰</div>
      <textarea id="addLogText" class="bigtext" placeholder="ğŸ“ 2025-09-23 è…¿è‡€å®¹é‡/æ³µæ„Ÿæ—¥æ€»ç»“&#10;&#10;æ—¶é—´ï¼š...&#10;..."></textarea>
      <div class="row auto" style="margin-top:8px">
        <button class="btn ok" id="addLogSave">ä¿å­˜åˆ°æ—¥å¿—</button>
        <button class="btn light" id="addLogCancel">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®é¡µ -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle">å¤–è§‚ / æ ‡è¯†</div>
      <div class="row auto">
        <div class="field"><label>è‡ªå®šä¹‰æ ‡é¢˜</label><input id="titleInput" type="text" placeholder="å¦‚ï¼šJasper è®­ç»ƒè®¡åˆ’"></div>
        <div class="field"><label>è‡ªå®šä¹‰ç‰ˆæœ¬å·</label><input id="verInput" type="text" placeholder="å¦‚ï¼šv3.14"></div>
        <div class="field"><label>èƒŒæ™¯é¢œè‰²</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand">ğŸ’¾ ä¿å­˜æ ‡é¢˜/ç‰ˆæœ¬/èƒŒæ™¯</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">è®¡æ—¶ / é“ƒå£°</div>
      <div class="row auto">
        <div class="field"><label>ä¼‘æ¯é—´éš”ï¼ˆç§’ï¼‰</label><input id="setInterval" type="number" min="10" step="5"></div>
        <div class="field"><label>å“é“ƒæ—¶é•¿ï¼ˆç§’ï¼‰</label><input id="setBeepLen" type="number" min="1" max="10"></div>
        <button class="btn light" id="testBell">ğŸ”” è¯•æ”¾é“ƒå£°</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">é“ƒå£°ä¼˜å…ˆä½¿ç”¨ /bell.mp3 æˆ– /bell.mp4ï¼Œç¼ºå¤±æ—¶ç”¨åˆæˆå“”å£°ã€‚</div>
    </div>

    <div class="card">
      <div class="sectionTitle">èƒŒæ™¯éŸ³ä¹</div>
      <div class="row auto">
        <div class="field">
          <label>éŸ³ä¹åˆ—è¡¨ï¼ˆä¼˜å…ˆè¯»å– /music/list.jsonï¼Œæ²¡æœ‰å°±ä»æœ¬åœ°æ–‡ä»¶å¤¹é€‰æ‹©ï¼‰</label>
          <select id="musicSelect"></select>
          <div class="tiny muted" id="musicHint">æ­£åœ¨å°è¯•è¯»å– /music/list.json â€¦</div>
        </div>
        <div class="field">
          <label>æ“ä½œ</label>
          <div class="row auto">
            <button class="btn ok" id="bgmPlay">â–¶ï¸ æ’­æ”¾</button>
            <button class="btn danger" id="bgmPause">â¸ æš‚åœ</button>
            <button class="btn light" id="readFolder">ğŸ“‚ ä»æœ¬åœ°æ–‡ä»¶å¤¹è¯»å–</button>
          </div>
        </div>
      </div>
      <video id="bgmMedia" preload="auto" loop style="display:none"></video>
    </div>

    <div class="card">
      <div class="sectionTitle">è§†é¢‘ç®¡ç†ï¼ˆæŒ‰éƒ¨ä½ä¿å­˜ï¼‰</div>
      <div class="row auto">
        <div class="field">
          <label>éƒ¨ä½</label>
          <select id="vmPart">
            <option value="legs">è…¿</option><option value="chest">èƒ¸</option>
            <option value="back">èƒŒ</option><option value="shoulders">è‚©</option>
            <option value="core">æ ¸å¿ƒ</option><option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </div>
        <div class="field"><label>è§†é¢‘é“¾æ¥</label><input id="vmUrl" type="text" placeholder="https://ï¼ˆYouTube/Bç«™ï¼‰"></div>
        <div class="field"><label>è‡ªå®šä¹‰æ ‡é¢˜</label><input id="vmName" type="text" placeholder="å¦‚ï¼šå€’è¹¬æœºæ•™ç¨‹ / æ·±è¹²è¦ç‚¹"></div>
        <button class="btn ok" id="vmAdd">æ·»åŠ åˆ°è¯¥éƒ¨ä½</button>
      </div>
      <div style="margin-top:10px" id="vmList"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">æ•°æ®ç®¡ç†ï¼ˆå¯¼å…¥ / å¯¼å‡º å…¨éƒ¨è®¾ç½®ä¸æ—¥å¿—ï¼‰</div>
      <div class="row auto">
        <button class="btn ok" id="exportAll">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
        <input type="file" id="importFile" class="hide" accept=".json"/>
        <button class="btn warn" id="importAll">ğŸ“¥ å¯¼å…¥æ•°æ®ï¼ˆè¦†ç›–æœ¬åœ°ï¼‰</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">
        å¯¼å‡ºåŒ…å«ï¼šå¤–è§‚è®¾ç½®ã€è®¡æ—¶è®¾ç½®ã€å„éƒ¨ä½â€œæœ¬æ¬¡/ä¸Šæ¬¡/æ³¨æ„äº‹é¡¹/ä¸‹æ¬¡â€ã€å·²ä¿å­˜è§†é¢‘ã€éŸ³ä¹åˆ—è¡¨ï¼ˆæ–‡ä»¶å/URLï¼‰ã€è®­ç»ƒæ—¥å¿—ã€‚
      </div>
    </div>
  </div>
</div>

<audio id="beepAudio" preload="auto"></audio>
<div id="toast" class="toast"></div>

<script>
(()=>{
// ===== å·¥å…· & æœ¬åœ°å­˜å‚¨ =====
const $=id=>document.getElementById(id);
const show=id=>$(id).classList.remove('hide');
const hide=id=>$(id).classList.add('hide');
const toast=m=>{const t=$("toast");t.textContent=m;t.style.opacity=0;t.style.display='block';requestAnimationFrame(()=>t.style.opacity=1);setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.style.display='none',200)},1600)}
const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const K={brand:'pg_brand_v3',prefs:'pg_prefs_v3',plansNow:'pg_now_v3',plansLast:'pg_last_v3',notes:'pg_notes_v3',planNext:'pg_next_v3',videos:'pg_videos_v3',music:'pg_music_v3',logs:'pg_logs_v3'};

// ===== çŠ¶æ€ =====
let brand=load(K.brand,{title:'è®­ç»ƒæé†’',ver:'v3.14',bg:'#91C6FF'});
let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs',customName:'',showTips:false});
let plansNow=load(K.plansNow,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let plansLast=load(K.plansLast,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let notes=load(K.notes,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let planNext=load(K.planNext,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let videos=load(K.videos,{legs:[],chest:[],back:[],shoulders:[],core:[],custom:[]});
let musicList=load(K.music,[]);
let logs=load(K.logs,[]); // [{id,date,title,content}] é¡ºåº=å½“å‰æ•°ç»„é¡ºåº
if(Array.isArray(logs)){ // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šè¡¥ id
  logs=logs.map(it=>it.id?it:{...it,id:Date.now()+Math.random()});
  save(K.logs,logs);
}

// ===== é¡¶éƒ¨å¯¼èˆª =====
function setActive(page){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.page===page));
  ['page-home','page-work','page-logs','page-settings'].forEach(id=>hide(id));
  show(`page-${page}`);
  if(page==='logs') renderLogs();
  if(page==='settings') { renderVmList(); renderMusic(); }
}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>setActive(t.dataset.page));

// ===== å¤–è§‚åˆå§‹åŒ– =====
document.body.style.backgroundColor=brand.bg;
$("appTitle").textContent=`${brand.title} ${brand.ver}`;
$("titleInput").value=brand.title; $("verInput").value=brand.ver; $("bgColor").value=brand.bg;

// ===== é¦–é¡µé€‰æ‹© =====
document.querySelectorAll('input[name="part"]').forEach(r=>{
  r.checked=(r.value===prefs.part);
  r.onchange=()=>{prefs.part=r.value;save(K.prefs,prefs);refreshVideoSelect();updateWorkTitle();}
});
$("customName").value=prefs.customName; $("customName").oninput=()=>{prefs.customName=$("customName").value.trim();save(K.prefs,prefs);};
$("btnStart").onclick=()=>{setActive('work');loadPartState();updateWorkTitle();};

// ===== è®­ç»ƒé¡µå­åˆ†é¡µ =====
function setSub(s){document.querySelectorAll('.subtab').forEach(x=>x.classList.toggle('active',x.dataset.sub===s)); ['sub-last','sub-now','sub-video','sub-next'].forEach(id=>hide(id)); show(`sub-${s}`);}
document.querySelectorAll('.subtab').forEach(s=>s.onclick=()=>setSub(s.dataset.sub));
function currPartName(){return prefs.part==='custom'?(prefs.customName||'è‡ªå®šä¹‰'):{legs:'è…¿',chest:'èƒ¸',back:'èƒŒ',shoulders:'è‚©',core:'æ ¸å¿ƒ'}[prefs.part]}
function updateWorkTitle(){ $("workTitle").textContent=currPartName(); }
function loadPartState(){
  $("planNow").value=plansNow[prefs.part]||''; $("planLast").value=plansLast[prefs.part]||''; $("planNext").value=planNext[prefs.part]||''; $("notes").value=notes[prefs.part]||'';
  refreshVideoSelect();
}

// ä¿å­˜è®¡åˆ’ä¸æ³¨æ„äº‹é¡¹
$("saveNow").onclick=()=>{plansNow[prefs.part]=$("planNow").value.trim(); save(K.plansNow,plansNow); toast('å·²ä¿å­˜æœ¬æ¬¡');};
$("saveToLast").onclick=()=>{
  const full=$("planNow").value.trim();
  plansLast[prefs.part]=full; save(K.plansLast,plansLast); $("planLast").value=full;

  // â˜… è¿½åŠ åˆ°æ—¥å¿—ï¼ˆä¸è¦†ç›–ï¼‰
  if(full){ appendLogFromText(full); renderLogs(); toast('å·²ä¿å­˜ä¸ºä¸Šæ¬¡ï¼Œå¹¶è¿½åŠ åˆ°æ—¥å¿—'); }
  else { toast('å·²ä¿å­˜ä¸ºä¸Šæ¬¡'); }
};
$("copyToNow").onclick=()=>{$("planNow").value=$("planLast").value; $("saveNow").click();};
$("clearLast").onclick=()=>{if(!confirm('æ¸…ç©ºä¸Šæ¬¡è®°å½•ï¼Ÿ'))return; plansLast[prefs.part]=''; save(K.plansLast,plansLast); $("planLast").value='';};
$("saveNotes").onclick=()=>{notes[prefs.part]=$("notes").value.trim(); save(K.notes,notes); toast('å·²ä¿å­˜æ³¨æ„äº‹é¡¹');};
$("saveNext").onclick=()=>{planNext[prefs.part]=$("planNext").value.trim(); save(K.planNext,planNext); toast('å·²ä¿å­˜');};
$("clearNext").onclick=()=>{if(!confirm('æ¸…ç©ºä¸‹ä¸€æ¬¡å±•æœ›ï¼Ÿ'))return; planNext[prefs.part]=''; save(K.planNext,planNext); $("planNext").value='';};

// ===== è®¡æ—¶ä¸é“ƒå£° =====
$("count").textContent=prefs.interval;
const beep=$("beepAudio");
(async()=>{try{const r=await fetch('bell.mp3',{method:'HEAD'}); if(r.ok){beep.src='bell.mp3';return;}}catch{} try{const r2=await fetch('bell.mp4',{method:'HEAD'}); if(r2.ok){beep.src='bell.mp4';}}catch{} })();
let audioCtx=null; function ensureCtx(){ if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC();}}
function synthBeep(sec){try{ensureCtx(); if(!audioCtx) return; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine';o.frequency.value=880;o.connect(g);g.connect(audioCtx.destination); g.gain.value=.25;o.start();setTimeout(()=>o.stop(),(sec||2)*1000);}catch{}}
['click','touchstart'].forEach(e=>document.addEventListener(e,()=>{try{ensureCtx(); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); beep.play().then(()=>beep.pause()).catch(()=>{});}catch{}},{once:true}));
function ring(){ if(beep.src){ try{beep.currentTime=0; beep.play().catch(()=>{});}catch{ synthBeep(prefs.beepLen);} } else synthBeep(prefs.beepLen); }
let timer=null,endAt=0;
function schedule(){endAt=Date.now()+prefs.interval*1000;}
function updateTimer(){const remain=Math.max(0,Math.ceil((endAt-Date.now())/1000)); $("count").textContent=remain; if(remain<=0){ring(); schedule();}}
$("start").onclick=()=>{ if(timer) return; schedule(); updateTimer(); timer=setInterval(updateTimer,500); toast('è®¡æ—¶å¼€å§‹'); };
$("stop").onclick=()=>{ if(!timer) return; clearInterval(timer); timer=null; $("count").textContent=prefs.interval; toast('å·²åœæ­¢'); };
$("ping").onclick=ring;
document.addEventListener('visibilitychange',()=>{ if(timer) updateTimer(); });

// è®¾ç½®ï¼šå¤–è§‚/è®¡æ—¶
$("saveBrand").onclick=()=>{ brand.title=$("titleInput").value.trim()||'è®­ç»ƒæé†’'; brand.ver=$("verInput").value.trim()||''; brand.bg=$("bgColor").value||'#91C6FF'; save(K.brand,brand); $("appTitle").textContent=`${brand.title} ${brand.ver}`; document.body.style.backgroundColor=brand.bg; toast('å·²ä¿å­˜å¤–è§‚'); };
$("setInterval").value=prefs.interval; $("setBeepLen").value=prefs.beepLen;
$("setInterval").onchange=()=>{prefs.interval=Math.max(10,+$("setInterval").value||60); save(K.prefs,prefs); $("count").textContent=prefs.interval;};
$("setBeepLen").onchange=()=>{prefs.beepLen=Math.min(10,Math.max(1,+$("setBeepLen").value||2)); save(K.prefs,prefs);};
$("testBell").onclick=ring;

// ===== èƒŒæ™¯éŸ³ä¹ =====
const musicSel=$("musicSelect"), vbgm=$("bgmMedia");
async function tryLoadServerList(){try{const r=await fetch('music/list.json',{cache:'no-store'}); if(!r.ok) return false; const arr=await r.json(); if(!Array.isArray(arr)) return false; musicList=arr.map(n=>`music/${n}`); save(K.music,musicList); return true;}catch{return false;}}
function renderMusic(){
  musicSel.innerHTML='';
  if(!musicList.length){
    musicSel.innerHTML='<option value="">ï¼ˆæš‚æ— éŸ³ä¹ï¼‰</option>';
    $("musicHint").textContent='æœªæ‰¾åˆ° /music/list.jsonï¼Œå¯ç”¨â€œä»æœ¬åœ°æ–‡ä»¶å¤¹è¯»å–â€ï¼ˆæœ¬æœºä¼šè¯ï¼‰';
    return;
  }
  musicList.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p.split('/').pop();musicSel.appendChild(o);});
  $("musicHint").textContent='å·²è¯»å–éŸ³ä¹åˆ—è¡¨';
}
(async()=>{await tryLoadServerList(); renderMusic();})();
$("bgmPlay").onclick=()=>{const src=musicSel.value; if(!src) return toast('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ä¹'); vbgm.src=src; vbgm.play().catch(()=>toast('å…ˆç‚¹ä¸€ä¸‹é¡µé¢è§£é”éŸ³é¢‘'));};
$("bgmPause").onclick=()=>{try{vbgm.pause()}catch{}};
$("readFolder").onclick=()=>{const inp=document.createElement('input'); inp.type='file'; inp.webkitdirectory=true; inp.multiple=true; inp.accept='audio/*,video/*'; inp.onchange=()=>{const files=[...inp.files].filter(f=>/\.(mp3|m4a|wav|mp4|ogg)$/i.test(f.name)); musicList=files.map(f=>URL.createObjectURL(f)); save(K.music,musicList); renderMusic(); toast('å·²ä»æœ¬åœ°æ–‡ä»¶å¤¹ç”Ÿæˆåˆ—è¡¨ï¼ˆåˆ·æ–°åå¤±æ•ˆï¼‰');}; inp.click();};

// ===== è§†é¢‘ç®¡ç† =====
const vmList=$("vmList");
function renderVmList(){
  vmList.innerHTML='';
  const part=$("vmPart").value; const list=videos[part];
  if(!list.length){vmList.innerHTML='<div class="tiny muted">è¯¥éƒ¨ä½æš‚æ— è§†é¢‘ã€‚</div>'; refreshVideoSelect(); return;}
  list.forEach((it,i)=>{
    const row=document.createElement('div'); row.className='vm-row';
    row.innerHTML=`<span class="vm-title" title="${it.name}">${it.name}</span>
      <div>
        <button class="btn xs light">âœï¸ ç¼–è¾‘</button>
        <button class="btn xs danger">ğŸ—‘ åˆ é™¤</button>
      </div>`;
    const [editBtn,delBtn]=row.querySelectorAll('button');
    editBtn.onclick=()=>{
      const newTitle=prompt('ä¿®æ”¹æ ‡é¢˜',it.name); if(newTitle===null) return;
      const newUrl=prompt('ä¿®æ”¹é“¾æ¥',it.url); if(newUrl===null) return;
      it.name=(newTitle.trim()||'æœªå‘½å'); it.url=newUrl.trim();
      save(K.videos,videos); renderVmList(); refreshVideoSelect(); toast('å·²ä¿å­˜è¯¥æ¡è§†é¢‘');
    };
    delBtn.onclick=()=>{
      videos[part].splice(i,1); save(K.videos,videos); renderVmList(); refreshVideoSelect(); toast('å·²åˆ é™¤');
    };
    vmList.appendChild(row);
  });
}
$("vmPart").onchange=renderVmList;
$("vmAdd").onclick=()=>{const p=$("vmPart").value; const u=$("vmUrl").value.trim(); const n=$("vmName").value.trim()||'æœªå‘½å'; if(!u) return toast('è¯·å…ˆå¡«å†™é“¾æ¥'); videos[p].push({name:n,url:u}); save(K.videos,videos); $("vmUrl").value=''; $("vmName").value=''; renderVmList(); refreshVideoSelect(); toast('å·²æ·»åŠ è§†é¢‘');};

// è®­ç»ƒé¡µè§†é¢‘é€‰æ‹©
function parseEmbed(url){
  try{
    if(/youtube\.com\/watch\?v=|youtu\.be\//.test(url)){const id=url.match(/v=([^&]+)/)?.[1]||url.split('/').pop(); return `https://www.youtube.com/embed/${id}`;}
    if(/bilibili\.com\/video\/BV/i.test(url)){const bv=url.match(/\/BV[0-9A-Za-z]+/i)[0].replace('/',''); return `https://player.bilibili.com/player.html?${bv}&autoplay=1`; }
    return url;
  }catch{return url;}
}
function refreshVideoSelect(){
  const sel=$("videoSelect"); if(!sel) return;
  sel.innerHTML='';
  const list=videos[prefs.part]||[];
  if(!list.length){const o=document.createElement('option');o.value='';o.textContent='ï¼ˆè¯¥éƒ¨ä½æ²¡æœ‰å·²ä¿å­˜è§†é¢‘ï¼‰'; sel.appendChild(o); return;}
  list.forEach((it,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=it.name; sel.appendChild(o);});
}
$("playSelected").onclick=()=>{
  const sel=$("videoSelect"); const idx=+sel.value;
  const list=videos[prefs.part]; if(!list||!list[idx]) return toast('è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘');
  const url=list[idx].url;
  $("embedBox").innerHTML=`<iframe id="videoFrame" src="${parseEmbed(url)}" allow="fullscreen; autoplay; encrypted-media" allowfullscreen></iframe>`;
};
$("openSelected").onclick=()=>{
  const sel=$("videoSelect"); const idx=+sel.value; const list=videos[prefs.part]; if(!list||!list[idx]) return;
  window.open(list[idx].url,'_blank');
};
$("enterFs").onclick=()=>{
  const box=$("embedBox");
  if(box.requestFullscreen){ box.requestFullscreen().catch(()=>window.open(document.getElementById('videoFrame')?.src||'#','_blank')); }
  else if(box.webkitRequestFullscreen){ box.webkitRequestFullscreen(); }
  else { window.open(document.getElementById('videoFrame')?.src||'#','_blank'); }
};

// ===== æ—¥å¿—ï¼šè¿½åŠ  + æ’åºæ¨¡å¼ + é•¿æŒ‰åˆ é™¤ =====
let sortMode=false; // é»˜è®¤å…³é—­æ’åºæ¨¡å¼

// è§£ææ•´æ®µï¼šç¬¬ä¸€è¡Œ=æ ‡é¢˜ï¼›å…¶ä½™=å†…å®¹ï¼›å°½é‡ä»æ ‡é¢˜æŠ½å–æ—¥æœŸ
function parseLogFromFullText(fullText){
  const lines=(fullText||'').split(/\r?\n/);
  const title=(lines[0]||'').trim();
  const content=lines.slice(1).join('\n').trim();
  const m=title.match(/(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})/);
  const date=m?`${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`:new Date().toISOString().slice(0,10);
  return {title: title||date, content, date};
}

// â˜… è¿½åŠ ï¼ˆä¸è¦†ç›–ï¼‰
function appendLogFromText(fullText){
  const {title,content,date}=parseLogFromFullText(fullText);
  const entry={ id: Date.now()+Math.random(), date, title, content };
  logs.push(entry);
  save(K.logs,logs);
}

$("toggleSort").onclick=()=>{
  sortMode=!sortMode;
  $("toggleSort").textContent=`ğŸ§­ æ’åºæ¨¡å¼ï¼š${sortMode?'å¼€':'å…³'}`;
  renderLogs();
};

// é•¿æŒ‰å·¥å…·ï¼šæ‰‹æœºä¹Ÿèƒ½åˆ é™¤
function bindLongPress(el, onLongPress){
  let timer=null;
  const start=()=>{timer=setTimeout(()=>{onLongPress();},600)};
  const clear=()=>{if(timer){clearTimeout(timer); timer=null;}};
  el.addEventListener('touchstart',start,{passive:true});
  el.addEventListener('touchend',clear);
  el.addEventListener('touchmove',clear);
  el.addEventListener('mousedown',start);
  el.addEventListener('mouseup',clear);
  el.addEventListener('mouseleave',clear);
}

function renderLogs(){
  const box=$("logList"); box.innerHTML='';
  if(!logs.length){box.innerHTML='<div class="tiny muted">æš‚æ— æ—¥å¿—ã€‚å®Œæˆè®­ç»ƒæ—¶ç‚¹â€œæœ¬æ¬¡å®Œæˆâ€ä¼šè‡ªåŠ¨è¿½åŠ ï¼›ä¹Ÿå¯ç‚¹å‡»â€œæ·»åŠ æ—¥å¿—â€ã€‚</div>';return;}
  logs.forEach((log,i)=>{
    const div=document.createElement('div');
    div.className='log-item';
    div.innerHTML=`<div class="log-title">${log.title}</div>`;
    const c=document.createElement('div'); c.className='log-content hide'; c.textContent=log.content||'ï¼ˆæ— å†…å®¹ï¼‰'; div.appendChild(c);

    if(sortMode){
      const tools=document.createElement('div'); tools.className='log-tools';
      tools.innerHTML=`
        <button class="btn xs light">â¬†ï¸ ä¸Šç§»</button>
        <button class="btn xs light">â¬‡ï¸ ä¸‹ç§»</button>
        <button class="btn xs danger">ğŸ—‘ åˆ é™¤</button>
        <span class="tiny muted">æ—¥æœŸï¼š${log.date}</span>`;
      const [upBtn,downBtn,delBtn]=tools.querySelectorAll('button');
      upBtn.onclick=(e)=>{e.stopPropagation(); if(i>0){const t=logs[i-1];logs[i-1]=logs[i];logs[i]=t;save(K.logs,logs);renderLogs();}};
      downBtn.onclick=(e)=>{e.stopPropagation(); if(i<logs.length-1){const t=logs[i+1];logs[i+1]=logs[i];logs[i]=t;save(K.logs,logs);renderLogs();}};
      delBtn.onclick=(e)=>{e.stopPropagation(); if(confirm('åˆ é™¤è¿™æ¡æ—¥å¿—ï¼Ÿ')){logs.splice(i,1);save(K.logs,logs);renderLogs();}}
      div.appendChild(tools);
    }else{
      // éæ’åºæ¨¡å¼ï¼šå•å‡»å±•å¼€/æ”¶èµ·ï¼›åŒå‡»ç¼–è¾‘ï¼›é•¿æŒ‰åˆ é™¤
      div.onclick=()=>c.classList.toggle('hide');
      div.ondblclick=()=>{const nt=prompt('ç¼–è¾‘æ ‡é¢˜',log.title); if(nt===null) return; const nd=prompt('ç¼–è¾‘æ—¥æœŸ(YYYY-MM-DD)',log.date); if(nd===null) return; const nc=prompt('ç¼–è¾‘å†…å®¹',log.content||''); logs[i]={...logs[i],title:nt,date:nd||log.date,content:nc||''}; save(K.logs,logs); renderLogs();}
      bindLongPress(div,()=>{ if(confirm('é•¿æŒ‰ç¡®è®¤ï¼šåˆ é™¤è¿™æ¡æ—¥å¿—ï¼Ÿ')){logs.splice(i,1);save(K.logs,logs);renderLogs();}});
    }
    box.appendChild(div);
  });
}

// æ·»åŠ æ—¥å¿—é¢æ¿
$("toggleAddLog").onclick=()=>{const box=$("addLogBox"); box.classList.toggle('hide');};
$("addLogCancel").onclick=()=>hide("addLogBox");
$("addLogSave").onclick=()=>{
  const txt=$("addLogText").value.trim();
  if(!txt) return toast('è¯·ç²˜è´´å®Œæ•´æ—¥å¿—');
  appendLogFromText(txt);
  $("addLogText").value=''; hide("addLogBox"); renderLogs(); toast('å·²æ·»åŠ åˆ°æ—¥å¿—');
};

// ===== å¯¼å‡º / å¯¼å…¥ï¼ˆå…¨éƒ¨æ•°æ®ï¼‰ =====
$("exportAll").onclick=()=>{
  const payload={brand,prefs,plansNow,plansLast,notes,planNext,videos,musicList,logs,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="training-data.json"; a.click(); URL.revokeObjectURL(url);
  toast('å·²å¯¼å‡ºä¸º training-data.json');
};
$("importAll").onclick=()=>$("importFile").click();
$("importFile").onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const obj=JSON.parse(ev.target.result);
      if(obj.brand) {brand=obj.brand; save(K.brand,brand); $("appTitle").textContent=`${brand.title} ${brand.ver}`; document.body.style.backgroundColor=brand.bg;}
      if(obj.prefs) {prefs=obj.prefs; save(K.prefs,prefs); $("setInterval").value=prefs.interval; $("setBeepLen").value=prefs.beepLen; $("customName").value=prefs.customName;}
      if(obj.plansNow){plansNow=obj.plansNow; save(K.plansNow,plansNow);}
      if(obj.plansLast){plansLast=obj.plansLast; save(K.plansLast,plansLast);}
      if(obj.notes){notes=obj.notes; save(K.notes,notes);}
      if(obj.planNext){planNext=obj.planNext; save(K.planNext,planNext);}
      if(obj.videos){videos=obj.videos; save(K.videos,videos); renderVmList(); refreshVideoSelect();}
      if(obj.musicList){musicList=obj.musicList; save(K.music,musicList); renderMusic();}
      if(obj.logs){
        logs=obj.logs.map(it=>it.id?it:{...it,id:Date.now()+Math.random()}); // å…¼å®¹æ—  id
        save(K.logs,logs); renderLogs();
      }
      loadPartState(); updateWorkTitle();
      toast('å¯¼å…¥æˆåŠŸï¼Œå·²è¦†ç›–æœ¬åœ°æ•°æ®');
    }catch(e){alert("å¯¼å…¥å¤±è´¥ï¼šJSON ä¸åˆæ³•");}
  };
  reader.readAsText(file);
};

// ===== å¯åŠ¨é»˜è®¤é¡µ =====
function refreshVideoSelect(){ // å®šä¹‰ä¸€æ¬¡ï¼Œåˆ«å†è¦†ç›–
  const sel=$("videoSelect"); if(!sel) return;
  sel.innerHTML='';
  const list=videos[prefs.part]||[];
  if(!list.length){const o=document.createElement('option');o.value='';o.textContent='ï¼ˆè¯¥éƒ¨ä½æ²¡æœ‰å·²ä¿å­˜è§†é¢‘ï¼‰'; sel.appendChild(o); return;}
  list.forEach((it,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=it.name; sel.appendChild(o);});
}

setActive('home'); setSub('last'); renderLogs();
})();
</script>
</body>
</html>
