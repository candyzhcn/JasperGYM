<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#91C6FF"/>
<title>è®­ç»ƒæé†’ Â· åˆ†é¡µç‰ˆ</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#91C6FF; --panel:#ffffff; --ink:#111; --muted:#5b616a;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --border:#d1d5db; --field:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
a{color:var(--brand);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:12px 14px 120px}
.header{
  position:sticky;top:0;z-index:10;background:linear-gradient(#91C6FF, #91C6FFcc 80%, transparent);
  padding:10px 0 4px
}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 10px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.controls{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
select,input[type="text"],input[type="number"],input[type="color"],textarea{
  width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none
}
textarea{min-height:160px;resize:vertical}
.bigtext{min-height:280px;max-height:540px;overflow:auto}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
.btn.danger{background:var(--danger);color:#fff}
.btn.xs{padding:6px 10px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.muted{color:var(--muted)} .tiny{font-size:12px}
.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;
  padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}
hr.sep{border:none;border-top:1px dashed var(--border);margin:8px 0}
.grid2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}

/* é¦–é¡µå•é€‰å¡ç‰‡ */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
.choice input{transform:scale(1.2)}

/* è®­ç»ƒé¡µåˆ†é¡µ */
.subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 2px}
.subtab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 12px;cursor:pointer}
.subtab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

/* è§†é¢‘åˆ—è¡¨ + æ’­æ”¾åŒº */
.video-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
.video-item{display:flex;gap:8px;align-items:center;background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:8px}
.vi-name{flex:1 1 auto;background:transparent;border:none;color:var(--ink);padding:6px 8px;border-radius:8px}
.embed{width:100%;min-height:480px;aspect-ratio:16/9;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#000}
iframe{width:100%;height:100%;border:0}

/* è®¡æ—¶æ˜¾ç¤ºï¼ˆè®­ç»ƒé¡µï¼‰ */
.timer{font-size:40px;font-weight:800;letter-spacing:1px}
</style>
</head>
<body>
<div class="wrap">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">è®­ç»ƒæé†’ v3.12</div>
      <div class="tabs">
        <div class="tab active" data-page="home">ğŸ  é¦–é¡µ</div>
        <div class="tab" data-page="work">ğŸ‹ï¸ è®­ç»ƒ</div>
        <div class="tab" data-page="settings">âš™ï¸ è®¾ç½®</div>
      </div>
    </div>
  </div>

  <!-- é¦–é¡µ -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">ä»Šå¤©è®­ç»ƒä»€ä¹ˆï¼Ÿ</div>
      <div class="choices">
        <label class="choice"><input type="radio" name="part" value="legs">è…¿</label>
        <label class="choice"><input type="radio" name="part" value="chest">èƒ¸</label>
        <label class="choice"><input type="radio" name="part" value="back">èƒŒ</label>
        <label class="choice"><input type="radio" name="part" value="shoulders">è‚©</label>
        <label class="choice"><input type="radio" name="part" value="core">æ ¸å¿ƒ</label>
        <label class="choice"><input type="radio" name="part" value="custom">è‡ªå®šä¹‰</label>
      </div>
      <div class="row auto" style="margin-top:12px">
        <div class="field"><label>è‡ªå®šä¹‰éƒ¨ä½åç§°</label><input id="customName" type="text" placeholder="å¦‚ï¼šå…¨èº«å¾ªç¯ / æŠ€æœ¯ç»ƒä¹ "></div>
        <button class="btn brand" id="btnStart">è¿›å…¥è®­ç»ƒé¡µ</button>
      </div>
    </div>
  </div>

  <!-- è®­ç»ƒé¡µ -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle"><span id="workTitle">è®­ç»ƒ</span> Â· æ§åˆ¶å°</div>
      <div class="row controls">
        <div class="field">
          <label>å½“å‰éƒ¨ä½</label>
          <select id="workPart">
            <option value="legs">è…¿</option><option value="chest">èƒ¸</option>
            <option value="back">èƒŒ</option><option value="shoulders">è‚©</option>
            <option value="core">æ ¸å¿ƒ</option><option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </div>
        <div class="field">
          <label>ä¼‘æ¯é—´éš”ï¼ˆç§’ï¼‰</label>
          <input id="interval" type="number" min="10" step="5"/>
        </div>
        <div class="field">
          <label>å“é“ƒæ—¶é•¿ï¼ˆç§’ï¼‰</label>
          <input id="beepLen" type="number" min="1" max="10"/>
          <div class="tiny muted">é“ƒå£°æ–‡ä»¶ï¼š/bell.mp3 æˆ– /bell.mp4</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted tiny">å€’è®¡æ—¶</div>
          <div class="timer"><span id="count">60</span>s</div>
        </div>
        <div class="row auto" style="max-width:420px">
          <button class="btn brand" id="start">â–¶ï¸ å¼€å§‹</button>
          <button class="btn danger" id="stop">â¹ åœæ­¢</button>
          <button class="btn ghost" id="ping">ğŸ”” è¯•é“ƒ</button>
        </div>
      </div>
    </div>

    <div class="subtabs">
      <div class="subtab active" data-sub="last">â‘  ä¸Šæ¬¡è®°å½•</div>
      <div class="subtab" data-sub="now">â‘¡ æœ¬æ¬¡è®¡åˆ’</div>
      <div class="subtab" data-sub="video">â‘¢ è§†é¢‘å‚è€ƒ</div>
      <div class="subtab" data-sub="next">â‘£ ä¸‹æ¬¡å±•æœ›</div>
    </div>

    <!-- ä¸Šæ¬¡ -->
    <div id="sub-last">
      <div class="card">
        <div class="sectionTitle">ä¸Šæ¬¡è®­ç»ƒè®¡åˆ’ & æ„Ÿå—ï¼ˆåªè¯»ï¼‰</div>
        <textarea id="planLast" class="bigtext" readonly></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ghost" id="copyToNow">â¬…ï¸ å¤åˆ¶ä¸ºæœ¬æ¬¡è®¡åˆ’</button>
          <button class="btn warn" id="clearLast">ğŸ§¹ æ¸…ç©ºä¸Šæ¬¡</button>
        </div>
      </div>
    </div>

    <!-- æœ¬æ¬¡ -->
    <div id="sub-now" class="hide">
      <div class="card">
        <div class="sectionTitle">æœ¬æ¬¡è®­ç»ƒé¢„è®¡è®¡åˆ’ & é‡é‡å»ºè®®</div>
        <textarea id="planNow" class="bigtext" placeholder="åœ¨è¿™é‡Œå†™ä»Šå¤©è¦åšçš„å†…å®¹ã€ç›®æ ‡ç»„æ¬¡/æ¬¡æ•°ã€é‡é‡åŒºé—´â€¦"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNow">ğŸ’¾ ä¿å­˜æœ¬æ¬¡</button>
          <button class="btn brand" id="saveToLast">âœ… æœ¬æ¬¡å®Œæˆ â†’ å­˜ä¸ºâ€œä¸Šæ¬¡â€</button>
        </div>
      </div>
      <div class="card">
        <div class="sectionTitle">åŠ¨ä½œæ³¨æ„äº‹é¡¹ï¼ˆä¼šéšéƒ¨ä½åˆ†åˆ«ä¿å­˜ï¼‰</div>
        <textarea id="notes" class="bigtext" placeholder="è¦ç‚¹/å‘¼å¸/è½ç‚¹/èŠ‚å¥/æ³¨æ„å±é™©ä¿¡å·â€¦"></textarea>
        <div class="tiny muted">è‡ªåŠ¨ä¿å­˜</div>
      </div>
    </div>

    <!-- è§†é¢‘ -->
    <div id="sub-video" class="hide">
      <div class="card">
        <div class="sectionTitle">è®­ç»ƒè§†é¢‘å‚è€ƒï¼ˆæŒ‰éƒ¨ä½ä¿å­˜ï¼‰</div>
        <div class="row auto">
          <div class="field">
            <label>ç²˜è´´é“¾æ¥ï¼ˆYouTube/Bç«™ï¼‰</label>
            <input id="vUrl" type="text" placeholder="https://...">
          </div>
          <div class="field">
            <label>è‡ªå®šä¹‰æ ‡é¢˜</label>
            <input id="vName" type="text" placeholder="å¦‚ï¼šè…¿æ—¥çƒ­èº«-é«‹è†è¸æ¿€æ´»">
          </div>
          <button class="btn ok" id="addVideo">æ·»åŠ </button>
        </div>
        <div id="vList" class="video-list" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <div class="sectionTitle">æ’­æ”¾åŒºï¼ˆå¯å…¨å±ï¼‰</div>
        <div class="embed" id="embedBox"><div class="muted tiny" style="padding:10px">æœªé€‰æ‹©è§†é¢‘</div></div>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ghost" id="enterFs">â›¶ å…¨å±</button>
        </div>
      </div>
    </div>

    <!-- ä¸‹æ¬¡ -->
    <div id="sub-next" class="hide">
      <div class="card">
        <div class="sectionTitle">ä¸‹ä¸€æ¬¡è®­ç»ƒæ—¥çš„å±•æœ›è®¡åˆ’</div>
        <textarea id="planNext" class="bigtext" placeholder="å†™ä¸‹æ¬¡è¦æå‡çš„é‡é‡ã€åŠ¨ä½œé¡ºåºè°ƒæ•´ã€å®¹é‡/å¼ºåº¦ç­–ç•¥â€¦"></textarea>
        <div class="row auto" style="margin-top:8px">
          <button class="btn ok" id="saveNext">ğŸ’¾ ä¿å­˜</button>
          <button class="btn warn" id="clearNext">ğŸ§¹ æ¸…ç©º</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®é¡µ -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle">å¤–è§‚ / æ ‡è¯†</div>
      <div class="row auto">
        <div class="field"><label>è‡ªå®šä¹‰æ ‡é¢˜</label><input id="titleInput" type="text" placeholder="å¦‚ï¼šJasper è®­ç»ƒè®¡åˆ’"></div>
        <div class="field"><label>è‡ªå®šä¹‰ç‰ˆæœ¬å·</label><input id="verInput" type="text" placeholder="å¦‚ï¼šv3.12"></div>
        <div class="field"><label>èƒŒæ™¯é¢œè‰²</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand">ğŸ’¾ ä¿å­˜æ ‡é¢˜/ç‰ˆæœ¬/èƒŒæ™¯</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">è®¡æ—¶ / é“ƒå£°</div>
      <div class="row auto">
        <div class="field"><label>ä¼‘æ¯é—´éš”ï¼ˆç§’ï¼‰</label><input id="setInterval" type="number" min="10" step="5"></div>
        <div class="field"><label>å“é“ƒæ—¶é•¿ï¼ˆç§’ï¼‰</label><input id="setBeepLen" type="number" min="1" max="10"></div>
        <button class="btn ghost" id="testBell">ğŸ”” è¯•æ”¾é“ƒå£°</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">èƒŒæ™¯éŸ³ä¹</div>
      <div class="row auto">
        <div class="field">
          <label>éŸ³ä¹åˆ—è¡¨ï¼ˆè¯»å– /music/list.json æˆ–ä»æœ¬åœ°æ–‡ä»¶å¤¹ï¼‰</label>
          <select id="musicSelect"></select>
          <div class="tiny muted" id="musicHint">ä¼˜å…ˆè¯»å– /music/list.jsonï¼›æ²¡æœ‰å°±ç‚¹å‡»â€œä»æœ¬åœ°æ–‡ä»¶å¤¹è¯»å–â€</div>
        </div>
        <div class="field">
          <label>æ“ä½œ</label>
          <div class="row auto">
            <button class="btn ok" id="bgmPlay">â–¶ï¸ æ’­æ”¾</button>
            <button class="btn danger" id="bgmPause">â¸ æš‚åœ</button>
            <button class="btn ghost" id="readFolder">ğŸ“‚ ä»æœ¬åœ°æ–‡ä»¶å¤¹è¯»å–</button>
          </div>
        </div>
        <div class="field">
          <label>éŸ³é‡</label>
          <div class="row auto">
            <input type="range" id="bgmVol" min="0" max="1" step="0.01" value="0.5">
            <div class="tiny muted" id="bgmVolTxt">0.50</div>
          </div>
        </div>
      </div>
      <video id="bgmMedia" preload="auto" loop style="display:none"></video>
    </div>
  </div>
</div>

<!-- éŸ³é¢‘ -->
<audio id="beepAudio" preload="auto"></audio>
<div id="toast" class="toast"></div>

<script>
(()=>{
// ====== å·¥å…· ======
const $=id=>document.getElementById(id);
const show=(id)=>$(id).classList.remove('hide');
const hide=(id)=>$(id).classList.add('hide');
const toast=(m)=>{const t=$("toast");t.textContent=m;t.style.opacity=0;t.style.display='block';requestAnimationFrame(()=>t.style.opacity=1);setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.style.display='none',200)},1600);}
const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const K={
  prefs:'pg_prefs_v1',
  plansNow:'pg_now_v1', plansLast:'pg_last_v1',
  notes:'pg_notes_v1', planNext:'pg_next_v1',
  videos:'pg_videos_v1', brand:'pg_brand_v1',
  music:'pg_music_v1'
};
// ====== çŠ¶æ€ä¸é»˜è®¤ ======
let brand=load(K.brand,{title:'è®­ç»ƒæé†’',ver:'v3.12',bg:'#91C6FF'});
let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs',customName:''});
let plansNow=load(K.plansNow,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let plansLast=load(K.plansLast,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let notes=load(K.notes,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let planNext=load(K.planNext,{legs:'',chest:'',back:'',shoulders:'',core:'',custom:''});
let videos=load(K.videos,{legs:[],chest:[],back:[],shoulders:[],core:[],custom:[]});
let musicList=load(K.music,[]);

document.body.style.backgroundColor=brand.bg;
$("appTitle").textContent=`${brand.title} ${brand.ver}`;
$("titleInput").value=brand.title; $("verInput").value=brand.ver; $("bgColor").value=brand.bg;

function setActiveTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.page===name));
  ['page-home','page-work','page-settings'].forEach(id=>hide(id));
  show(`page-${name}`);
}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>setActiveTab(t.dataset.page));

// é¦–é¡µé€‰æ‹©
document.querySelectorAll('input[name="part"]').forEach(r=>{
  r.checked = (r.value===prefs.part);
  r.onchange=()=>{prefs.part=r.value; save(K.prefs,prefs);}
});
$("customName").value=prefs.customName;
$("customName").oninput=()=>{prefs.customName=$("customName").value.trim(); save(K.prefs,prefs);};

$("btnStart").onclick=()=>{
  setActiveTab('work');
  $("workPart").value=prefs.part;
  $("workTitle").textContent=(prefs.part==='custom'?(prefs.customName||'è‡ªå®šä¹‰'):{"legs":"è…¿","chest":"èƒ¸","back":"èƒŒ","shoulders":"è‚©","core":"æ ¸å¿ƒ"}[prefs.part])+' Â· æ§åˆ¶å°';
  $("interval").value=prefs.interval; $("beepLen").value=prefs.beepLen;
  loadPartState();
};

// è®­ç»ƒé¡µï¼šéƒ¨ä½åˆ‡æ¢
$("workPart").onchange=()=>{prefs.part=$("workPart").value; save(K.prefs,prefs); loadPartState();};
function loadPartState(){
  $("planNow").value=plansNow[prefs.part]||'';
  $("planLast").value=plansLast[prefs.part]||'';
  $("notes").value=notes[prefs.part]||'';
  $("planNext").value=planNext[prefs.part]||'';
  renderVideo();
}

// è®­ç»ƒé¡µï¼šå­åˆ†é¡µ
function setSub(name){
  document.querySelectorAll('.subtab').forEach(s=>s.classList.toggle('active',s.dataset.sub===name));
  ['sub-last','sub-now','sub-video','sub-next'].forEach(id=>hide(id));
  show(`sub-${name}`);
}
document.querySelectorAll('.subtab').forEach(s=>s.onclick=()=>setSub(s.dataset.sub));

// è®­ç»ƒé¡µï¼šæ–‡æœ¬ä¿å­˜
$("saveNow").onclick=()=>{plansNow[prefs.part]=$("planNow").value.trim(); save(K.plansNow,plansNow); toast('å·²ä¿å­˜æœ¬æ¬¡');};
$("saveToLast").onclick=()=>{plansLast[prefs.part]=$("planNow").value.trim(); save(K.plansLast,plansLast); $("planLast").value=plansLast[prefs.part]; toast('å·²ä¿å­˜ä¸ºä¸Šæ¬¡');};
$("copyToNow").onclick=()=>{$("planNow").value=$("planLast").value; $("saveNow").click();};
$("clearLast").onclick=()=>{ if(!confirm('æ¸…ç©ºä¸Šæ¬¡è®°å½•ï¼Ÿ'))return; plansLast[prefs.part]=''; save(K.plansLast,plansLast); $("planLast").value=''; };
$("saveNext").onclick=()=>{planNext[prefs.part]=$("planNext").value.trim(); save(K.planNext,planNext); toast('å·²ä¿å­˜');};
$("clearNext").onclick=()=>{ if(!confirm('æ¸…ç©ºä¸‹ä¸€æ¬¡å±•æœ›ï¼Ÿ'))return; planNext[prefs.part]=''; save(K.planNext,planNext); $("planNext").value='';};
$("notes").oninput=()=>{clearTimeout(window.__noteDeb); window.__noteDeb=setTimeout(()=>{notes[prefs.part]=$("notes").value.trim(); save(K.notes,notes);},500);};

// è®¡æ—¶/é“ƒå£°
$("interval").onchange=()=>{prefs.interval=Math.max(10,+$("interval").value||60); save(K.prefs,prefs); $("count").textContent=prefs.interval;}
$("beepLen").onchange=()=>{prefs.beepLen=Math.min(10,Math.max(1,+$("beepLen").value||2)); save(K.prefs,prefs);}
const beep=$("beepAudio");
(async()=>{try{const r=await fetch('bell.mp3',{method:'HEAD'}); if(r.ok){beep.src='bell.mp3';return;}}catch{} try{const r2=await fetch('bell.mp4',{method:'HEAD'}); if(r2.ok){beep.src='bell.mp4';}}catch{} })();
let audioCtx=null; function ensureCtx(){ if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC();}}
function synthBeep(sec){try{ensureCtx(); if(!audioCtx) return; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine';o.frequency.value=880;o.connect(g);g.connect(audioCtx.destination); g.gain.value=.2;o.start();setTimeout(()=>o.stop(),(sec||2)*1000);}catch{}}
function userUnlock(){try{ensureCtx(); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); beep.play().then(()=>beep.pause()).catch(()=>{});}catch{}}
['click','touchstart'].forEach(e=>document.addEventListener(e,userUnlock,{once:true}));
function playBeep(){ if(beep.src){ try{beep.currentTime=0; beep.play().catch(()=>{});}catch{ synthBeep(prefs.beepLen);} } else synthBeep(prefs.beepLen); }
$("ping").onclick=playBeep;

let timer=null,endAt=0;
function scheduleNext(){endAt=Date.now()+ (prefs.interval*1000);}
function updateTimer(){const remain=Math.max(0,Math.ceil((endAt-Date.now())/1000)); $("count").textContent=remain; if(remain<=0){playBeep(); scheduleNext();}}
$("start").onclick=()=>{ if(timer) return; scheduleNext(); updateTimer(); timer=setInterval(updateTimer,500); toast('è®¡æ—¶å¼€å§‹'); };
$("stop").onclick=()=>{ if(!timer) return; clearInterval(timer); timer=null; $("count").textContent=prefs.interval; toast('å·²åœæ­¢'); };
document.addEventListener('visibilitychange',()=>{ if(timer) updateTimer(); });

// è§†é¢‘
function parseEmbed(url){
  try{
    if(/youtube\.com\/watch\?v=|youtu\.be\//.test(url)){ const id=url.match(/v=([^&]+)/)?.[1]||url.split('/').pop(); return `https://www.youtube.com/embed/${id}`;}
    if(/bilibili\.com\/video\/BV/i.test(url)){const bv=url.match(/\/BV[0-9A-Za-z]+/i)[0].replace('/',''); return `https://player.bilibili.com/player.html?${bv}&autoplay=1`; }
    return url;
  }catch{return url;}
}
function renderVideo(){
  const host=$("vList"); host.innerHTML='';
  videos[prefs.part].forEach((it,i)=>{
    const row=document.createElement('div'); row.className='video-item';
    const name=document.createElement('input'); name.className='vi-name'; name.value=it.name; name.onchange=()=>{it.name=name.value.trim()||'æœªå‘½å'; save(K.videos,videos);}
    const play=document.createElement('button'); play.className='btn ok xs'; play.textContent='æ’­æ”¾'; play.onclick=()=>{$("embedBox").innerHTML=`<iframe src="${parseEmbed(it.url)}" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;}
    const open=document.createElement('a'); open.className='btn ghost xs'; open.textContent='æ‰“å¼€'; open.href=it.url; open.target='_blank';
    const del=document.createElement('button'); del.className='btn danger xs'; del.textContent='åˆ é™¤'; del.onclick=()=>{videos[prefs.part].splice(i,1); save(K.videos,videos); renderVideo();}
    row.append(name,play,open,del); host.appendChild(row);
  });
}
$("addVideo").onclick=()=>{ const u=$("vUrl").value.trim(); const n=($("vName").value.trim()||'æœªå‘½å'); if(!u) return; videos[prefs.part].push({name:n,url:u}); save(K.videos,videos); $("vUrl").value=""; $("vName").value=""; renderVideo();};
$("enterFs").onclick=()=>{ const box=$("embedBox"); if(box.requestFullscreen) box.requestFullscreen(); else if(box.webkitRequestFullscreen) box.webkitRequestFullscreen(); };

// è®¾ç½®ï¼šæ ‡é¢˜/ç‰ˆæœ¬/èƒŒæ™¯
$("saveBrand").onclick=()=>{ brand.title=$("titleInput").value.trim()||'è®­ç»ƒæé†’'; brand.ver=$("verInput").value.trim()||''; brand.bg=$("bgColor").value||'#91C6FF'; save(K.brand,brand); $("appTitle").textContent=`${brand.title} ${brand.ver}`; document.body.style.backgroundColor=brand.bg; toast('å·²ä¿å­˜å¤–è§‚'); };

// è®¾ç½®ï¼šè®¡æ—¶
$("setInterval").value=prefs.interval; $("setBeepLen").value=prefs.beepLen;
$("setInterval").onchange=()=>{prefs.interval=Math.max(10,+$("setInterval").value||60); save(K.prefs,prefs); $("interval").value=prefs.interval; $("count").textContent=prefs.interval;};
$("setBeepLen").onchange=()=>{prefs.beepLen=Math.min(10,Math.max(1,+$("setBeepLen").value||2)); save(K.prefs,prefs); $("beepLen").value=prefs.beepLen;};
$("testBell").onclick=playBeep;

// è®¾ç½®ï¼šéŸ³ä¹
const musicSel=$("musicSelect"), vbgm=$("bgmMedia");
async function tryLoadServerList(){
  try{ const r=await fetch('music/list.json',{cache:'no-store'}); if(!r.ok) return false;
       const arr=await r.json(); if(!Array.isArray(arr)) return false; musicList=arr.map(n=>`music/${n}`); save(K.music,musicList); return true;
  }catch{return false;}
}
function renderMusic(){ musicSel.innerHTML=''; if(!musicList.length){const o=document.createElement('option');o.value='';o.textContent='ï¼ˆæš‚æ— éŸ³ä¹ï¼‰';musicSel.appendChild(o);return;} musicList.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p.split('/').pop();musicSel.appendChild(o);});}
(async()=>{ const ok=await tryLoadServerList(); renderMusic(); $("musicHint").textContent= ok?'å·²è¯»å– /music/list.json':'æœªæ‰¾åˆ° /music/list.jsonï¼Œå¯ç”¨â€œä»æœ¬åœ°æ–‡ä»¶å¤¹è¯»å–â€ï¼ˆæœ¬æœºä¼šè¯ï¼‰'; })();
$("bgmPlay").onclick=()=>{ const src=musicSel.value; if(!src) return toast('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ä¹'); vbgm.src=src; vbgm.volume=+$("bgmVol").value; vbgm.play().catch(()=>toast('å…ˆç‚¹ä¸€ä¸‹é¡µé¢è§£é”éŸ³é¢‘')); };
$("bgmPause").onclick=()=>{ try{vbgm.pause()}catch{} };
$("bgmVol").oninput=()=>{ vbgm.volume=+$("bgmVol").value; $("bgmVolTxt").textContent=(+$("bgmVol").value).toFixed(2); };
$("readFolder").onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.webkitdirectory=true; inp.multiple=true; inp.accept='audio/*,video/*';
  inp.onchange=()=>{ const files=[...inp.files].filter(f=>/\.(mp3|m4a|wav|mp4|ogg)$/i.test(f.name)); musicList=files.map(f=>URL.createObjectURL(f)); save(K.music,musicList); renderMusic(); toast('å·²ä»æœ¬åœ°æ–‡ä»¶å¤¹ç”Ÿæˆåˆ—è¡¨ï¼ˆåˆ·æ–°åå¤±æ•ˆï¼‰'); }; inp.click(); };

// é»˜è®¤ï¼šå±•ç¤ºé¦–é¡µ
setActiveTab('home'); setSub('last');
})();
</script>
</body>
</html>
