<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#4285F4"/>
<title>è®­ç»ƒæé†’ Â· v3.32</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192-jia-rounded-fix.png" sizes="192x192" type="image/png">
<link rel="icon" href="icon-512-jia-rounded-fix.png" sizes="512x512" type="image/png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
:root{
  --bg:#91C6FF; --panel:#ffffff; --ink:#111; --muted:#5b616a;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --border:#d1d5db; --field:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
.header{padding:8px 0 6px}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer;
     user-select:none;display:flex;gap:8px;align-items:center}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.tab img.ico{width:20px;height:20px;object-fit:contain;display:block}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 12px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type="text"],input[type="number"],input[type="color"],textarea{
  width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none
}
textarea{min-height:140px;resize:vertical}
.bigtext{min-height:300px}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.btn.light{background:transparent;border:1px solid var(--border);color:#111}
.btn.danger{background:var(--danger);color:#fff}
.btn.xs{padding:6px 10px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.muted{color:var(--muted)} .tiny{font-size:12px}
.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;
  padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}

/* é¦–é¡µ */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer}
.choice input{transform:scale(1.2)}
.choice:hover{border-color:var(--brand)}
.choice .name{font-weight:700}
.customOps{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.customTag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:6px 10px;border-radius:999px}

/* è®­ç»ƒé¡µ */
.timer{font-size:36px;font-weight:800;letter-spacing:1px}
.video-player{margin-top:8px}
#videoContainer{width:100%; height:720px; background:#000; border-radius:12px; overflow:hidden; border:1px solid var(--border)}
#videoIframe, #videoHtml5{width:100%; height:100%; border:0; display:none}
#videoFallback{display:none; color:#fff; padding:12px}
@media (max-width: 1024px){ #videoContainer{height:560px} }
@media (max-width: 640px){ #videoContainer{height:480px} }
@media (max-width: 420px){ #videoContainer{height:360px} }
.notice{margin-top:12px;padding:12px;border:1px dashed #cbd5e1;border-radius:10px;background:#f8fafc;white-space:pre-wrap}
.boxTitle{font-weight:700;margin:6px 0 6px}
textarea.padded{line-height:1.7}

/* æ—¥å¿— */
.filterRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.log-item{padding:14px 10px;border-bottom:1px solid var(--border);border-radius:8px;margin-bottom:8px}
.log-title{font-weight:700;cursor:pointer;margin-bottom:4px}
.log-meta{font-size:12px;color:#64748b;margin-bottom:6px}
.log-content{margin-top:6px;white-space:pre-wrap;word-break:break-word;line-height:1.7}
</style>
</head>
<body>
<div class="wrap">
  <!-- é¡¶éƒ¨ -->
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">è®­ç»ƒæé†’ Â· v3.32</div>
      <div class="tabs">
        <div class="tab active" data-page="home"><img src="å•†åŸ.png" class="ico" alt=""><span>é¦–é¡µ</span></div>
        <div class="tab" data-page="work"><img src="ç‚¹èµ.png" class="ico" alt=""><span>è®­ç»ƒ</span></div>
        <div class="tab" data-page="logs"><img src="æ—¥å†.png" class="ico" alt=""><span>æ—¥å¿—</span></div>
        <div class="tab" data-page="settings"><img src="è®¾ç½®.png" class="ico" alt=""><span>è®¾ç½®</span></div>
      </div>
    </div>
  </div>

  <!-- é¦–é¡µ -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">ä»Šå¤©è®­ç»ƒä»€ä¹ˆï¼Ÿ</div>
      <div class="choices" id="homeChoices"></div>
      <div class="row auto" style="margin-top:10px">
        <div class="tiny muted">é€‰æ‹©åç‚¹å‡»å¼€å§‹ï¼›â€œè®¾ç½®â†’è§†é¢‘ç®¡ç†â€ç»´æŠ¤å„éƒ¨ä½çš„è§†é¢‘ä¸æ³¨æ„äº‹é¡¹ã€‚</div>
        <button class="btn brand" id="btnStart" type="button">è¿›å…¥è®­ç»ƒé¡µ</button>
      </div>

      <div style="margin-top:10px">
        <button class="btn light" id="btnManageCustom" type="button">ç®¡ç†è‡ªå®šä¹‰</button>
        <div id="customMgr" class="hide card" style="margin:10px 0 0">
          <div class="row auto">
            <div class="field"><label>æ–°å¢è‡ªå®šä¹‰éƒ¨ä½</label>
              <input id="newCustomName" type="text" placeholder="å¦‚ï¼šå°è…¿ã€è‡€å¤–ä¾§â€¦">
            </div>
            <button class="btn ok" id="addCustom" type="button">æ·»åŠ </button>
          </div>
          <div id="customList" class="customOps"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- è®­ç»ƒé¡µ -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle">æœ¬æ¬¡è®­ç»ƒ</div>
      <div class="row auto">
        <div class="field"><label>è®­ç»ƒéƒ¨ä½</label>
          <select id="workPart"></select>
        </div>
        <div class="field"><label>å€’è®¡æ—¶</label><div class="timer" id="timer">00:00</div></div>
      </div>

      <div class="row auto" style="margin-top:8px">
        <div>
          <div class="boxTitle">ä¸Šæ¬¡è®­ç»ƒ</div>
          <textarea id="txtPrev" class="padded" placeholder="è®°å½•ä¸Šä¸€æ¬¡è®­ç»ƒè¦ç‚¹â€¦"></textarea>
        </div>
        <div>
          <div class="boxTitle">æœ¬æ¬¡è®­ç»ƒ</div>
          <textarea id="txtCurr" class="padded" placeholder="å†™ä¸‹ä»Šå¤©çš„è®­ç»ƒè®¡åˆ’/é‡é‡/ç»„æ•°â€¦"></textarea>
        </div>
        <div>
          <div class="boxTitle">ä¸‹æ¬¡å±•æœ›</div>
          <textarea id="txtNext" class="padded" placeholder="å¯¹ä¸‹æ¬¡è®­ç»ƒçš„ç›®æ ‡/æé†’â€¦"></textarea>
        </div>
      </div>

      <div class="row auto" style="margin-top:8px">
        <button class="btn ok" id="btnStartTimer" type="button">å¼€å§‹å€’è®¡æ—¶</button>
        <button class="btn light" id="btnStopTimer" type="button">åœæ­¢</button>
        <button class="btn light" id="btnResetTimer" type="button">é‡ç½®</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">å‚è€ƒè§†é¢‘</div>
      <div class="row auto">
        <div class="field"><label>é€‰æ‹©è§†é¢‘</label><select id="videoSelect"></select></div>
        <a id="openVideo" class="btn light" target="_blank" href="#">æ‰“å¼€è§†é¢‘</a>
      </div>
      <div class="video-player">
        <div id="videoContainer">
          <iframe id="videoIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          <video id="videoHtml5" controls></video>
          <div id="videoFallback" class="tiny">æš‚æ— è§†é¢‘</div>
        </div>
      </div>
      <div class="notice" id="partNotice">æš‚æ— æ³¨æ„äº‹é¡¹</div>
    </div>
  </div>

  <!-- æ—¥å¿—é¡µ -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">è®­ç»ƒæ—¥å¿—</div>
      <div class="filterRow">
        <label>ç­›é€‰éƒ¨ä½</label>
        <select id="logFilter"></select>
        <button class="btn ok" id="toggleAddLog" type="button">â• æ·»åŠ æ—¥å¿—</button>
      </div>

      <div id="addLogBox" class="hide card" style="margin-top:10px">
        <div class="row auto">
          <div class="field"><label>éƒ¨ä½</label><select id="logPart"></select></div>
          <div class="field" style="grid-column:1/-1"><label>æ—¥å¿—å†…å®¹</label><textarea id="addLogText" class="bigtext" placeholder="ç¬¬ä¸€è¡Œå°†ä½œä¸ºæ ‡é¢˜ï¼Œä»¥ä¸‹ä¸ºæ­£æ–‡ï¼ˆæ”¯æŒå¤šæ®µï¼‰"></textarea></div>
        </div>
        <div class="row auto">
          <button class="btn ok" id="addLogSave" type="button">ä¿å­˜æ—¥å¿—</button>
          <button class="btn light" id="addLogCancel" type="button">å–æ¶ˆ</button>
        </div>
      </div>

      <div id="logList" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- è®¾ç½®é¡µ -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle">å¤–è§‚ / æ ‡è¯†</div>
      <div class="row auto">
        <div class="field"><label>è‡ªå®šä¹‰æ ‡é¢˜</label><input id="titleInput" type="text" placeholder="å¦‚ï¼šJasperGYM"></div>
        <div class="field"><label>ç‰ˆæœ¬å·</label><input id="verInput" type="text" placeholder="å¦‚ï¼šv3.32"></div>
        <div class="field"><label>èƒŒæ™¯é¢œè‰²</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand" type="button">ä¿å­˜å¤–è§‚</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle" id="vmTitle">ï¼ˆé€‰æ‹©éƒ¨ä½ï¼‰è§†é¢‘ & æ³¨æ„äº‹é¡¹</div>
      <div class="row auto">
        <div class="field"><label>éƒ¨ä½</label><select id="vmPart"></select></div>
        <div class="field"><label>åç§°</label><input id="vmName" type="text" placeholder="å¦‚ï¼šæ·±è¹²åŠ¨ä½œè®²è§£"></div>
        <div class="field"><label>é“¾æ¥</label><input id="vmUrl" type="text" placeholder="https://â€¦ï¼ˆYouTube/MP4/é“¾æ¥ï¼‰"></div>
        <button class="btn ok" id="vmAdd" type="button">æ·»åŠ /æ›´æ–°</button>
      </div>
      <div class="row auto" style="margin-top:10px">
        <div class="field" style="grid-column:1/-1">
          <label>è¯¥éƒ¨ä½ã€Œè®­ç»ƒæ³¨æ„äº‹é¡¹ã€</label>
          <textarea id="vmNotes" placeholder="è¦ç‚¹/å‘åŠ›/å¸¸è§é”™è¯¯â€¦ ä¸€è¡Œä¸€æ¡äº¦å¯"></textarea>
        </div>
        <button class="btn ok" id="saveNotes" type="button">ä¿å­˜æ³¨æ„äº‹é¡¹</button>
      </div>
      <div id="vmList" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">æ•°æ®ç®¡ç†</div>
      <div class="row auto">
        <button class="btn ok" id="exportAll" type="button">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
        <input type="file" id="importFile" class="hide" accept=".json"/>
        <button class="btn warn" id="importAll" type="button">ğŸ“¥ å¯¼å…¥æ•°æ®ï¼ˆè¦†ç›–æœ¬åœ°ï¼‰</button>
        <button class="btn danger" id="wipeAll" type="button">ğŸ—‘ æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼ˆä¸å¯æ¢å¤ï¼‰</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">å€’è®¡æ—¶è®¾ç½®</div>
      <div class="row auto">
        <div class="field"><label>æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰</label>
          <input id="intervalInput" type="number" min="10" max="999" step="1" value="60"/>
        </div>
        <div class="field"><label>æç¤ºéŸ³é•¿åº¦ï¼ˆç§’ï¼‰</label>
          <input id="beepLen" type="number" min="1" max="10" step="1" value="2"/>
        </div>
        <button class="btn ok" id="saveTimerPref" type="button">ä¿å­˜è®¡æ—¶è®¾ç½®</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">èƒŒæ™¯éŸ³ä¹ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰</div>
      <div class="row auto">
        <input id="bgmFile" type="file" accept="audio/*">
        <button class="btn ok" id="saveBgm" type="button">ä¿å­˜å¹¶å¯ç”¨</button>
        <select id="bgmAuto"><option value="0">ä¸è‡ªåŠ¨æ’­æ”¾</option><option value="1">è®­ç»ƒé¡µè‡ªåŠ¨æ’­æ”¾</option></select>
        <button class="btn light" id="testBgm" type="button">è¯•å¬/æš‚åœ</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast hide"></div>
<audio id="beepAudio" src="bell.mp3" preload="auto"></audio>
<audio id="bgmAudio" preload="auto" loop></audio>

<script>
/* ========= å·¥å…· ========= */
const $=id=>document.getElementById(id);
const show=id=>$(id).classList.remove('hide');
const hide=id=>$(id).classList.add('hide');
function toast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hide');t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1600);setTimeout(()=>t.classList.add('hide'),1900);}
function deb(fn,ms=300){let h=null;return(...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),ms)}}

/* ========= å­˜å‚¨é”® ========= */
const K={brand:'gym_brand',prefs:'gym_prefs',videos:'gym_videos',logs:'gym_logs',notes:'gym_notes',trainText:'gym_traintext'};

/* ========= å­˜å– ========= */
const load=(k,d)=>{try{const t=localStorage.getItem(k);return t?JSON.parse(t):d}catch{return d}}
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ========= çŠ¶æ€ ========= */
let brand=load(K.brand,{title:'è®­ç»ƒæé†’',ver:'v3.32',bg:'#91C6FF'});
let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs',customParts:[],bgm:{url:'',auto:false}});
let videos=load(K.videos,{legs:[],chest:[],back:[],arms:[],shoulders:[],core:[]});
let notes=load(K.notes,{
  legs:"è†ç›–ä¸è„šå°–åŒå‘ï¼›ä¸‹è¹²ä¿æŒèƒŒéƒ¨ä¸­ç«‹ï¼›å…¨ç¨‹æ§åˆ¶ï¼Œä¸è¦å¼¹éœ‡ã€‚",
  chest:"è‚©èƒ›åæ”¶ä¸‹æ²‰ï¼›è‚˜éƒ¨ç•¥å†…æ”¶ã€‚",
  back:"æ ¸å¿ƒæ”¶ç´§ï¼Œé¿å…è€¸è‚©å€ŸåŠ›ã€‚",
  arms:"è‚˜éƒ¨å›ºå®šï¼Œç¦»å¿ƒç¼“æ…¢ã€‚",
  shoulders:"é¿å…è€¸è‚©ï¼Œæ³¨æ„è‚©è¢–çƒ­èº«ã€‚",
  core:"æ”¶è…¹æè‚›ï¼Œå‘¼å¸é…åˆã€‚"
});
let trainText=load(K.trainText,{}); // {partId:{prev,curr,next}}
let logs=load(K.logs,[]);

/* ========= å¯¼èˆª ========= */
function setActive(page){
  ['home','work','logs','settings'].forEach(p=>$('page-'+p).classList.add('hide'));
  $('page-'+page).classList.remove('hide');
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.querySelector(`.tab[data-page="${page}"]`).classList.add('active');
  if(page==='work'){ renderWork(true); if(prefs.bgm.auto && prefs.bgm.url) startBgm(); } else stopBgm();
  if(page==='logs'){ renderLogFilters(); renderLogs(); }
}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>setActive(t.dataset.page));

/* ========= éƒ¨ä½ ========= */
const baseParts=[
  {id:'legs',name:'è…¿éƒ¨'},{id:'chest',name:'èƒ¸éƒ¨'},{id:'back',name:'èƒŒéƒ¨'},
  {id:'arms',name:'æ‰‹è‡‚'},{id:'shoulders',name:'è‚©éƒ¨'},{id:'core',name:'æ ¸å¿ƒ'}
];
const allParts=()=>[...baseParts, ...(prefs.customParts||[]).map(n=>({id:'c_'+encodeURIComponent(n),name:n}))];
const partName=id=> (allParts().find(p=>p.id===id)||{name:'æœªå‘½å'}).name;
const ensureBucket=id=>{ if(!videos[id]) videos[id]=[]; if(!notes[id] && !['legs','chest','back','arms','shoulders','core'].includes(id)) notes[id]=''; if(!trainText[id]) trainText[id]={prev:'',curr:'',next:''}; };

/* ========= é¦–é¡µ ========= */
function renderHomeChoices(){
  const box=$('homeChoices'); box.innerHTML='';
  baseParts.forEach(p=>box.appendChild(partChoice(p)));
  (prefs.customParts||[]).forEach(n=>box.appendChild(partChoice({id:'c_'+encodeURIComponent(n),name:n})));
  // å¸¸é©»â€œè‡ªå®šä¹‰â€å…¥å£
  const add=document.createElement('div'); add.className='choice';
  add.innerHTML=`<input type="radio" disabled/><span class="name">è‡ªå®šä¹‰</span>`;
  add.onclick=()=>{ $('btnManageCustom').click(); $('newCustomName').focus(); };
  box.appendChild(add);
}
function partChoice(p){
  const div=document.createElement('div'); div.className='choice';
  div.innerHTML=`<input type="radio" name="part" ${prefs.part===p.id?'checked':''}/><span class="name">${p.name}</span>`;
  div.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs);};
  return div;
}
$('btnStart').onclick=()=>setActive('work');
$('btnManageCustom').onclick=()=>$('customMgr').classList.toggle('hide');
$('addCustom').onclick=()=>{
  const name=$('newCustomName').value.trim();
  if(!name) return toast('è¯·è¾“å…¥åç§°');
  if(prefs.customParts.includes(name)) return toast('å·²å­˜åœ¨è¯¥åç§°');
  prefs.customParts.push(name); save(K.prefs,prefs);
  $('newCustomName').value='';
  const id='c_'+encodeURIComponent(name); ensureBucket(id); save(K.videos,videos); save(K.notes,notes); save(K.trainText,trainText);
  renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('å·²æ·»åŠ ');
};
function renderCustomList(){
  const box=$('customList'); box.innerHTML='';
  (prefs.customParts||[]).forEach((name,idx)=>{
    const id='c_'+encodeURIComponent(name);
    const tag=document.createElement('div'); tag.className='customTag';
    const nm=document.createElement('span'); nm.textContent=name;
    const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='é‡å‘½å';
    const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='åˆ é™¤';
    edit.onclick=()=>{
      const nn=prompt('é‡å‘½åä¸ºï¼š', name); if(!nn || !nn.trim()) return;
      if(prefs.customParts.includes(nn.trim())) return toast('è¯¥åç§°å·²å­˜åœ¨');
      const newId='c_'+encodeURIComponent(nn.trim());
      videos[newId]=videos[id]||[]; delete videos[id];
      notes[newId]=notes[id]||''; delete notes[id];
      trainText[newId]=trainText[id]||{prev:'',curr:'',next:''}; delete trainText[id];
      prefs.customParts[idx]=nn.trim();
      if(prefs.part===id) prefs.part=newId;
      save(K.videos,videos); save(K.notes,notes); save(K.trainText,trainText); save(K.prefs,prefs);
      renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('å·²é‡å‘½å');
    };
    del.onclick=()=>{
      if(!confirm('åˆ é™¤è¯¥è‡ªå®šä¹‰éƒ¨ä½ï¼Ÿ')) return;
      prefs.customParts.splice(idx,1); delete videos[id]; delete notes[id]; delete trainText[id];
      if(prefs.part===id) prefs.part='legs';
      save(K.prefs,prefs); save(K.videos,videos); save(K.notes,notes); save(K.trainText,trainText);
      renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('å·²åˆ é™¤');
    };
    tag.appendChild(nm); tag.appendChild(edit); tag.appendChild(del); box.appendChild(tag);
  });
}

/* ========= è®­ç»ƒï¼šæ–‡æœ¬ã€è®¡æ—¶ã€è§†é¢‘ã€æ³¨æ„äº‹é¡¹ ========= */
const syncTrainText=deb(()=>{
  const id=prefs.part; ensureBucket(id);
  trainText[id]={prev:$('txtPrev').value,curr:$('txtCurr').value,next:$('txtNext').value};
  save(K.trainText,trainText);
},300);

$('txtPrev').addEventListener('input',syncTrainText);
$('txtCurr').addEventListener('input',syncTrainText);
$('txtNext').addEventListener('input',syncTrainText);

let timerId=null, remain=0;
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
function startCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); $('timer').textContent=fmt(remain); tick(); timerId=setInterval(tick,1000);}
function tick(){ if(remain<=0){ stopCountdown(); beep(); return; } $('timer').textContent=fmt(remain--); }
function stopCountdown(){ if(timerId){clearInterval(timerId);timerId=null;} }
function resetCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); $('timer').textContent=fmt(remain); }
function beep(){ try{const a=$('beepAudio'); a.currentTime=0; a.play(); setTimeout(()=>a.pause(), (prefs.beepLen||2)*1000);}catch(e){} }
$('btnStartTimer').onclick=startCountdown; $('btnStopTimer').onclick=stopCountdown; $('btnResetTimer').onclick=resetCountdown;

function toYT(u){try{const x=new URL(u); if(x.hostname.includes('youtube.com')&&x.searchParams.get('v'))return`https://www.youtube.com/embed/${x.searchParams.get('v')}`; if(x.hostname.includes('youtu.be'))return`https://www.youtube.com/embed/${x.pathname.replace('/','')}`;}catch{} return null;}

function stopAllVideo(){
  const iframe=$('videoIframe'), vid=$('videoHtml5'), fb=$('videoFallback');
  try{vid.pause();}catch(e){}
  iframe.src=''; vid.src=''; iframe.style.display=vid.style.display=fb.style.display='none';
}
function previewVideo(url){
  const iframe=$('videoIframe'), vid=$('videoHtml5'), fb=$('videoFallback');
  stopAllVideo();
  if(!url){ fb.textContent='æš‚æ— è§†é¢‘'; fb.style.display='block'; return; }
  const yt=toYT(url);
  if(yt){ iframe.src=yt; iframe.style.display='block'; return; }
  if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(url)){ vid.src=url; vid.style.display='block'; return; }
  fb.textContent='æ­¤é“¾æ¥æ— æ³•å†…åµŒæ’­æ”¾ï¼Œè¯·ç‚¹å‡»â€œæ‰“å¼€è§†é¢‘â€åœ¨æ–°çª—å£æ’­æ”¾ã€‚'; fb.style.display='block';
}
function refreshVideoUI(partId){
  ensureBucket(partId);
  const vs=$('videoSelect'); vs.innerHTML='';
  const arr=videos[partId]||[];
  if(!arr.length){ const o=document.createElement('option'); o.value=''; o.textContent='æ— è§†é¢‘'; vs.appendChild(o); previewVideo(''); }
  else{ arr.forEach((it,idx)=>{ const o=document.createElement('option'); o.value=idx; o.textContent=it.name; vs.appendChild(o);}); vs.value=0; previewVideo(arr[0].url);}
  vs.onchange=()=>{ const i=vs.value; if(i===''||i==null){previewVideo('');return;} previewVideo((videos[partId]||[])[i].url); };
  $('openVideo').onclick=()=>{ const i=vs.value; if(i===''||i==null){toast('è¯¥éƒ¨ä½æš‚æ— è§†é¢‘');return;} window.open((videos[partId]||[])[i].url,'_blank'); };
  $('partNotice').textContent=notes[partId]||'æš‚æ— æ³¨æ„äº‹é¡¹';
}
function renderWork(force=false){
  const sel=$('workPart'); sel.innerHTML='';
  allParts().forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o);});
  sel.value=prefs.part;
  // æ–‡æœ¬æ¡†è½½å…¥å½“å‰éƒ¨ä½å†…å®¹
  ensureBucket(prefs.part);
  const t=trainText[prefs.part]||{prev:'',curr:'',next:''};
  $('txtPrev').value=t.prev||''; $('txtCurr').value=t.curr||''; $('txtNext').value=t.next||'';
  refreshVideoUI(prefs.part);
  resetCountdown();
  sel.onchange=()=>{ prefs.part=sel.value; save(K.prefs,prefs); renderWork(true); };
}

/* ========= æ—¥å¿— ========= */
function renderLogFilters(){
  const sel=$('logFilter'); sel.innerHTML='';
  sel.appendChild(new Option('å…¨éƒ¨','all'));
  allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id)));
  sel.onchange=renderLogs;
  const partSel=$('logPart'); partSel.innerHTML=''; allParts().forEach(p=> partSel.appendChild(new Option(p.name,p.id))); partSel.value=prefs.part;
}
function appendLog(txt,partId){
  const first=(txt.split(/\r?\n/)[0]||'').trim()||'ï¼ˆæ— æ ‡é¢˜ï¼‰';
  logs.push({title:first,content:txt,part:partId,ts:Date.now()}); save(K.logs,logs);
}
$('toggleAddLog').onclick=()=>$('addLogBox').classList.toggle('hide');
$('addLogCancel').onclick=()=>hide('addLogBox');
$('addLogSave').onclick=()=>{
  const txt=$('addLogText').value.trim(); if(!txt) return toast('è¯·ç²˜è´´æ—¥å¿—å†…å®¹');
  const pid=$('logPart').value; appendLog(txt,pid);
  $('addLogText').value=''; hide('addLogBox'); renderLogs(); toast('å·²ä¿å­˜');
};

function renderLogs(){
  const box=$('logList'); box.innerHTML='';
  const filter=$('logFilter').value||'all';
  let list=[...logs];
  if(filter!=='all') list=list.filter(x=>x.part===filter);
  list.sort((a,b)=>b.ts-a.ts);
  if(!list.length){ box.innerHTML='<div class="tiny muted">æš‚æ— æ—¥å¿—ã€‚</div>'; return; }
  list.forEach((log,i)=>{
    const item=document.createElement('div'); item.className='log-item';
    const meta=document.createElement('div'); meta.className='log-meta';
    const dt=new Date(log.ts); meta.textContent=`${dt.toLocaleDateString()} Â· ${partName(log.part||'')}`;
    const title=document.createElement('div'); title.className='log-title'; title.textContent=log.title||'ï¼ˆæ— æ ‡é¢˜ï¼‰';
    const content=document.createElement('div'); content.className='log-content hide'; content.textContent=log.content||'ï¼ˆæ— å†…å®¹ï¼‰';
    title.onclick=()=>content.classList.toggle('hide');
    item.appendChild(title); item.appendChild(meta); item.appendChild(content);
    box.appendChild(item);
  });
}

/* ========= è®¾ç½®ï¼šå¤–è§‚ / è§†é¢‘ç®¡ç† / æ•°æ® / è®¡æ—¶ / BGM ========= */
$('saveBrand').onclick=()=>{
  brand.title=$('titleInput').value||brand.title;
  brand.ver=$('verInput').value||brand.ver;
  brand.bg=$('bgColor').value||brand.bg;
  save(K.brand,brand);
  $('appTitle').textContent=`${brand.title} Â· ${brand.ver}`;
  document.documentElement.style.setProperty('--bg', brand.bg);
  toast('å¤–è§‚å·²ä¿å­˜');
};

/* è§†é¢‘ç®¡ç† */
function renderVmPartOptions(){
  const sel=$('vmPart'); sel.innerHTML='';
  allParts().forEach(p=>{ sel.appendChild(new Option(p.name,p.id)); });
  sel.value=prefs.part;
  $('vmTitle').textContent=`${partName(sel.value)} è§†é¢‘ & æ³¨æ„äº‹é¡¹`;
  $('vmNotes').value=notes[sel.value]||'';
  renderVmList();
}
$('vmPart').onchange=()=>{ $('vmTitle').textContent=`${partName($('vmPart').value)} è§†é¢‘ & æ³¨æ„äº‹é¡¹`; $('vmNotes').value=notes[$('vmPart').value]||''; renderVmList(); };
$('saveNotes').onclick=()=>{ const id=$('vmPart').value; notes[id]=$('vmNotes').value||''; save(K.notes,notes); if(prefs.part===id) $('partNotice').textContent=notes[id]||''; toast('æ³¨æ„äº‹é¡¹å·²ä¿å­˜'); };
$('vmAdd').onclick=()=>{
  const part=$('vmPart').value, name=$('vmName').value.trim(), url=$('vmUrl').value.trim();
  if(!name||!url) return toast('åç§°å’Œé“¾æ¥éƒ½è¦å¡«');
  ensureBucket(part); const arr=videos[part]; const idx=arr.findIndex(x=>x.name===name); const item={name,url};
  if(idx>=0) arr[idx]=item; else arr.push(item);
  save(K.videos,videos); $('vmName').value=''; $('vmUrl').value=''; renderVmList(); toast('å·²ä¿å­˜');
};
function renderVmList(){
  const part=$('vmPart').value; ensureBucket(part);
  const box=$('vmList'); box.innerHTML='';
  const arr=videos[part];
  if(!arr.length){ box.innerHTML='<div class="tiny muted">è¯¥éƒ¨ä½æš‚æ— è§†é¢‘ã€‚</div>'; return; }
  arr.forEach((it,idx)=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.style.borderBottom='1px solid var(--border)';
    const left=document.createElement('div'); left.textContent=it.name; left.title=it.url;
    const right=document.createElement('div');
    const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='âœï¸ ç¼–è¾‘';
    const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='ğŸ—‘ åˆ é™¤';
    edit.onclick=()=>{ const nt=prompt('æ ‡é¢˜',it.name); if(nt===null) return; const nu=prompt('é“¾æ¥',it.url); if(nu===null) return; videos[part][idx]={name:nt,url:nu}; save(K.videos,videos); renderVmList(); };
    del.onclick=()=>{ arr.splice(idx,1); save(K.videos,videos); renderVmList(); };
    right.appendChild(edit); right.appendChild(del);
    row.appendChild(left); row.appendChild(right); box.appendChild(row);
  });
}

/* æ•°æ®/è®¡æ—¶ */
$('exportAll').onclick=()=>{ const payload={brand,prefs,videos,logs,notes,trainText}; const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(payload,null,2)); a.download='jaspergym-data.json'; a.click(); };
$('importAll').onclick=()=>$('importFile').click();
$('importFile').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.brand)brand=o.brand; if(o.prefs)prefs=o.prefs; if(o.videos)videos=o.videos; if(o.logs)logs=o.logs; if(o.notes)notes=o.notes; if(o.trainText)trainText=o.trainText; save(K.brand,brand); save(K.prefs,prefs); save(K.videos,videos); save(K.logs,logs); save(K.notes,notes); save(K.trainText,trainText); $('appTitle').textContent=`${brand.title} Â· ${brand.ver}`; document.documentElement.style.setProperty('--bg', brand.bg); renderHomeChoices(); renderCustomList(); renderWork(true); renderVmPartOptions(); renderLogFilters(); renderLogs(); toast('å¯¼å…¥å®Œæˆ'); }catch{ toast('å¯¼å…¥å¤±è´¥ï¼šJSON æœ‰è¯¯'); } }; r.readAsText(f,'utf-8'); };
$('wipeAll').onclick=()=>{ Object.values(K).forEach(k=>localStorage.removeItem(k)); toast('å·²æ¸…ç©ºï¼Œåˆ·æ–°ä¸­â€¦'); setTimeout(()=>location.reload(),300); };
$('saveTimerPref').onclick=()=>{ prefs.interval=parseInt($('intervalInput').value||60,10); prefs.beepLen=parseInt($('beepLen').value||2,10); save(K.prefs,prefs); resetCountdown(); toast('è®¡æ—¶è®¾ç½®å·²ä¿å­˜'); };

/* èƒŒæ™¯éŸ³ä¹ï¼ˆä»…æœ¬åœ°ï¼‰ */
const bgm=$('bgmAudio');
$('saveBgm').onclick=()=>{
  const f=$('bgmFile').files[0]; if(!f){ prefs.bgm.url=''; prefs.bgm.auto=$('bgmAuto').value==='1'; save(K.prefs,prefs); toast('å·²å…³é—­èƒŒæ™¯éŸ³ä¹'); return; }
  const url=URL.createObjectURL(f); prefs.bgm.url=url; prefs.bgm.auto=$('bgmAuto').value==='1'; save(K.prefs,prefs); toast('èƒŒæ™¯éŸ³ä¹å·²ä¿å­˜'); };
$('testBgm').onclick=()=>{ if(bgm.paused){ startBgm(); } else { stopBgm(); } };
function startBgm(){ if(!prefs.bgm.url) return; bgm.src=prefs.bgm.url; bgm.play().catch(()=>{}); }
function stopBgm(){ try{bgm.pause();}catch(e){} }

/* ========= å¯åŠ¨ ========= */
(function init(){
  $('appTitle').textContent=`${brand.title} Â· ${brand.ver}`;
  document.documentElement.style.setProperty('--bg', brand.bg);
  renderHomeChoices(); renderCustomList();
  renderWork(true);
  renderVmPartOptions();
  renderLogFilters(); renderLogs();
})();
</script>
</body>
</html>
