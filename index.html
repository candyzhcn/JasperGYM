<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="theme-color" content="#4285F4"/>
<title>训练提醒 · v3.37</title>
<link rel="manifest" href="manifest.json?v=337">
<link rel="icon" href="icon-192-jia-rounded-fix.png" sizes="192x192" type="image/png">
<link rel="icon" href="icon-512-jia-rounded-fix.png" sizes="512x512" type="image/png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<style>
:root{--bg:#91C6FF;--panel:#fff;--ink:#111;--muted:#5b616a;--brand:#2563eb;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;--border:#d1d5db;--field:#fff}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
.header{padding:8px 0 6px}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:12px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:10px 16px;cursor:pointer;user-select:none;display:flex;gap:8px;align-items:center}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.tab img.ico{width:20px;height:20px;object-fit:contain;display:block}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 12px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type=text],input[type=number],input[type=color],textarea{width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
textarea{min-height:140px;resize:vertical}
.bigtext{min-height:300px}
.bigtextx3{min-height:900px}/* 3倍高度 */
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}.btn.ok{background:var(--ok);color:#fff}.btn.warn{background:var(--warn);color:#fff}.btn.light{background:transparent;border:1px solid var(--border);color:#111}.btn.danger{background:var(--danger);color:#fff}.btn.xs{padding:6px 10px;font-size:12px}
.muted{color:var(--muted)}.tiny{font-size:12px}.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}
/* 首页 */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer}
.choice input{transform:scale(1.2)}.choice:hover{border-color:var(--brand)}.choice .name{font-weight:700}
.customOps{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.customTag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:6px 10px;border-radius:999px}
/* 训练 */
.timerGrid{display:grid;grid-template-columns:1fr 160px;gap:12px;align-items:center}
.timer{font-size:36px;font-weight:800;letter-spacing:1px}
.timerBtns{display:flex;flex-direction:column;gap:8px}
.timerBtns .btn{width:100%}
.video-player{margin-top:8px}
#videoContainer{width:100%;height:720px;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
#videoIframe,#videoHtml5{width:100%;height:100%;border:0;display:none}#videoFallback{display:none;color:#fff;padding:12px}
@media(max-width:1024px){#videoContainer{height:560px}}@media(max-width:640px){#videoContainer{height:480px}}@media(max-width:420px){#videoContainer{height:360px}}
.notice{margin-top:12px;padding:12px;border:1px dashed #cbd5e1;border-radius:10px;background:#f8fafc;white-space:pre-wrap}
/* 日志 */
.filterRow,.toolsRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.log-item{padding:16px 10px;border-bottom:1px solid var(--border);border-radius:8px;margin-bottom:10px}
.log-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.log-title{font-weight:700;cursor:pointer;margin-bottom:6px}.log-tags{font-size:12px;color:#64748b;margin-left:auto}
.log-content{margin-top:6px;white-space:pre-wrap;word-break:break-word;line-height:1.8}
/* 编辑面板 */
.editBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">训练提醒 · v3.37</div>
      <div class="tabs" id="tabs">
        <div class="tab active" data-page="home"><img src="商城.png" class="ico" alt=""><span>首页</span></div>
        <div class="tab" data-page="work"><img src="点赞.png" class="ico" alt=""><span>训练</span></div>
        <div class="tab" data-page="logs"><img src="日历.png" class="ico" alt=""><span>日志</span></div>
        <div class="tab" data-page="settings"><img src="设置.png" class="ico" alt=""><span>设置</span></div>
      </div>
    </div>
  </div>
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">今天训练什么？</div>
      <div class="choices" id="homeChoices"></div>
      <div class="row auto" style="margin-top:10px">
        <div class="tiny muted">选择后点击开始；“设置→视频管理”维护各部位的视频与注意事项。</div>
        <button class="btn brand" id="btnStart" type="button">进入训练页</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn light" id="btnManageCustom" type="button">管理自定义</button>
        <div id="customMgr" class="hide card" style="margin:10px 0 0">
          <div class="row auto">
            <div class="field"><label>新增自定义部位</label>
              <input id="newCustomName" type="text" placeholder="如：小腿、臀外侧…">
            </div>
            <button class="btn ok" id="addCustom" type="button">添加</button>
          </div>
          <div id="customList" class="customOps"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle">本次训练</div>
      <div class="row auto">
        <div class="field"><label>训练部位</label><select id="workPart"></select></div>
      </div>
      <div class="timerGrid card" style="margin-top:10px">
        <div class="timer" id="timer">00:00</div>
        <div class="timerBtns">
          <button class="btn ok" id="btnStartTimer" type="button">开始倒计时</button>
          <button class="btn light" id="btnStopTimer" type="button">停止</button>
          <button class="btn light" id="btnResetTimer" type="button">重置</button>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="sectionTitle" style="margin:0">训练记录</div>
          <div class="editBar"><button id="btnEditTrain" class="btn light" type="button">编辑</button><button id="btnSaveTrain" class="btn ok hide" type="button">保存</button><button id="btnCancelTrain" class="btn light hide" type="button">取消</button></div>
        </div>
        <!-- 展示态 -->
        <div id="trainView" class="notice">暂无记录</div>
        <!-- 编辑态：三倍高度 -->
        <textarea id="trainEdit" class="bigtextx3 hide" placeholder="在此编辑训练记录…"></textarea>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">参考视频</div>
      <div class="row auto">
        <div class="field"><label>选择视频</label><select id="videoSelect"></select></div>
        <a id="openVideo" class="btn light" target="_blank" href="#">打开视频</a>
      </div>
      <div class="video-player">
        <div id="videoContainer">
          <iframe id="videoIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          <video id="videoHtml5" controls></video>
          <div id="videoFallback" class="tiny">暂无视频</div>
        </div>
      </div>
      <div class="notice" id="partNotice">暂无注意事项</div>
    </div>
  </div>
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">训练日志</div>
      <div class="filterRow"><label>筛选部位</label><select id="logFilter"></select></div>
      <div class="toolsRow">
        <button class="btn ok" id="toggleAddLog" type="button">➕ 添加日志</button>
        <button class="btn light" id="toggleSort" type="button">✏️ 编辑/排序</button>
      </div>
      <div id="addEditBox" class="hide card" style="margin-top:0">
        <div class="row auto">
          <div class="field"><label>部位</label><select id="logPart"></select></div>
          <div class="field"><label>标题</label><input id="editTitle" type="text" placeholder="第一行会作为标题，可在此重写"></div>
          <div class="field" style="grid-column:1/-1"><label>日志内容</label><textarea id="editContent" class="bigtext" placeholder="正文（支持多段落）"></textarea></div>
        </div>
        <div class="row auto">
          <button class="btn ok" id="saveLog" type="button">保存</button>
          <button class="btn light" id="cancelEdit" type="button">取消</button>
        </div>
      </div>
      <div id="logList" style="margin-top:10px"></div>
    </div>
  </div>
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle" id="vmTitle">（选择部位）视频 & 注意事项</div>
      <div class="row auto">
        <div class="field"><label>部位</label><select id="vmPart"></select></div>
        <div class="field"><label>名称</label><input id="vmName" type="text" placeholder="如：深蹲动作讲解"></div>
        <div class="field"><label>链接</label><input id="vmUrl" type="text" placeholder="https://…（YouTube/MP4/链接）"></div>
        <button class="btn ok" id="vmAdd" type="button">添加/更新</button>
      </div>
      <div class="row auto" style="margin-top:10px">
        <div class="field" style="grid-column:1/-1"><label>该部位「训练注意事项」</label><textarea id="vmNotes" placeholder="要点/发力/常见错误… 一行一条亦可"></textarea></div>
        <button class="btn ok" id="saveNotes" type="button">保存注意事项</button>
      </div>
      <div id="vmList" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="sectionTitle">倒计时设置</div>
      <div class="row auto">
        <div class="field"><label>时间间隔（秒）</label><input id="intervalInput" type="number" min="10" max="999" step="1" value="60"/></div>
        <div class="field"><label>提示音长度（秒）</label><input id="beepLen" type="number" min="1" max="10" step="1" value="2"/></div>
        <button class="btn ok" id="saveTimerPref" type="button">保存计时设置</button>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">背景音乐</div>
      <div class="row auto">
        <div class="field"><label>站点音乐库（/music）</label><select id="bgmSelect"></select></div>
        <input id="bgmFile" type="file" accept="audio/*">
        <select id="bgmAuto"><option value="0">不自动播放</option><option value="1">训练页自动播放</option></select>
        <button class="btn ok" id="saveBgm" type="button">启用所选/上传</button>
        <button class="btn light" id="testBgm" type="button">试听/暂停</button>
      </div>
      <div class="tiny muted">若你在 <code>/music</code> 放了音频，提供 <code>music/list.json</code> 形如：["music/a.mp3","music/b.m4a","music/c.ogg"]；服务端需返回正确 MIME（mp3=audio/mpeg、m4a=audio/mp4、ogg=audio/ogg）。</div>
    </div>
    <div class="card">
      <div class="sectionTitle">外观 / 标识</div>
      <div class="row auto">
        <div class="field"><label>自定义标题</label><input id="titleInput" type="text" placeholder="如：JasperGYM"></div>
        <div class="field"><label>版本号</label><input id="verInput" type="text" placeholder="如：v3.37"></div>
        <div class="field"><label>背景颜色</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand" type="button">保存外观</button>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">数据管理</div>
      <div class="row auto">
        <button class="btn ok" id="exportAll" type="button">📤 导出全部数据</button>
        <input type="file" id="importFile" class="hide" accept=".json"/>
        <button class="btn warn" id="importAll" type="button">📥 导入数据（覆盖本地）</button>
        <button class="btn danger" id="wipeAll" type="button">🗑 清空全部数据（不可恢复）</button>
      </div>
    </div>
  </div>
</div>
<div id="toast" class="toast hide"></div>
<!-- 提示音与BGM播放器（source将动态填充以带MIME） -->
<audio id="beepAudio" src="bell.mp3" preload="auto"></audio>
<audio id="bgmAudio" preload="auto" loop></audio>
<script type="module">
// —— 工具 ——
const byId=id=>document.getElementById(id);const show=id=>byId(id)?.classList.remove('hide');const hide=id=>byId(id)?.classList.add('hide');
function toast(msg){const t=byId('toast');if(!t)return; t.textContent=msg;t.classList.remove('hide');t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1600);setTimeout(()=>t.classList.add('hide'),1900)}
const deb=(fn,ms=300)=>{let h=null;return(...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),ms)}};const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
// —— 存储 ——
const K={brand:'gym_brand',prefs:'gym_prefs',videos:'gym_videos',logs:'gym_logs',notes:'gym_notes',trainText:'gym_traintext'};let LS_OK=true;try{localStorage.setItem('__t','1');localStorage.removeItem('__t')}catch(e){LS_OK=false}
const MEM={};const load=(k,d)=>{try{const t=(LS_OK?localStorage.getItem(k):MEM[k]);return t?JSON.parse(t):d}catch{return d}};const save=(k,v)=>{try{LS_OK?localStorage.setItem(k,JSON.stringify(v)):MEM[k]=JSON.stringify(v)}catch(e){toast('⚠️ 本地存储受限，数据仅暂存到内存')}};
// —— 数据模型 ——
let brand=load(K.brand,{title:'训练提醒',ver:'v3.37',bg:'#91C6FF'});let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs',customParts:[],bgm:{url:'',auto:false}});let videos=load(K.videos,{legs:[],chest:[],back:[],arms:[],shoulders:[],core:[]});let notes=load(K.notes,{legs:'',chest:'',back:'',arms:'',shoulders:'',core:''});
let trainText=load(K.trainText,{}); // { part: {all:'...'} } 兼容 prev/curr/next → all
let logs=load(K.logs,[]);
const baseParts=[{id:'legs',name:'腿部'},{id:'chest',name:'胸部'},{id:'back',name:'背部'},{id:'arms',name:'手臂'},{id:'shoulders',name:'肩部'},{id:'core',name:'核心'}];
const allParts=()=>[...baseParts,...(prefs.customParts||[]).map(n=>({id:'c_'+encodeURIComponent(n),name:n}))];
const partName=id=>(allParts().find(p=>p.id===id)||{name:'未命名'}).name;
const ensureBucket=id=>{ if(!videos[id]) videos[id]=[]; if(!notes[id]) notes[id]=''; if(!trainText[id]) trainText[id]={all:''}; const t=trainText[id]; if((t.prev!==undefined||t.curr!==undefined||t.next!==undefined) && !('all' in t)){ // 迁移三分到单页
  const merged=[t.prev,t.curr,t.next].filter(Boolean).join('\n\n'); trainText[id]={all:merged}; save(K.trainText,trainText) } };
// —— 导航 ——
function setActive(page){['home','work','logs','settings'].forEach(p=>byId('page-'+p)?.classList.add('hide')); byId('page-'+page)?.classList.remove('hide'); document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active')); const ac=document.querySelector(`.tab[data-page="${page}"]`); ac&&ac.classList.add('active'); if(page==='work'){ renderWork(); if(prefs.bgm.auto) startBgm(); } else stopBgm(); if(page==='logs'){ renderLogFilters(); renderLogs(); }}
byId('tabs')?.addEventListener('click',e=>{const el=e.target.closest('.tab'); if(el&&el.dataset.page) setActive(el.dataset.page)});
// —— 首页 ——
function renderHomeChoices(){ const box=byId('homeChoices'); if(!box) return; box.innerHTML=''; baseParts.forEach(p=>box.appendChild(choice(p))); (prefs.customParts||[]).forEach(n=>box.appendChild(choice({id:'c_'+encodeURIComponent(n),name:n}))); const add=document.createElement('div'); add.className='choice'; add.innerHTML=`<input type="radio" disabled/><span class="name">自定义</span>`; add.onclick=()=>{ byId('btnManageCustom')?.click(); byId('newCustomName')?.focus(); }; box.appendChild(add)}
function choice(p){ const d=document.createElement('div'); d.className='choice'; d.innerHTML=`<input type="radio" name="part" ${prefs.part===p.id?'checked':''}/><span class="name">${p.name}</span>`; d.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs)}; return d }
byId('btnStart')?.addEventListener('click',()=>setActive('work'));
byId('btnManageCustom')?.addEventListener('click',()=>byId('customMgr')?.classList.toggle('hide'));
byId('addCustom')?.addEventListener('click',()=>{ const name=(byId('newCustomName')?.value||'').trim(); if(!name) return toast('请输入名称'); if((prefs.customParts||[]).includes(name)) return toast('已存在该名称'); (prefs.customParts=prefs.customParts||[]).push(name); save(K.prefs,prefs); if(byId('newCustomName')) byId('newCustomName').value=''; const id='c_'+encodeURIComponent(name); ensureBucket(id); save(K.videos,videos); save(K.notes,notes); save(K.trainText,trainText); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已添加') });
function renderCustomList(){ const box=byId('customList'); if(!box) return; box.innerHTML=''; (prefs.customParts||[]).forEach((name,idx)=>{ const id='c_'+encodeURIComponent(name); const tag=document.createElement('div'); tag.className='customTag'; const nm=document.createElement('span'); nm.textContent=name; const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='重命名'; const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='删除'; edit.onclick=()=>{ const nn=prompt('重命名为：', name); if(!nn||!nn.trim())return; if(prefs.customParts.includes(nn.trim())) return toast('该名称已存在'); const newId='c_'+encodeURIComponent(nn.trim()); videos[newId]=videos[id]||[]; notes[newId]=notes[id]||''; trainText[newId]=trainText[id]||{all:''}; delete videos[id]; delete notes[id]; delete trainText[id]; prefs.customParts[idx]=nn.trim(); if(prefs.part===id) prefs.part=newId; save(K.videos,videos); save(K.notes,notes); save(K.trainText,trainText); save(K.prefs,prefs); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已重命名') }; del.onclick=()=>{ if(!confirm('删除该自定义部位？')) return; prefs.customParts.splice(idx,1); delete videos[id]; delete notes[id]; delete trainText[id]; if(prefs.part===id) prefs.part='legs'; save(K.prefs,prefs); save(K.videos,videos); save(K.notes,notes); save(K.trainText,trainText); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已删除') }; tag.appendChild(nm); tag.appendChild(edit); tag.appendChild(del); box.appendChild(tag) }) }
// —— 训练：计时/记录/视频 ——
let timerId=null,remain=0; const resetCountdown=()=>{ stopCountdown(); remain=parseInt(prefs.interval||60,10); const el=byId('timer'); if(el) el.textContent=fmt(remain)}; const tick=()=>{ const el=byId('timer'); if(!el) return; if(remain<=0){ stopCountdown(); beep(); return } el.textContent=fmt(remain--) };
function startCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); const el=byId('timer'); if(el) el.textContent=fmt(remain); tick(); timerId=setInterval(tick,1000) }
function stopCountdown(){ if(timerId){clearInterval(timerId);timerId=null} }
function beep(){ try{const a=byId('beepAudio'); if(!a) return; a.currentTime=0; a.play(); setTimeout(()=>a.pause(), (prefs.beepLen||2)*1000)}catch(e){} }
byId('btnStartTimer')?.addEventListener('click',startCountdown); byId('btnStopTimer')?.addEventListener('click',stopCountdown); byId('btnResetTimer')?.addEventListener('click',resetCountdown);
// 训练记录：单页+编辑
function renderTrainView(){ ensureBucket(prefs.part); const v=(trainText[prefs.part]?.all)||''; const view=byId('trainView'); if(view) view.textContent=v||'暂无记录'; const edit=byId('trainEdit'); if(edit&&!edit.classList.contains('hide')) edit.value=v }
byId('btnEditTrain')?.addEventListener('click',()=>{ ensureBucket(prefs.part); const edit=byId('trainEdit'), view=byId('trainView'); if(!edit||!view) return; edit.value=(trainText[prefs.part]?.all)||''; show('trainEdit'); hide('trainView'); hide('btnEditTrain'); show('btnSaveTrain'); show('btnCancelTrain') });
byId('btnCancelTrain')?.addEventListener('click',()=>{ hide('trainEdit'); show('trainView'); show('btnEditTrain'); hide('btnSaveTrain'); hide('btnCancelTrain') });
byId('btnSaveTrain')?.addEventListener('click',()=>{ const edit=byId('trainEdit'); if(!edit) return; ensureBucket(prefs.part); trainText[prefs.part].all=edit.value||''; save(K.trainText,trainText); renderTrainView(); hide('trainEdit'); show('trainView'); show('btnEditTrain'); hide('btnSaveTrain'); hide('btnCancelTrain'); toast('训练记录已保存') });
// 视频
const toYT=u=>{try{const x=new URL(u); if(x.hostname.includes('youtube.com')&&x.searchParams.get('v'))return`https://www.youtube.com/embed/${x.searchParams.get('v')}`; if(x.hostname.includes('youtu.be'))return`https://www.youtube.com/embed/${x.pathname.replace('/','')}`}catch{} return null};
function stopAllVideo(){ const iframe=byId('videoIframe'),vid=byId('videoHtml5'),fb=byId('videoFallback'); try{vid&&vid.pause()}catch(e){} if(iframe) iframe.src=''; if(vid) vid.src=''; if(iframe) iframe.style.display='none'; if(vid) vid.style.display='none'; if(fb) fb.style.display='none' }
function previewVideo(url){ const iframe=byId('videoIframe'),vid=byId('videoHtml5'),fb=byId('videoFallback'); stopAllVideo(); if(!url){ fb&&(fb.textContent='暂无视频',fb.style.display='block'); return } const yt=toYT(url); if(yt&&iframe){ iframe.src=yt; iframe.style.display='block'; return } if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(url) && vid){ vid.src=url; vid.style.display='block'; return } fb&&(fb.textContent='此链接无法内嵌播放，请点击“打开视频”。',fb.style.display='block') }
function refreshVideoUI(partId){ ensureBucket(partId); const vs=byId('videoSelect'); if(!vs) return; vs.innerHTML=''; const arr=videos[partId]||[]; if(!arr.length){ const o=document.createElement('option'); o.value=''; o.textContent='无视频'; vs.appendChild(o); previewVideo('') } else { arr.forEach((it,idx)=>{ const o=document.createElement('option'); o.value=idx; o.textContent=it.name; vs.appendChild(o) }); vs.value=0; previewVideo(arr[0].url) } vs.onchange=()=>{ const i=vs.value; if(i===''||i==null){previewVideo('');return} previewVideo((videos[partId]||[])[i].url) }; const a=byId('openVideo'); if(a) a.onclick=()=>{ const i=vs.value; if(i===''||i==null){toast('该部位暂无视频');return} window.open((videos[partId]||[])[i].url,'_blank') }; const pn=byId('partNotice'); if(pn) pn.textContent=notes[partId]||'暂无注意事项' }
function renderWork(){ const sel=byId('workPart'); if(!sel) return; sel.innerHTML=''; allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id)) ); sel.value=prefs.part; ensureBucket(prefs.part); renderTrainView(); refreshVideoUI(prefs.part); resetCountdown(); sel.onchange=()=>{ prefs.part=sel.value; save(K.prefs,prefs); ensureBucket(prefs.part); renderTrainView(); refreshVideoUI(prefs.part); stopAllVideo(); } }
// —— 日志（稳定排序） ——
let sortMode=false,editingIndex=null; function renderLogFilters(){ const sel=byId('logFilter'); if(!sel) return; sel.innerHTML=''; sel.appendChild(new Option('全部','all')); allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id))); sel.onchange=renderLogs; const partSel=byId('logPart'); if(partSel){ partSel.innerHTML=''; allParts().forEach(p=> partSel.appendChild(new Option(p.name,p.id))); partSel.value=prefs.part } }
byId('toggleAddLog')?.addEventListener('click',()=>{ editingIndex=null; const t1=byId('editTitle'); const t2=byId('editContent'); const p=byId('logPart'); if(t1) t1.value=''; if(t2) t2.value=''; if(p) p.value=prefs.part; byId('addEditBox')?.classList.toggle('hide') });
byId('cancelEdit')?.addEventListener('click',()=>hide('addEditBox'));
byId('saveLog')?.addEventListener('click',()=>{ const title=(byId('editTitle')?.value||'').trim(); const content=(byId('editContent')?.value||'').trim(); if(!title && !content) return toast('请至少填写标题或正文'); const pid=(byId('logPart')?.value)||prefs.part; const finalTitle=title || (content.split(/\r?\n/)[0]||'（无标题）'); const id=crypto.randomUUID?crypto.randomUUID():('id_'+Date.now()+Math.random()); if(editingIndex===null){ logs.push({id,title:finalTitle,content,part:pid,ts:Date.now()}); } else { logs[editingIndex]={...logs[editingIndex],title:finalTitle,content,part:pid}; } save(K.logs,logs); hide('addEditBox'); renderLogs(); toast('已保存') });
byId('toggleSort')?.addEventListener('click',()=>{ sortMode=!sortMode; renderLogs() });
function renderLogs(){ const box=byId('logList'); if(!box) return; box.innerHTML=''; const filter=(byId('logFilter')?.value)||'all'; let idxs=[]; for(let i=0;i<logs.length;i++){ if(filter==='all'||logs[i].part===filter) idxs.push(i) } const order= sortMode? idxs : idxs.sort((a,b)=> (logs[b].ts||0)-(logs[a].ts||0) ); if(!order.length){ box.innerHTML='<div class="tiny muted">暂无日志。</div>'; return } order.forEach((realIndex)=>{ const log=logs[realIndex]; const item=document.createElement('div'); item.className='log-item'; const head=document.createElement('div'); head.className='log-head'; const title=document.createElement('div'); title.className='log-title'; title.textContent=log.title||'（无标题）'; const tags=document.createElement('div'); tags.className='log-tags'; tags.textContent=partName(log.part||''); head.appendChild(title); head.appendChild(tags); item.appendChild(head); const content=document.createElement('div'); content.className='log-content hide'; content.textContent=log.content||'（无内容）'; title.onclick=()=>content.classList.toggle('hide'); item.appendChild(content); if(sortMode){ const tools=document.createElement('div'); tools.className='toolsRow'; tools.innerHTML=`<button class="btn xs light">⬆️ 上移</button><button class="btn xs light">⬇️ 下移</button><button class="btn xs light">✏️ 编辑</button><button class="btn xs danger">🗑 删除</button>`; const [upBtn,downBtn,editBtn,delBtn]=tools.querySelectorAll('button'); upBtn.onclick=(e)=>{e.stopPropagation(); moveInFiltered(filter, realIndex, -1) }; downBtn.onclick=(e)=>{e.stopPropagation(); moveInFiltered(filter, realIndex, +1) }; editBtn.onclick=(e)=>{e.stopPropagation(); editingIndex=realIndex; show('addEditBox'); const p=byId('logPart'); if(p) p.value=log.part||prefs.part; const t1=byId('editTitle'); const t2=byId('editContent'); if(t1) t1.value=log.title||''; if(t2) t2.value=log.content||''; window.scrollTo({top:0,behavior:'smooth'}); }; delBtn.onclick=(e)=>{e.stopPropagation(); logs.splice(realIndex,1); save(K.logs,logs); renderLogs(); }; item.appendChild(tools); } box.appendChild(item) }) }
function moveInFiltered(filter, realIndex, delta){ const indices=[]; for(let i=0;i<logs.length;i++){ if(filter==='all'||logs[i].part===filter) indices.push(i) } const pos=indices.indexOf(realIndex); if(pos<0) return; const targetPos=pos+delta; if(targetPos<0||targetPos>=indices.length) return; const a=indices[pos], b=indices[targetPos]; [logs[a],logs[b]]=[logs[b],logs[a]]; save(K.logs,logs); renderLogs() }
// —— 外观/数据 ——
byId('saveBrand')?.addEventListener('click',()=>{ brand.title=(byId('titleInput')?.value)||brand.title; brand.ver=(byId('verInput')?.value)||brand.ver; brand.bg=(byId('bgColor')?.value)||brand.bg; save(K.brand,brand); const t=byId('appTitle'); if(t) t.textContent=`${brand.title} · ${brand.ver}`; document.documentElement.style.setProperty('--bg', brand.bg); toast('外观已保存') });
byId('exportAll')?.addEventListener('click',()=>{ const payload={brand,prefs,videos,logs,notes,trainText}; const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(payload,null,2)); a.download='jaspergym-data.json'; a.click() });
byId('importAll')?.addEventListener('click',()=>byId('importFile')?.click());
byId('importFile')?.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.brand)brand=o.brand; if(o.prefs)prefs=o.prefs; if(o.videos)videos=o.videos; if(o.logs)logs=o.logs; if(o.notes)notes=o.notes; if(o.trainText)trainText=o.trainText; save(K.brand,brand); save(K.prefs,prefs); save(K.videos,videos); save(K.logs,logs); save(K.notes,notes); save(K.trainText,trainText); const t=byId('appTitle'); if(t) t.textContent=`${brand.title} · ${brand.ver}`; document.documentElement.style.setProperty('--bg', brand.bg); renderHomeChoices(); renderCustomList(); renderWork(); renderVmPartOptions(); renderLogFilters(); renderLogs(); toast('导入完成') }catch{ toast('导入失败：JSON 有误') } }; r.readAsText(f,'utf-8') });
byId('wipeAll')?.addEventListener('click',()=>{ Object.values(K).forEach(k=>LS_OK?localStorage.removeItem(k):delete MEM[k]); toast('已清空，刷新中…'); setTimeout(()=>location.reload(),300) });
byId('saveTimerPref')?.addEventListener('click',()=>{ prefs.interval=parseInt((byId('intervalInput')?.value)||60,10); prefs.beepLen=parseInt((byId('beepLen')?.value)||2,10); save(K.prefs,prefs); resetCountdown(); toast('计时设置已保存') });
// —— 背景音乐（MIME精确 & 多source） ——
const bgm=byId('bgmAudio'); if(bgm) bgm.preload='auto';
const mimeFromExt=path=>{ const e=(path.split('?')[0].split('#')[0].match(/\.([a-z0-9]+)$/i)||[])[1]?.toLowerCase(); if(e==='mp3') return 'audio/mpeg'; if(e==='m4a' || e==='mp4' || e==='aac') return 'audio/mp4'; if(e==='ogg' || e==='oga') return 'audio/ogg'; if(e==='wav') return 'audio/wav'; if(e==='flac') return 'audio/flac'; return '' };
function setAudioSources(url){ if(!bgm) return; bgm.pause(); bgm.removeAttribute('src'); // 使用 source 元素并带 type
 while(bgm.firstChild) bgm.removeChild(bgm.firstChild);
 const type=mimeFromExt(url); const s=document.createElement('source'); s.src=url; if(type) s.type=type; bgm.appendChild(s); if(!url.startsWith('blob:')) bgm.crossOrigin='anonymous'; else bgm.removeAttribute('crossorigin'); bgm.load(); }
async function tryLoadMusic(){ const sel=byId('bgmSelect'); if(!sel) return; sel.innerHTML=''; const addOpt=(label,val)=>sel.appendChild(new Option(label,val)); const candidates=['music/list.json','music/index.json']; for(const p of candidates){ try{ const r=await fetch(p,{cache:'no-store'}); if(r.ok){ const arr=await r.json(); if(Array.isArray(arr)&&arr.length){ arr.forEach(x=>addOpt(x.replace(/^.*[\\\\\/]/,''), x)); break } } }catch{} } if(!sel.options.length){ const common=['music/bgm.mp3','music/bgm.m4a','music/bgm.ogg','music/bell.mp3']; for(const x of common){ try{ const r=await fetch(x,{method:'HEAD'}); if(r.ok){ addOpt(x.replace(/^.*[\\\\\/]/,''), x) } }catch{} } } if(!sel.options.length) addOpt('（未发现站点音频，需上传或提供 music/list.json）',''); if(prefs.bgm.url) sel.value=prefs.bgm.url }
function playBgmInteract(){ if(!bgm) return; const p=bgm.play(); if(p&&p.catch){ p.catch(err=>toast('无法播放：需要手势/或文件跨域/MIME。'+(err?.message||''))) } }
byId('saveBgm')?.addEventListener('click',()=>{ const f=byId('bgmFile')?.files?.[0]; const selVal=(byId('bgmSelect')?.value)||''; if(f){ const url=URL.createObjectURL(f); prefs.bgm.url=url; } else { prefs.bgm.url=selVal||'' } prefs.bgm.auto=((byId('bgmAuto')?.value)||'0')==='1'; save(K.prefs,prefs); if(prefs.bgm.url){ setAudioSources(prefs.bgm.url); playBgmInteract(); toast('背景音乐已启用'); } else { try{bgm&&bgm.pause()}catch{} toast('已关闭背景音乐') } });
byId('testBgm')?.addEventListener('click',()=>{ const selVal=(byId('bgmSelect')?.value)||prefs.bgm.url; if(!selVal){ toast('请先选择或上传音频'); return } if(bgm.paused){ setAudioSources(selVal); playBgmInteract(); } else { try{bgm.pause()}catch{} } });
function startBgm(){ if(!bgm || !prefs.bgm.url) return; setAudioSources(prefs.bgm.url); const p=bgm.play(); if(p&&p.catch){/* 静默失败 */} }
function stopBgm(){ try{bgm&&bgm.pause()}catch(e){} }
// —— 启动 ——
function boot(){ const t=byId('appTitle'); if(t) t.textContent=`${brand.title} · ${brand.ver}`; document.documentElement.style.setProperty('--bg', brand.bg); renderHomeChoices(); renderCustomList(); renderWork(); renderVmPartOptions(); renderLogFilters(); renderLogs(); tryLoadMusic() }
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot,{once:true}) } else { boot() }
</script>
</body>
</html>
