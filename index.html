<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#4285F4"/>
<title>训练提醒 · 全量版 v3.31</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192-jia-rounded-fix.png" sizes="192x192" type="image/png">
<link rel="icon" href="icon-512-jia-rounded-fix.png" sizes="512x512" type="image/png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
:root{
  --bg:#91C6FF; --panel:#ffffff; --ink:#111; --muted:#5b616a;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --border:#d1d5db; --field:#ffffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
a{color:var(--brand);text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
.header{position:static;padding:8px 0 6px}
.titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.appTitle{font-weight:800;font-size:20px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer;user-select:none;display:flex;gap:6px;align-items:center}
.tab .ico{font-size:18px}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 10px}
.row{display:grid;gap:16px}
.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type="text"],input[type="number"],input[type="color"],textarea{
  width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none
}
textarea{min-height:160px;resize:vertical}
.bigtext{min-height:320px}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px}
.btn.brand{background:var(--brand);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.warn{background:var(--warn);color:#fff}
.btn.light{background:transparent;border:1px solid var(--border);color:#111}
.btn.danger{background:var(--danger);color:#fff}
.btn.xs{padding:6px 10px;font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.muted{color:var(--muted)} .tiny{font-size:12px}
.hide{display:none}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #334155;
  padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9999;opacity:0;transition:opacity .2s}

/* 首页 */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer}
.choice input{transform:scale(1.2)}
.choice:hover{border-color:var(--brand)}
.choice .name{font-weight:700}
.customOps{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.customTag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:6px 10px;border-radius:999px}

/* 训练页 */
.timer{font-size:40px;font-weight:800;letter-spacing:1px}
.video-player{margin-top:8px}
#videoContainer{width:100%; height:720px; background:#000; border-radius:12px; overflow:hidden; border:1px solid var(--border)}
#videoIframe, #videoHtml5{width:100%; height:100%; border:0; display:none}
#videoFallback{display:none; color:#fff; padding:12px}
@media (max-width: 1024px){ #videoContainer{height:560px} }
@media (max-width: 640px){ #videoContainer{height:480px} }
@media (max-width: 420px){ #videoContainer{height:360px} }
.notice{margin-top:10px;padding:12px;border:1px dashed #cbd5e1;border-radius:10px;background:#f8fafc;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <!-- 顶部 -->
  <div class="header">
    <div class="titlebar">
      <div class="appTitle" id="appTitle">训练提醒 · 全量版 v3.31</div>
      <div class="tabs">
        <div class="tab active" data-page="home"><span class="ico">🏠</span><span>首页</span></div>
        <div class="tab" data-page="work"><span class="ico">🏋️</span><span>训练</span></div>
        <div class="tab" data-page="logs"><span class="ico">📘</span><span>日志</span></div>
        <div class="tab" data-page="settings"><span class="ico">⚙️</span><span>设置</span></div>
      </div>
    </div>
  </div>

  <!-- 首页 -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">今天训练什么？</div>
      <div class="choices" id="homeChoices"></div>
      <div class="row auto" style="margin-top:10px">
        <div class="tiny muted">选择后点击开始；“视频管理”里维护各部位的视频与注意事项。</div>
        <button class="btn brand" id="btnStart" type="button">进入训练页</button>
      </div>

      <div style="margin-top:10px">
        <button class="btn light" id="btnManageCustom" type="button">管理自定义</button>
        <div id="customMgr" class="hide card" style="margin:10px 0 0">
          <div class="row auto">
            <div class="field"><label>新增自定义部位</label>
              <input id="newCustomName" type="text" placeholder="如：小腿、臀外侧…">
            </div>
            <button class="btn ok" id="addCustom" type="button">添加</button>
          </div>
          <div id="customList" class="customOps"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 训练页 -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle">本次训练</div>
      <div class="row auto">
        <div class="field"><label>训练部位</label>
          <select id="workPart"></select>
        </div>
        <div class="field"><label>倒计时</label><div class="timer" id="timer">00:00</div></div>
      </div>
      <div class="row auto">
        <button class="btn ok" id="btnStartTimer" type="button">开始倒计时</button>
        <button class="btn light" id="btnStopTimer" type="button">停止</button>
        <button class="btn light" id="btnResetTimer" type="button">重置</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">参考视频</div>
      <div class="row auto">
        <div class="field"><label>选择视频</label><select id="videoSelect"></select></div>
        <a id="openVideo" class="btn light" target="_blank" href="#">打开视频</a>
      </div>
      <div class="video-player">
        <div id="videoContainer">
          <iframe id="videoIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          <video id="videoHtml5" controls></video>
          <div id="videoFallback" class="tiny">暂无视频</div>
        </div>
      </div>
      <div class="notice" id="partNotice">暂无注意事项</div>
    </div>
  </div>

  <!-- 日志页 -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">训练日志（点标题展开内容；排序“✏️ 编辑”修改；双击内容=仅改内容；长按=删除）</div>
      <div id="logList"></div>
      <div class="row auto" style="margin-top:10px">
        <button class="btn ok" id="toggleAddLog" type="button">➕ 添加日志</button>
        <button class="btn light" id="toggleSort" type="button">🧭 排序模式：关</button>
      </div>
      <div id="addLogBox" class="hide" style="margin-top:10px">
        <textarea id="addLogText" class="bigtext" placeholder="粘贴训练总结，第一行将作为标题"></textarea>
        <div class="row auto">
          <button class="btn ok" id="addLogSave" type="button">保存到日志</button>
          <button class="btn light" id="addLogCancel" type="button">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置页 -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle">外观 / 标识</div>
      <div class="row auto">
        <div class="field"><label>自定义标题</label><input id="titleInput" type="text" placeholder="如：JasperGYM"></div>
        <div class="field"><label>版本号</label><input id="verInput" type="text" placeholder="如：v3.31"></div>
        <div class="field"><label>背景颜色</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <button class="btn ok" id="saveBrand" type="button">保存外观</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle" id="vmTitle">（选择部位）视频 & 注意事项</div>
      <div class="row auto">
        <div class="field"><label>部位</label><select id="vmPart"></select></div>
        <div class="field"><label>名称</label><input id="vmName" type="text" placeholder="如：深蹲动作讲解"></div>
        <div class="field"><label>链接</label><input id="vmUrl" type="text" placeholder="https://…（YouTube/MP4/链接）"></div>
        <button class="btn ok" id="vmAdd" type="button">添加/更新</button>
      </div>
      <div class="row auto" style="margin-top:10px">
        <div class="field" style="grid-column:1/-1">
          <label>该部位「训练注意事项」</label>
          <textarea id="vmNotes" placeholder="要点/发力/常见错误… 一行一条亦可"></textarea>
        </div>
        <button class="btn ok" id="saveNotes" type="button">保存注意事项</button>
      </div>
      <div id="vmList" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">数据管理</div>
      <div class="row auto">
        <button class="btn ok" id="exportAll" type="button">📤 导出全部数据</button>
        <input type="file" id="importFile" class="hide" accept=".json"/>
        <button class="btn warn" id="importAll" type="button">📥 导入数据（覆盖本地）</button>
        <button class="btn danger" id="wipeAll" type="button">🗑 清空全部数据（不可恢复）</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">计时设置（倒计时）</div>
      <div class="row auto">
        <div class="field"><label>时间间隔（秒）</label>
          <input id="intervalInput" type="number" min="10" max="999" step="1" value="60"/>
        </div>
        <div class="field"><label>提示音长度（秒）</label>
          <input id="beepLen" type="number" min="1" max="10" step="1" value="2"/>
        </div>
        <button class="btn ok" id="saveTimerPref" type="button">保存计时设置</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">背景音乐（BGM）</div>
      <div class="row auto">
        <div class="field"><label>音乐 URL</label><input id="bgmUrl" type="text" placeholder="https://… 或本地文件会自动生成 blob URL"></div>
        <div class="field"><label>音量（0~1）</label><input id="bgmVol" type="number" step="0.05" min="0" max="1" value="0.4"></div>
        <div class="field"><label>自动播放</label>
          <select id="bgmAuto"><option value="0">关闭</option><option value="1">在训练页自动播放</option></select>
        </div>
        <input id="bgmFile" type="file" accept="audio/*">
        <button class="btn ok" id="saveBgm" type="button">保存背景音乐设置</button>
        <button class="btn light" id="testBgm" type="button">试听/暂停</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<!-- 音频：提示音+背景音乐 -->
<audio id="beepAudio" src="bell.mp3" preload="auto"></audio>
<audio id="bgmAudio" preload="auto" loop></audio>

<script>
// ===== 小工具 =====
const $=id=>document.getElementById(id);
const show=id=>$(id).classList.remove('hide');
const hide=id=>$(id).classList.add('hide');
function toast(msg){const t=$('toast');t.textContent=msg;t.classList.remove('hide');t.style.opacity=1;setTimeout(()=>t.style.opacity=0,1600);setTimeout(()=>t.classList.add('hide'),1900);}

// ===== 存储键 =====
const K={ brand:'gym_brand', prefs:'gym_prefs', videos:'gym_videos', logs:'gym_logs', notes:'gym_notes' };

// ===== 存取 =====
function load(key,def){try{const t=localStorage.getItem(key);return t?JSON.parse(t):def}catch(e){return def}}
function save(key,val){localStorage.setItem(key,JSON.stringify(val))}

// ===== 全局状态 =====
let brand=load(K.brand,{title:'训练提醒 · 全量版',ver:'v3.31',bg:'#91C6FF'});
let prefs=load(K.prefs,{interval:60,beepLen:2,part:'legs',customParts:[],bgm:{url:'',vol:0.4,auto:false}});
let videos=load(K.videos,{legs:[],chest:[],back:[],arms:[],shoulders:[],core:[]});
let notes=load(K.notes,{
  legs:"膝盖与脚尖同向；下蹲保持背部中立；全程控制，不要弹震。",
  chest:"肩胛后收下沉；肘部略内收。",
  back:"核心收紧，避免耸肩借力。",
  arms:"肘部固定，离心缓慢。",
  shoulders:"避免耸肩，注意肩袖热身。",
  core:"收腹提肛，呼吸配合。"
});
let logs=load(K.logs,[]);
let sortMode=false;

// ===== 页面切换 =====
function setActive(page){
  ['home','work','logs','settings'].forEach(p=>$('page-'+p).classList.add('hide'));
  $('page-'+page).classList.remove('hide');
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.querySelector(`.tab[data-page="${page}"]`)?.classList.add('active');
  // BGM 随页面切换
  if(page==='work' && prefs.bgm.auto && prefs.bgm.url){ startBgm(); } else { stopBgm(); }
  if(page==='work') renderWork(true);
}
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>setActive(t.dataset.page));

// ===== 部位集合 =====
const baseParts=[
  {id:'legs',name:'腿部'},{id:'chest',name:'胸部'},{id:'back',name:'背部'},
  {id:'arms',name:'手臂'},{id:'shoulders',name:'肩部'},{id:'core',name:'核心'}
];
function getAllParts(){ const customs=(prefs.customParts||[]).map(n=>({id:'c_'+encodeURIComponent(n), name:n})); return [...baseParts, ...customs]; }
function idToName(id){ return (getAllParts().find(x=>x.id===id)||{name:'未命名'}).name; }
function ensureVideoBucket(id){ if(!videos[id]) videos[id]=[]; }

// ===== 首页 =====
function renderHomeChoices(){
  const box=$('homeChoices'); box.innerHTML='';
  baseParts.forEach(p=>{
    const div=document.createElement('div'); div.className='choice';
    div.innerHTML=`<input type="radio" name="part" ${prefs.part===p.id?'checked':''}/><span class="name">${p.name}</span>`;
    div.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs);};
    box.appendChild(div);
  });
  (prefs.customParts||[]).forEach(name=>{
    const id='c_'+encodeURIComponent(name);
    const div=document.createElement('div'); div.className='choice';
    div.innerHTML=`<input type="radio" name="part" ${prefs.part===id?'checked':''}/><span class="name">${name}</span>`;
    div.onclick=()=>{prefs.part=id; save(K.prefs,prefs);};
    box.appendChild(div);
  });
  // 永久“自定义”入口（只有文字“自定义”）
  const add=document.createElement('div'); add.className='choice';
  add.innerHTML=`<input type="radio" disabled/><span class="name">自定义</span>`;
  add.onclick=()=>{ $('btnManageCustom').click(); $('newCustomName').focus(); };
  box.appendChild(add);
}
$('btnStart').onclick=()=>setActive('work');
$('btnManageCustom').onclick=()=>$('customMgr').classList.toggle('hide');
$('addCustom').onclick=()=>{
  const name=$('newCustomName').value.trim();
  if(!name) return toast('请输入名称');
  if(prefs.customParts.includes(name)) return toast('已存在该名称');
  prefs.customParts.push(name); save(K.prefs,prefs);
  $('newCustomName').value='';
  const id='c_'+encodeURIComponent(name); ensureVideoBucket(id); if(!notes[id]) notes[id]=''; save(K.videos,videos); save(K.notes,notes);
  renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已添加');
};
function renderCustomList(){
  const box=$('customList'); box.innerHTML='';
  (prefs.customParts||[]).forEach((name,idx)=>{
    const id='c_'+encodeURIComponent(name);
    const tag=document.createElement('div'); tag.className='customTag';
    const nm=document.createElement('span'); nm.textContent=name;
    const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='重命名';
    const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='删除';
    edit.onclick=()=>{
      const nn=prompt('重命名为：', name); if(!nn || !nn.trim()) return;
      if(prefs.customParts.includes(nn.trim())) return toast('该名称已存在');
      const newId='c_'+encodeURIComponent(nn.trim());
      videos[newId]=videos[id]||[]; delete videos[id];
      notes[newId]=notes[id]||''; delete notes[id];
      prefs.customParts[idx]=nn.trim();
      if(prefs.part===id) prefs.part=newId;
      save(K.videos,videos); save(K.notes,notes); save(K.prefs,prefs);
      renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已重命名');
    };
    del.onclick=()=>{
      if(!confirm('删除该自定义部位？')) return;
      prefs.customParts.splice(idx,1); delete videos[id]; delete notes[id]; if(prefs.part===id) prefs.part='legs';
      save(K.videos,videos); save(K.notes,notes); save(K.prefs,prefs);
      renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已删除');
    };
    tag.appendChild(nm); tag.appendChild(edit); tag.appendChild(del); box.appendChild(tag);
  });
}

// ===== 训练：倒计时 & 视频 & 注意事项 =====
let timerId=null, remain=0;
function formatMMSS(s){const m=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return `${m}:${ss}`;}
function startCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); $('timer').textContent=formatMMSS(remain); tick(); timerId=setInterval(tick,1000);}
function tick(){ if(remain<=0){ stopCountdown(); beep(); return; } $('timer').textContent=formatMMSS(remain--); }
function stopCountdown(){ if(timerId){clearInterval(timerId);timerId=null;} }
function resetCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); $('timer').textContent=formatMMSS(remain); }
function beep(){ try{const a=$('beepAudio'); a.currentTime=0; a.play(); setTimeout(()=>a.pause(), (prefs.beepLen||2)*1000);}catch(e){} }
$('btnStartTimer').onclick=startCountdown; $('btnStopTimer').onclick=stopCountdown; $('btnResetTimer').onclick=resetCountdown;

function toYoutubeEmbed(u){
  try{const url=new URL(u);
    if(url.hostname.includes('youtube.com') && url.searchParams.get('v')) return `https://www.youtube.com/embed/${url.searchParams.get('v')}`;
    if(url.hostname.includes('youtu.be')){ const id=url.pathname.replace('/',''); return `https://www.youtube.com/embed/${id}`;}
  }catch(e){} return null;
}
function previewVideo(url){
  const iframe=$('videoIframe'), vid=$('videoHtml5'), fb=$('videoFallback');
  iframe.style.display=vid.style.display=fb.style.display='none';
  if(!url){ fb.textContent='暂无视频'; fb.style.display='block'; return; }
  const yt=toYoutubeEmbed(url);
  if(yt){ iframe.src=yt; iframe.style.display='block'; return; }
  if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(url)){ vid.src=url; vid.style.display='block'; return; }
  fb.textContent='此链接无法内嵌播放，请点击“打开视频”在新窗口播放。'; fb.style.display='block';
}
function refreshVideoSelectFor(partId){
  if(!videos[partId]) videos[partId]=[];
  const vs=$('videoSelect'); vs.innerHTML='';
  const arr=videos[partId];
  if(!arr.length){ const o=document.createElement('option'); o.value=''; o.textContent='无视频'; vs.appendChild(o); previewVideo(''); }
  else{ arr.forEach((it,idx)=>{ const o=document.createElement('option'); o.value=idx; o.textContent=it.name; vs.appendChild(o); }); vs.value=0; previewVideo(arr[0].url); }
  vs.onchange=()=>{ const i=vs.value; if(i===''||i==null){previewVideo('');return;} previewVideo(arr[i].url); };
  $('openVideo').onclick=()=>{ const i=vs.value; if(i===''||i==null){toast('该部位暂无视频');return;} window.open(arr[i].url,'_blank'); };
  $('partNotice').textContent = (notes[partId]||'暂无注意事项');
}
function renderWork(force=false){
  const sel=$('workPart'); sel.innerHTML='';
  getAllParts().forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o);});
  sel.value = prefs.part;
  sel.onchange=()=>{ prefs.part=sel.value; save(K.prefs,prefs); refreshVideoSelectFor(prefs.part); };
  refreshVideoSelectFor(prefs.part);
  resetCountdown();
}

// ===== 日志（同前版本，略） =====
function appendLogFromText(txt){ const first=(txt.split(/\r?\n/)[0]||'').trim()||'（无标题）'; logs.push({title:first,content:txt,ts:Date.now()}); save(K.logs,logs); }
$('toggleAddLog').onclick=()=>$('addLogBox').classList.toggle('hide');
$('addLogCancel').onclick=()=>hide('addLogBox');
$('addLogSave').onclick=()=>{ const txt=$('addLogText').value.trim(); if(!txt) return toast('请粘贴完整日志'); appendLogFromText(txt); $('addLogText').value=''; hide('addLogBox'); renderLogs(); toast('已添加到日志'); };
$('toggleSort').onclick=()=>{ sortMode=!sortMode; $('toggleSort').textContent=`🧭 排序模式：${sortMode?'开':'关'}`; renderLogs(); };
function bindLongPress(el,fn){ let t; el.addEventListener('touchstart',()=>{t=setTimeout(fn,500)},{passive:true}); ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>el.addEventListener(ev,()=>clearTimeout(t))); }
function enterContentEdit(itemDiv, contentDiv, i){
  if (itemDiv.dataset.editingContent==='1') return; itemDiv.dataset.editingContent='1';
  const ta=document.createElement('textarea'); ta.className='bigtext'; ta.value=logs[i].content||'';
  const wrap=document.createElement('div'); wrap.className='log-content';
  const saveBtn=document.createElement('button'); saveBtn.className='btn ok'; saveBtn.textContent='💾 保存内容';
  const cancelBtn=document.createElement('button'); cancelBtn.className='btn light'; cancelBtn.textContent='取消';
  wrap.appendChild(ta); wrap.appendChild(saveBtn); wrap.appendChild(cancelBtn);
  contentDiv.replaceWith(wrap);
  saveBtn.onclick=()=>{ logs[i]={...logs[i], content:ta.value}; save(K.logs,logs); itemDiv.dataset.editingContent=''; renderLogs(); toast('内容已更新'); };
  cancelBtn.onclick=()=>{ wrap.replaceWith(contentDiv); itemDiv.dataset.editingContent=''; };
}
function enterFullEdit(itemDiv, titleEl, contentDiv, i){
  if (itemDiv.dataset.editingFull==='1') return; itemDiv.dataset.editingFull='1';
  const titleBox=document.createElement('input'); titleBox.className='title-input'; titleBox.value=logs[i].title||'（无标题）';
  const ta=document.createElement('textarea'); ta.className='bigtext'; ta.value=logs[i].content||'';
  const editor=document.createElement('div'); editor.className='log-content';
  const saveBtn=document.createElement('button'); saveBtn.className='btn ok'; saveBtn.textContent='💾 保存';
  const cancelBtn=document.createElement('button'); cancelBtn.className='btn light'; cancelBtn.textContent='取消';
  editor.appendChild(titleBox); editor.appendChild(ta); editor.appendChild(saveBtn); editor.appendChild(cancelBtn);
  contentDiv.classList.remove('hide'); contentDiv.replaceWith(editor);
  saveBtn.onclick=()=>{ logs[i]={...logs[i], title:titleBox.value.trim()||'（无标题）', content:ta.value}; save(K.logs,logs); itemDiv.dataset.editingFull=''; renderLogs(); toast('已更新'); };
  cancelBtn.onclick=()=>{ editor.replaceWith(contentDiv); itemDiv.dataset.editingFull=''; };
}
function createContentDiv(text){ const d=document.createElement('div'); d.className='log-content'; d.textContent=text||'（无内容）'; return d; }
function renderLogs(){
  const box=$('logList'); box.innerHTML='';
  if(!logs.length){box.innerHTML='<div class="tiny muted">暂无日志。</div>';return;}
  logs.forEach((log,i)=>{
    const item=document.createElement('div'); item.className='log-item';
    const title=document.createElement('div'); title.className='log-title'; title.textContent=log.title||'（无标题）';
    const content=createContentDiv(log.content); content.classList.add('hide');
    title.onclick=(e)=>{ e.stopPropagation(); content.classList.toggle('hide'); };
    item.appendChild(title); item.appendChild(content);
    if(sortMode){
      const tools=document.createElement('div'); tools.className='log-tools';
      tools.innerHTML=`<button class="btn xs light">⬆️ 上移</button><button class="btn xs light">⬇️ 下移</button><button class="btn xs light">✏️ 编辑</button><button class="btn xs danger">🗑 删除</button>`;
      const [upBtn,downBtn,editBtn,delBtn]=tools.querySelectorAll('button');
      editBtn.onclick=(e)=>{ e.stopPropagation(); enterFullEdit(item, title, content, i); };
      upBtn.onclick=(e)=>{ e.stopPropagation(); if(i>0){[logs[i-1],logs[i]]=[logs[i],logs[i-1]]; save(K.logs,logs); renderLogs();} };
      downBtn.onclick=(e)=>{ e.stopPropagation(); if(i<logs.length-1){[logs[i+1],logs[i]]=[logs[i],logs[i+1]]; save(K.logs,logs); renderLogs();} };
      delBtn.onclick=(e)=>{ e.stopPropagation(); logs.splice(i,1); save(K.logs,logs); renderLogs(); toast('已删除'); };
      item.appendChild(tools);
    }else{
      content.ondblclick=(e)=>{ e.stopPropagation(); enterContentEdit(item, content, i); };
      bindLongPress(item,()=>{ logs.splice(i,1); save(K.logs,logs); renderLogs(); toast('已删除'); });
    }
    box.appendChild(item);
  });
}

// ===== 设置：视频管理 / 数据 / 计时 / BGM =====
function renderVmPartOptions(){
  const sel=$('vmPart'); sel.innerHTML='';
  getAllParts().forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o);});
  if(!getAllParts().some(p=>p.id===sel.value)) sel.value = prefs.part||'legs';
  $('vmTitle').textContent = `${idToName(sel.value)} 视频 & 注意事项`;
  $('vmNotes').value = notes[sel.value]||'';
  renderVmList();
}
$('vmPart').onchange=()=>{ $('vmTitle').textContent = `${idToName($('vmPart').value)} 视频 & 注意事项`; $('vmNotes').value=notes[$('vmPart').value]||''; renderVmList(); };
$('saveNotes').onclick=()=>{ const id=$('vmPart').value; notes[id]=$('vmNotes').value||''; save(K.notes,notes); if(prefs.part===id) $('partNotice').textContent=notes[id]||''; toast('注意事项已保存'); };
$('vmAdd').onclick=()=>{
  const part=$('vmPart').value; const name=$('vmName').value.trim(); const url=$('vmUrl').value.trim();
  if(!name||!url) return toast('名称和链接都要填');
  ensureVideoBucket(part); const arr=videos[part]; const idx=arr.findIndex(x=>x.name===name); const item={name,url};
  if(idx>=0) arr[idx]=item; else arr.push(item);
  save(K.videos,videos); $('vmName').value=''; $('vmUrl').value=''; renderVmList(); toast('已保存');
};
function renderVmList(){
  const part=$('vmPart').value; ensureVideoBucket(part);
  const box=$('vmList'); box.innerHTML='';
  const arr=videos[part];
  if(!arr.length){ box.innerHTML='<div class="tiny muted">该部位暂无视频。</div>'; return; }
  arr.forEach((it,idx)=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.style.borderBottom='1px solid var(--border)';
    const left=document.createElement('div'); left.textContent=it.name; left.title=it.url;
    const right=document.createElement('div');
    const editBtn=document.createElement('button'); editBtn.className='btn xs light'; editBtn.textContent='✏️ 编辑';
    const delBtn=document.createElement('button'); delBtn.className='btn xs danger'; delBtn.textContent='🗑 删除';
    right.appendChild(editBtn); right.appendChild(delBtn);
    row.appendChild(left); row.appendChild(right);
    editBtn.onclick=()=>{ const newTitle=prompt('修改标题',it.name); if(newTitle===null) return; const newUrl=prompt('修改链接',it.url); if(newUrl===null) return; videos[part][idx]={name:newTitle,url:newUrl}; save(K.videos,videos); renderVmList(); toast('已更新'); };
    delBtn.onclick=()=>{ arr.splice(idx,1); save(K.videos,videos); renderVmList(); toast('已删除'); };
    row.onclick=()=>{ prefs.part=part; save(K.prefs,prefs); setActive('work'); };
    box.appendChild(row);
  });
}

// 数据管理/计时
$('exportAll').onclick=()=>{ const payload={brand,prefs,videos,logs,notes}; const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(payload,null,2)); a.download='jaspergym-data.json'; a.click(); };
$('importAll').onclick=()=>$('importFile').click();
$('importFile').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.brand)brand=o.brand; if(o.prefs)prefs=o.prefs; if(o.videos)videos=o.videos; if(o.logs)logs=o.logs; if(o.notes)notes=o.notes; save(K.brand,brand); save(K.prefs,prefs); save(K.videos,videos); save(K.logs,logs); save(K.notes,notes); $('appTitle').textContent=`${brand.title} ${brand.ver}`; document.documentElement.style.setProperty('--bg', brand.bg); renderHomeChoices(); renderCustomList(); renderWork(true); renderVmPartOptions(); renderLogs(); toast('导入完成'); }catch(err){ toast('导入失败：JSON 有误'); } }; r.readAsText(f,'utf-8'); };
$('wipeAll').onclick=()=>{ Object.values(K).forEach(k=>localStorage.removeItem(k)); toast('已清空数据，刷新中…'); setTimeout(()=>location.reload(),300); };
$('saveTimerPref').onclick=()=>{ prefs.interval=parseInt($('intervalInput').value||60,10); prefs.beepLen=parseInt($('beepLen').value||2,10); save(K.prefs,prefs); resetCountdown(); toast('计时设置已保存'); };

// 背景音乐
const bgm=$('bgmAudio');
function applyBgm(){ bgm.src=prefs.bgm.url||''; bgm.volume=prefs.bgm.vol||0.4; }
function startBgm(){ applyBgm(); if(bgm.src) bgm.play().catch(()=>{}); }
function stopBgm(){ try{ bgm.pause(); }catch(e){} }
$('bgmFile').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); $('bgmUrl').value=url; };
$('saveBgm').onclick=()=>{ prefs.bgm.url=$('bgmUrl').value.trim(); prefs.bgm.vol=parseFloat($('bgmVol').value||0.4); prefs.bgm.auto=$('bgmAuto').value==='1'; save(K.prefs,prefs); applyBgm(); toast('背景音乐已保存'); };
$('testBgm').onclick=()=>{ if(bgm.paused){ startBgm(); }else{ stopBgm(); } };

// ===== 启动 =====
(function init(){
  $('appTitle').textContent=`${brand.title} ${brand.ver}`;
  document.documentElement.style.setProperty('--bg', brand.bg);
  $('bgmUrl').value=prefs.bgm.url||''; $('bgmVol').value=prefs.bgm.vol||0.4; $('bgmAuto').value=prefs.bgm.auto?'1':'0';
  renderHomeChoices(); renderCustomList(); renderWork(true); renderVmPartOptions(); renderLogs();
  // 兜底：若早期错误导致按钮未绑定
  $('btnStart').onclick=()=>setActive('work');
})();
</script>
</body>
</html>
